<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="GÃ¶revlerini RPG gibi oyna: XP kazan, seviye atla, iradenizi inÅŸa et.">
    <meta name="keywords" content="productivity, habit tracker, pomodoro, gamification, RPG, task management">
    <title>Iradah - Build Your Will</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Mobile PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Iradah">
    <meta name="theme-color" content="#2563eb">
    <meta name="msapplication-TileColor" content="#2563eb">

    <!-- Icons -->
    <link rel="apple-touch-icon" href="assets/logo.ico">
    <link rel="icon" type="image/x-icon" href="assets/logo.ico">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"
        crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a', // slate-900
                            card: '#1e293b', // slate-800
                            border: '#334155', // slate-700
                            text: '#f1f5f9', // slate-100
                            subtext: '#94a3b8' // slate-400
                        }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior-y: none;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        .dark .loader {
            border-color: #334155;
            border-top-color: #60a5fa;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(74, 222, 128, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
            }
        }

        .saving-pulse {
            animation: pulse-green 2s infinite;
        }

        .fire-anim {
            animation: burn 0.5s ease-in-out infinite alternate;
            transform-origin: center bottom;
        }

        @keyframes burn {
            from {
                transform: scale(1);
            }

            to {
                transform: scale(1.1);
                filter: brightness(1.2);
            }
        }

        .snap-x-mandatory {
            scroll-snap-type: x mandatory;
        }

        .snap-center {
            scroll-snap-align: center;
        }

        [dir="rtl"] .fire-anim {
            transform-origin: center bottom;
        }

        .letter-path {
            fill: transparent;
            stroke: #2563eb;
            stroke-width: 1.5px;
            stroke-dasharray: 400;
            stroke-dashoffset: 400;
            stroke-linecap: round;
            stroke-linejoin: round;
            font-family: 'Amiri', 'Times New Roman', serif;
            font-weight: bold;
            font-size: 50px;
            opacity: 0;
            /* Initially hidden */
        }

        .dark .letter-path {
            stroke: #60a5fa;
        }

        /* LETTER ANIMATIONS */
        @keyframes writeStroke {
            0% {
                stroke-dashoffset: 400;
                opacity: 1;
            }

            100% {
                stroke-dashoffset: 0;
                opacity: 1;
            }
        }

        @keyframes fillLetter {
            0% {
                fill: transparent;
            }

            100% {
                fill: currentColor;
            }
        }

        /* Sequential Delays (RTL: 1 is Rightmost) */
        .l-1 {
            animation: writeStroke 0.6s cubic-bezier(0.65, 0, 0.35, 1) forwards 0.0s, fillLetter 0.5s ease-out forwards 0.5s;
        }

        .l-2 {
            animation: writeStroke 0.6s cubic-bezier(0.65, 0, 0.35, 1) forwards 0.4s, fillLetter 0.5s ease-out forwards 0.9s;
        }

        .l-3 {
            animation: writeStroke 0.5s cubic-bezier(0.65, 0, 0.35, 1) forwards 0.8s, fillLetter 0.5s ease-out forwards 1.2s;
        }

        .l-4 {
            animation: writeStroke 0.6s cubic-bezier(0.65, 0, 0.35, 1) forwards 1.2s, fillLetter 0.5s ease-out forwards 1.6s;
        }

        .l-5 {
            animation: writeStroke 0.6s cubic-bezier(0.65, 0, 0.35, 1) forwards 1.6s, fillLetter 0.5s ease-out forwards 2.0s;
        }

        /* Loop wrapper if needed, but CSS animation loop on delay is tricky. 
           For infinite loop, we might need a keyframe that resets. 
           Better: simple one-off write on load, or specific infinite keyframe sequence.
           User asked for "loading spinner" so it implies loop. 
           Let's make a combined keyframe for infinite loop. */

        @keyframes strokeLoop {
            0% {
                stroke-dashoffset: 400;
                opacity: 0;
                fill: transparent;
            }

            10% {
                opacity: 1;
            }

            40% {
                stroke-dashoffset: 0;
                fill: transparent;
            }

            60% {
                stroke-dashoffset: 0;
                fill: currentColor;
            }

            /* Stay filled */
            90% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }

            /* Fade out to restart */
        }

        .loop-anim {
            animation-name: strokeLoop;
            animation-duration: 4s;
            animation-iteration-count: infinite;
            animation-fill-mode: both;
        }

        /* Delays for Loop */
        .d-1 {
            animation-delay: 0.0s;
        }

        .d-2 {
            animation-delay: 0.4s;
        }

        .d-3 {
            animation-delay: 0.8s;
        }

        .d-4 {
            animation-delay: 1.2s;
        }

        .d-5 {
            animation-delay: 1.6s;
        }

        @keyframes slide-down {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-slide-down {
            animation: slide-down 0.3s ease-out;
        }

        /* Safe area support for mobile devices */
        .pb-safe {
            padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
        }

        /* Custom responsive breakpoint for extra small screens */
        @media (max-width: 380px) {
            .xs\:hidden { display: none; }
            .xs\:text-\[9px\] { font-size: 9px; }
        }
        @media (min-width: 380px) {
            .xs\:inline { display: inline; }
        }

        /* Leaderboard animations */
        @keyframes crown-bounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(-3deg); }
            75% { transform: translateY(-5px) rotate(3deg); }
        }

        .animate-crown {
            animation: crown-bounce 2s ease-in-out infinite;
        }

        @keyframes podium-rise {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .animate-podium {
            animation: podium-rise 0.5s ease-out forwards;
        }

        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(168, 85, 247, 0.4); }
            50% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.8); }
        }

        .animate-glow {
            animation: glow-pulse 2s ease-in-out infinite;
        }

        @keyframes scale-up {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .animate-scale-up {
            animation: scale-up 0.3s ease-out forwards;
        }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-fade-in {
            animation: fade-in 0.2s ease-out forwards;
        }

        /* Smooth scrolling for all containers */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #94a3b8 transparent;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 2px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }
    </style>
</head>

<body
    class="bg-[#F4F5F7] text-slate-800 dark:bg-dark-bg dark:text-dark-text select-none transition-colors duration-300">

    <div id="root">
        <div
            style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #F4F5F7;">
            <svg width="250" height="120" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg"
                class="overflow-visible">
                <text x="50%" y="60%" text-anchor="middle" direction="rtl" class="base-text"
                    style="font-family: 'Times New Roman', serif; font-size: 50px; font-weight: bold;">
                    <tspan class="letter-path loop-anim d-1" style="stroke: #2563eb;">Ø¥Ù</tspan>
                    <tspan class="letter-path loop-anim d-2" style="stroke: #2563eb;">Ø±Ù</tspan>
                    <tspan class="letter-path loop-anim d-3" style="stroke: #2563eb;">Ø§</tspan>
                    <tspan class="letter-path loop-anim d-4" style="stroke: #2563eb;">Ø¯Ù</tspan>
                    <tspan class="letter-path loop-anim d-5" style="stroke: #2563eb;">Ø©</tspan>
                </text>
            </svg>
        </div>
    </div>

    <!-- Firebase ModÃ¼lleri -->
    <!-- Firebase Configuration - Loaded from external file (not tracked by git) -->
    <script src="config.js"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, updateDoc, deleteField, onSnapshot, getDoc, enableIndexedDbPersistence, collection, query, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        window.firebaseModules = {
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, getFirestore, doc, setDoc, updateDoc, deleteField, onSnapshot, getDoc, enableIndexedDbPersistence, collection, query, orderBy, limit, getDocs
        };
        window.firebaseModulesLoaded = true;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Component, createContext, useContext } = React;

        // --- FIREBASE CONFIG ---
        // Configuration is loaded from external config.js file (not tracked by git)
        // If config.js doesn't exist, app will show setup instructions
        // YapÄ±landÄ±rma harici config.js dosyasÄ±ndan yÃ¼klenir (git tarafÄ±ndan izlenmez)
        const FIREBASE_CONFIG = window.FIREBASE_CONFIG || null;

        // --- DÄ°L VE Ã‡EVÄ°RÄ°LER ---
        const TRANSLATIONS = {
            tr: {
                loading: "YÃ¼kleniyor...",
                welcome: "Iradah'a HoÅŸgeldin",
                slogan: "\"iradenizi inÅŸa edin\"",
                login_google: "Google ile GiriÅŸ Yap",
                board: "Pano",
                habits: "AlÄ±ÅŸkanlÄ±klar",
                tasks: "GÃ¶revler",
                chain: "Zincir",
                stats: "Ä°statistik",
                todo: "YapÄ±lacaklar",
                inProgress: "Devam Edenler",
                done: "Tamamlananlar",
                new_task: "Yeni GÃ¶rev",
                edit_task: "GÃ¶revi DÃ¼zenle",
                task_title: "GÃ¶rev BaÅŸlÄ±ÄŸÄ±",
                category: "Kategori",
                points_xp: "Puan (XP)",
                due_date: "Son Tarih",
                save: "Kaydet",
                create: "OluÅŸtur",
                add_card: "Kart Ekle",
                back: "Geri",
                next: "Ä°leri",
                new_habit: "Yeni AlÄ±ÅŸkanlÄ±k",
                habit_name: "AlÄ±ÅŸkanlÄ±k AdÄ±",
                add: "Ekle",
                daily: "GÃ¼nlÃ¼k",
                weekly: "HaftalÄ±k",
                monthly: "AylÄ±k",
                status: "Durum",
                complete_period: "Bu DÃ¶nem Tamamla",
                completed: "TamamlandÄ±",
                future: "Gelecek",
                streak_day: "GÃ¼n Seri!",
                max: "Max",
                chain_break: "Zinciri KÄ±rma",
                target_placeholder: "Hedefin ne? (Buraya yaz)",
                level: "Seviye",
                record: "Rekor",
                saving: "Kaydediliyor",
                synced: "Senkronize",
                days: "GÃ¼n",
                weeks: "Hafta",
                months: "Ay",
                years: "YÄ±l",
                all_time: "TÃ¼m Zamanlar",
                analysis: "Puan Analizi",
                weekly_gain: "HaftalÄ±k XP KazanÄ±mÄ±",
                cat_activity: "Kategori BazlÄ± Aktivite",
                total_items: "Toplam Ä°ÅŸlem",
                total_points: "Toplam Puan",
                current_level: "Mevcut Seviye",
                next_level_xp: "XP kaldÄ±",
                delete_confirm: "Silinecek?",
                archive: "ArÅŸiv",
                archived: "ArÅŸivlendi",
                archive_task: "ArÅŸivle",
                archive_all: "TÃ¼mÃ¼nÃ¼ ArÅŸivle",
                archive_all_confirm: "Tamamlanan tÃ¼m gÃ¶revler arÅŸivlensin mi?",
                clear_archive: "ArÅŸivi Temizle",
                clear_archive_confirm: "TÃ¼m arÅŸiv silinsin mi? Bu iÅŸlem geri alÄ±namaz.",
                restore: "Geri YÃ¼kle",
                no_archived_tasks: "ArÅŸivde gÃ¶rev yok",
                archived_on: "ArÅŸivlenme",
                theme_light: "AydÄ±nlÄ±k",
                theme_dark: "KaranlÄ±k",
                settings: "Ayarlar",
                logout: "Ã‡Ä±kÄ±ÅŸ",
                week: "Hafta",
                selected_period: "SeÃ§ili DÃ¶nem PuanÄ±",
                avg_per_day: "GÃ¼nlÃ¼k Ort.",
                connection_error: "BaÄŸlantÄ± HatasÄ±: ModÃ¼ller yÃ¼klenemedi.",
                config_error: "LÃ¼tfen kod iÃ§erisindeki FIREBASE_CONFIG alanÄ±nÄ± kendi bilgilerinizle doldurun.",
                pomodoro: "Pomodoro",
                start: "BaÅŸla",
                pause: "Durdur",
                reset: "SÄ±fÄ±rla",
                work: "Ã‡alÄ±ÅŸma",
                break: "Mola",
                session_points: "Seans PuanÄ±",
                focus_time: "Odaklanma SÃ¼resi",
                total_hours: "Toplam Saat",
                alarm_sound: "Alarm Sesi",
                sound_classic: "Klasik Zil",
                sound_digital: "Dijital",
                sound_bird: "KuÅŸ CÄ±vÄ±ltÄ±sÄ±",
                session_complete: "Oturum TamamlandÄ±!",
                take_break: "Mola vakti! GÃ¼zel Ã§alÄ±ÅŸtÄ±n.",
                back_to_work: "Mola bitti, iÅŸe dÃ¶nme zamanÄ±!",
                enable_notifications: "Bildirimleri AÃ§",
                focus_time: "Odaklanma SÃ¼resi",
                total_hours: "Toplam Saat",
                footer_security: "Verileriniz gÃ¼vende ve sadece sizin eriÅŸiminize aÃ§Ä±k.",
                settings: "Ayarlar",
                save: "Kaydet",
                weekly: "HaftalÄ±k",
                monthly: "AylÄ±k",
                yearly: "YÄ±llÄ±k",
                pomodoro_stats: "Pomodoro Ä°statistiÄŸi",
                total_sessions: "Toplam Oturum",
                habit_success: "AlÄ±ÅŸkanlÄ±k BaÅŸarÄ±sÄ±",
                task_efficiency: "GÃ¶rev VerimliliÄŸi",
                current_streak: "Mevcut Seri",
                best_streak: "En Uzun Seri",
                motivation_1: "Harika bir baÅŸlangÄ±Ã§!",
                motivation_2: "Ä°stikrarÄ±n gÃ¼cÃ¼ adÄ±na!",
                motivation_3: "Efsanevi bir hafta!",
                motivation_4: "DurdurulamazsÄ±n!",
                today_status: "BugÃ¼nkÃ¼ Durum",
                chain_status: "Zincir Durumu",
                hours_short: "Sa",
                min: "dk",
                avg_session: "Ort. Oturum",
                passed_days: "GeÃ§en",
                marked_days: "Ä°ÅŸaretli",
                offline_warning: "Ä°nternet baÄŸlantÄ±sÄ± yok",
                offline_message: "LÃ¼tfen devam etmek iÃ§in bir aÄŸa baÄŸlanÄ±n",
                reconnecting: "BaÄŸlanÄ±yor...",
                today: "BugÃ¼n",
                custom_day: "Ã–zel GÃ¼n",
                custom_week: "Ã–zel Hafta",
                custom_month: "Ã–zel Ay",
                custom_year: "Ã–zel YÄ±l",
                custom_range: "Tarih AralÄ±ÄŸÄ±",
                select_date: "Tarih SeÃ§",
                start_date: "BaÅŸlangÄ±Ã§",
                end_date: "BitiÅŸ",
                year_total_days: "Bu YÄ±l GeÃ§en GÃ¼n",
                year_marked_days: "Bu YÄ±l Ä°ÅŸaretli",
                all_tasks: "TÃ¼m GÃ¶revler",
                completed_tasks: "Tamamlanan",
                combo: "Combo",
                current_combo: "Mevcut Combo",
                max_combo: "Max Combo",
                // Category names
                cat_general: "Genel",
                cat_work: "Ä°ÅŸ",
                cat_personal: "KiÅŸisel",
                cat_health: "SaÄŸlÄ±k",
                cat_education: "EÄŸitim",
                cat_education: "EÄŸitim",
                cat_other: "DiÄŸer",
                excuse_history: "Bahane GeÃ§miÅŸi",
                add_excuse: "Bahane Ekle",
                edit_excuse: "Bahane DÃ¼zenle",
                excuse_reason: "Neden yapamadÄ±n?",
                excuse_placeholder: "Bahanenizi buraya yazÄ±n...",
                all_excuses_desc: "TÃ¼m bahaneleriniz burada",
                no_excuses_title: "Bahane yok!",
                no_excuses_desc: "Tebrikler, hiÃ§ bahane Ã¼retmemiÅŸsin!",
                total: "Toplam",
                no_data: "Veri yok",
                daily_habits: "GÃ¼nlÃ¼k AlÄ±ÅŸkanlÄ±klar",
                weekly_habits: "HaftalÄ±k AlÄ±ÅŸkanlÄ±klar",
                monthly_habits: "AylÄ±k AlÄ±ÅŸkanlÄ±klar",
                all_habits: "TÃ¼m AlÄ±ÅŸkanlÄ±klar",
                overall_success: "Toplam BaÅŸarÄ±",
                go_to_today: "BugÃ¼ne DÃ¶n",
                go_to_current: "Mevcut DÃ¶neme DÃ¶n",
                lifetime_success: "TÃ¼m Zamanlar BaÅŸarÄ±sÄ±",
                habit_based: "AlÄ±ÅŸkanlÄ±k BazlÄ±",
                today_tasks: "BugÃ¼n",
                this_week_tasks: "Bu Hafta",
                this_week: "Bu Hafta",
                this_month_tasks: "Bu Ay",
                this_month: "Bu Ay",
                this_year: "Bu YÄ±l",
                score_breakdown: "DÃ¶nemsel puan daÄŸÄ±lÄ±mÄ±",
                days_active: "Aktif GÃ¼n",
                all_tasks_period: "TÃ¼m Zamanlar",
                completed_today: "BugÃ¼n Tamamlanan",
                on_time: "ZamanÄ±nda",
                overdue_tasks: "Geciken",
                task_streak: "GÃ¶rev Serisi",
                best_category: "En Verimli Kategori",
                avg_completion: "Ort. Tamamlama",
                trend_up: "YÃ¼kseliÅŸ",
                trend_down: "DÃ¼ÅŸÃ¼ÅŸ",
                trend_stable: "Stabil",
                vs_last_period: "Ã–nceki dÃ¶neme gÃ¶re",
                category_stats: "Kategori Ä°statistikleri",
                total_tasks_cat: "Toplam GÃ¶rev",
                efficiency: "Verimlilik",
                in_progress_short: "Devam",
                most_productive: "En Verimli",
                least_productive: "En Az Verimli",
                category_breakdown: "Kategori DaÄŸÄ±lÄ±mÄ±",
                avg_per_category: "Ort. GÃ¶rev/Kategori",
                active_categories: "Aktif Kategori",
                top_categories: "En Aktif Kategoriler",
                by_completion: "Tamamlanma oranÄ±na gÃ¶re",
                quick_stats: "HÄ±zlÄ± Ã–zet",
                needs_work: "GeliÅŸtirilmeli",
                category_overview: "Kategori Genel BakÄ±ÅŸ",
                category_heatmap: "Kategori IsÄ± HaritasÄ±",
                last_28_days: "Son 28 GÃ¼n",
                total_activity: "Toplam Aktivite",
                active_days: "Aktif GÃ¼n",
                coverage: "Kapsam",
                best_day: "En Ä°yi GÃ¼n",
                current_streak_heat: "Mevcut Seri",
                max_streak_heat: "En Uzun Seri",
                no_activity: "Aktivite yok",
                activity_level: "Aktivite Seviyesi",
                xp_log: "XP GeÃ§miÅŸi",
                xp_log_title: "XP KazanÄ±m GeÃ§miÅŸi",
                source_task: "GÃ¶rev",
                source_habit: "AlÄ±ÅŸkanlÄ±k",
                source_chain: "Zincir",
                source_pomodoro: "Pomodoro",
                source_all: "TÃ¼m Kaynaklar",
                all: "TÃ¼mÃ¼",
                filter_source: "Kaynak",
                filter_category: "Kategori",
                filter_date: "Tarih",
                date_range: "Tarih AralÄ±ÄŸÄ±",
                start_date: "BaÅŸlangÄ±Ã§",
                end_date: "BitiÅŸ",
                clear_filters: "Filtreleri Temizle",
                total_xp_filtered: "Toplam XP (FiltrelenmiÅŸ)",
                no_xp_records: "XP kaydÄ± bulunamadÄ±",
                xp_earned: "XP kazandÄ±n",
                task_completed: "GÃ¶rev tamamlandÄ±",
                habit_completed: "AlÄ±ÅŸkanlÄ±k tamamlandÄ±",
                chain_marked: "Zincir iÅŸaretlendi",
                pomo_session: "Pomodoro oturumu tamamlandÄ±",
                xp_source_task_desc: "gÃ¶revini tamamlayarak",
                xp_source_habit_desc: "alÄ±ÅŸkanlÄ±ÄŸÄ±nÄ± yerine getirerek",
                xp_source_chain_desc: "zinciri iÅŸaretleyerek",
                xp_source_pomo_desc: "dakika odaklanarak",
                filters: "Filtreler",
                entries: "kayÄ±t",
                lvl_1_msg: "Yolculuk baÅŸlÄ±yor! ğŸ’ª",
                lvl_5_msg: "Harika gidiyorsun! ğŸ”¥",
                lvl_10_msg: "Ä°rade ustasÄ± oluyorsun! â­",
                lvl_max_msg: "Efsanevi Seviye! ğŸ†",
                level_info: "Seviye Bilgisi",
                current_level: "Mevcut",
                leaderboard: "SÄ±ralama",
                leave_leaderboard: "SÄ±ralamadan AyrÄ±l",
                cancel: "Ä°ptal",
                join_leaderboard: "SÄ±ralamaya KatÄ±l",
                join_desc: "DiÄŸerleriyle yarÄ±ÅŸmak iÃ§in bir takma ad belirle.",
                nickname: "Takma Ad",
                avatar: "Avatar",
                rank: "SÄ±ra",
                points: "Puan",
                score: "Skor",
                save_profile: "Profili Kaydet",
                daily_leaderboard: "GÃ¼nlÃ¼k Liderler",
                weekly_leaderboard: "HaftalÄ±k Liderler",
                monthly_leaderboard: "AylÄ±k Liderler",
                yearly_leaderboard: "YÄ±llÄ±k Liderler",
                all_time_leaderboard: "TÃ¼m Zamanlar",
                max_combo_leaderboard: "Max Combo SÄ±ralamasÄ±",
                update_profile: "Profili GÃ¼ncelle",
                joined_leaderboard: "SÄ±ralamaya katÄ±ldÄ±n!",
                // update_profile: "Profili GÃ¼ncelle", // Duplicate, removed
                you: "Sen",
                top_50: "Ä°lk 50",
                no_leaderboard_data: "HenÃ¼z veri yok.",
                category_leaderboard: "Kategori Liderleri"
            },
            en: {
                loading: "Loading...",
                welcome: "Welcome to Iradah",
                slogan: "\"build your will\"",
                login_google: "Sign in with Google",
                board: "Board",
                habits: "Habits",
                tasks: "Tasks",
                chain: "Chain",
                stats: "Stats",
                todo: "To Do",
                inProgress: "In Progress",
                done: "Done",
                new_task: "New Task",
                edit_task: "Edit Task",
                task_title: "Task Title",
                category: "Category",
                points_xp: "Points (XP)",
                due_date: "Due Date",
                save: "Save",
                create: "Create",
                add_card: "Add Card",
                back: "Back",
                next: "Next",
                new_habit: "New Habit",
                habit_name: "Habit Name",
                add: "Add",
                daily: "Daily",
                weekly: "Weekly",
                monthly: "Monthly",
                status: "Status",
                complete_period: "Complete Period",
                completed: "Completed",
                future: "Future",
                streak_day: "Day Streak!",
                max: "Max",
                chain_break: "Don't Break the Chain",
                target_placeholder: "What is your goal?",
                level: "Level",
                record: "Record",
                saving: "Saving",
                synced: "Synced",
                days: "Day",
                weeks: "Week",
                months: "Month",
                years: "Year",
                all_time: "All Time",
                analysis: "Score Analysis",
                weekly_gain: "Weekly XP Gain",
                cat_activity: "Category Activity",
                total_items: "Total Items",
                total_points: "Total Points",
                current_level: "Current Level",
                next_level_xp: "XP left",
                delete_confirm: "Delete?",
                archive: "Archive",
                archived: "Archived",
                archive_task: "Archive",
                archive_all: "Archive All",
                archive_all_confirm: "Archive all completed tasks?",
                clear_archive: "Clear Archive",
                clear_archive_confirm: "Delete all archived tasks? This cannot be undone.",
                restore: "Restore",
                no_archived_tasks: "No archived tasks",
                archived_on: "Archived on",
                theme_light: "Light",
                theme_dark: "Dark",
                settings: "Settings",
                logout: "Logout",
                week: "Week",
                selected_period: "Selected Period Score",
                avg_per_day: "Daily Avg.",
                connection_error: "Connection Error: Modules not loaded.",
                config_error: "Please fill in the FIREBASE_CONFIG area in the code with your own information.",
                pomodoro: "Pomodoro",
                start: "Start",
                pause: "Pause",
                reset: "Reset",
                work: "Work",
                break: "Break",
                session_points: "Session Points",
                focus_time: "Focus Time",
                total_hours: "Total Hours",
                footer_security: "Your data is safe and accessible only to you.",
                // settings: "Settings", // Duplicate, removed
                // save: "Save", // Duplicate, removed
                weekly: "Weekly",
                monthly: "Monthly",
                yearly: "Yearly",
                pomodoro_stats: "Pomodoro Stats",
                total_sessions: "Total Sessions",
                habit_success: "Habit Success",
                task_efficiency: "Task Efficiency",
                current_streak: "Current Streak",
                best_streak: "Best Streak",
                motivation_1: "Great start!",
                motivation_2: "Power of consistency!",
                motivation_3: "Legendary week!",
                motivation_4: "Unstoppable!",
                today_status: "Today's Status",
                chain_status: "Chain Status",
                hours_short: "h",
                min: "min",
                avg_session: "Avg. Session",
                passed_days: "Passed",
                marked_days: "Marked",
                offline_warning: "No internet connection",
                offline_message: "Please connect to a network to continue",
                reconnecting: "Reconnecting...",
                combo: "Combo",
                current_combo: "Current Combo",
                max_combo: "Max Combo",
                // Category names
                cat_general: "General",
                cat_work: "Work",
                cat_personal: "Personal",
                cat_health: "Health",
                cat_education: "Education",
                // cat_health: "Health", // Duplicate, removed
                // cat_education: "Education", // Duplicate, removed
                cat_other: "Other",
                excuse_history: "Excuse History",
                add_excuse: "Add Excuse",
                edit_excuse: "Edit Excuse",
                excuse_reason: "Why couldn't you do it?",
                excuse_placeholder: "Write your excuse here...",
                all_excuses_desc: "All your excuses are here",
                no_excuses_title: "No excuses!",
                no_excuses_desc: "Congratulations, you haven't made any excuses!",
                total: "Total",
                no_data: "No data",
                daily_habits: "Daily Habits",
                weekly_habits: "Weekly Habits",
                monthly_habits: "Monthly Habits",
                all_habits: "All Habits",
                overall_success: "Overall Success",
                go_to_today: "Go to Today",
                go_to_current: "Go to Current",
                lifetime_success: "Lifetime Success",
                habit_based: "Habit Based",
                today_tasks: "Today",
                this_week_tasks: "This Week",
                this_week: "This Week",
                this_month_tasks: "This Month",
                this_month: "This Month",
                this_year: "This Year",
                score_breakdown: "Score breakdown by period",
                days_active: "Active Days",
                all_tasks_period: "All Time",
                completed_today: "Completed Today",
                on_time: "On Time",
                overdue_tasks: "Overdue",
                task_streak: "Task Streak",
                best_category: "Best Category",
                avg_completion: "Avg. Completion",
                trend_up: "Up",
                trend_down: "Down",
                trend_stable: "Stable",
                vs_last_period: "vs last period",
                category_stats: "Category Statistics",
                total_tasks_cat: "Total Tasks",
                efficiency: "Efficiency",
                in_progress_short: "Progress",
                most_productive: "Most Productive",
                least_productive: "Least Productive",
                category_breakdown: "Category Breakdown",
                avg_per_category: "Avg. Tasks/Category",
                active_categories: "Active Categories",
                top_categories: "Top Categories",
                by_completion: "By completion rate",
                quick_stats: "Quick Stats",
                needs_work: "Needs Work",
                category_overview: "Category Overview",
                category_heatmap: "Category Heat Map",
                last_28_days: "Last 28 Days",
                total_activity: "Total Activity",
                active_days: "Active Days",
                coverage: "Coverage",
                best_day: "Best Day",
                current_streak_heat: "Current Streak",
                max_streak_heat: "Best Streak",
                no_activity: "No activity",
                activity_level: "Activity Level",
                xp_log: "XP History",
                xp_log_title: "XP Earning History",
                source_task: "Task",
                source_habit: "Habit",
                source_chain: "Chain",
                source_pomodoro: "Pomodoro",
                source_all: "All Sources",
                all: "All",
                filter_source: "Source",
                filter_category: "Category",
                filter_date: "Date",
                date_range: "Date Range",
                // start_date: "Start", // Duplicate, removed
                // end_date: "End", // Duplicate, removed
                clear_filters: "Clear Filters",
                total_xp_filtered: "Total XP (Filtered)",
                no_xp_records: "No XP records found",
                xp_earned: "XP earned",
                task_completed: "Task completed",
                habit_completed: "Habit completed",
                chain_marked: "Chain marked",
                pomo_session: "Pomodoro session completed",
                xp_source_task_desc: "by completing task",
                xp_source_habit_desc: "by fulfilling habit",
                xp_source_chain_desc: "by marking the chain",
                xp_source_pomo_desc: "minutes of focus",
                filters: "Filters",
                entries: "entries",
                lvl_1_msg: "Journey begins! ğŸ’ª",
                lvl_5_msg: "You're doing great! ğŸ”¥",
                lvl_10_msg: "Becoming a willpower master! â­",
                lvl_max_msg: "Legendary Status! ğŸ†",
                level_info: "Level Info",
                current_level: "Current",
                leaderboard: "Leaderboard",
                leave_leaderboard: "Leave Leaderboard",
                cancel: "Cancel",
                join_leaderboard: "Join Leaderboard",
                update_profile: "Update Profile",
                join_desc: "Set a nickname to compete with others.",
                nickname: "Nickname",
                avatar: "Avatar",
                rank: "Rank",
                points: "Points",
                score: "Score",
                save_profile: "Save Profile",
                daily_leaderboard: "Daily Leaders",
                weekly_leaderboard: "Weekly Leaders",
                monthly_leaderboard: "Monthly Leaders",
                yearly_leaderboard: "Yearly Leaders",
                all_time_leaderboard: "All Time Leaders",
                max_combo_leaderboard: "Max Combo Rank",
                joined_leaderboard: "You joined the leaderboard!",
                update_profile: "Update Profile",
                you: "You",
                top_50: "Top 50",
                no_leaderboard_data: "No data yet.",
                category_leaderboard: "Category Leaders"
            },
            ar: {
                loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
                welcome: "Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙÙŠ Ø¥Ø±Ø§Ø¯Ø©",
                slogan: "\"Ø§Ø¨Ù†ÙŠ Ø¥Ø±Ø§Ø¯ØªÙƒ\"",
                login_google: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„",
                board: "Ø§Ù„Ù„ÙˆØ­Ø©",
                habits: "Ø§Ù„Ø¹Ø§Ø¯Ø§Øª",
                tasks: "Ø§Ù„Ù…Ù‡Ø§Ù…",
                chain: "Ø§Ù„Ø³Ù„Ø³Ù„Ø©",
                stats: "Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª",
                todo: "Ù„Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡",
                inProgress: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°",
                done: "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡",
                new_task: "Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©",
                edit_task: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©",
                task_title: "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©",
                category: "Ø§Ù„ÙØ¦Ø©",
                points_xp: "Ù†Ù‚Ø§Ø· (XP)",
                due_date: "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚",
                save: "Ø­ÙØ¸",
                create: "Ø¥Ù†Ø´Ø§Ø¡",
                add_card: "Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø©",
                back: "Ø±Ø¬ÙˆØ¹",
                next: "Ø§Ù„ØªØ§Ù„ÙŠ",
                new_habit: "Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©",
                habit_name: "Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¯Ø©",
                add: "Ø¥Ø¶Ø§ÙØ©",
                daily: "ÙŠÙˆÙ…ÙŠ",
                weekly: "Ø£Ø³Ø¨ÙˆØ¹ÙŠ",
                monthly: "Ø´Ù‡Ø±ÙŠ",
                status: "Ø§Ù„Ø­Ø§Ù„Ø©",
                complete_period: "Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ÙØªØ±Ø©",
                completed: "Ù…ÙƒØªÙ…Ù„",
                future: "Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„",
                streak_day: "ÙŠÙˆÙ… Ù…ØªØªØ§Ù„ÙŠ!",
                max: "Ø§Ù„Ø£Ø¹Ù„Ù‰",
                chain_break: "Ù„Ø§ ØªÙƒØ³Ø± Ø§Ù„Ø³Ù„Ø³Ù„Ø©",
                target_placeholder: "Ù…Ø§ Ù‡Ùˆ Ù‡Ø¯ÙÙƒØŸ",
                level: "Ù…Ø³ØªÙˆÙ‰",
                record: "Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ",
                saving: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸",
                synced: "Ù…ØªØ²Ø§Ù…Ù†",
                days: "ÙŠÙˆÙ…",
                weeks: "Ø£Ø³Ø¨ÙˆØ¹",
                months: "Ø´Ù‡Ø±",
                years: "Ø³Ù†Ø©",
                all_time: "ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª",
                analysis: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø·",
                weekly_gain: "ÙƒØ³Ø¨ XP Ø£Ø³Ø¨ÙˆØ¹ÙŠ",
                cat_activity: "Ù†Ø´Ø§Ø· Ø§Ù„ÙØ¦Ø©",
                total_items: "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±",
                total_points: "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·",
                current_level: "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ",
                next_level_xp: "XP Ù…ØªØ¨Ù‚ÙŠ",
                delete_confirm: "Ø­Ø°ÙØŸ",
                archive: "Ø§Ù„Ø£Ø±Ø´ÙŠÙ",
                archived: "Ù…Ø¤Ø±Ø´Ù",
                archive_task: "Ø£Ø±Ø´ÙØ©",
                archive_all: "Ø£Ø±Ø´ÙØ© Ø§Ù„ÙƒÙ„",
                archive_all_confirm: "Ø£Ø±Ø´ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©ØŸ",
                clear_archive: "Ù…Ø³Ø­ Ø§Ù„Ø£Ø±Ø´ÙŠÙ",
                clear_archive_confirm: "Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§.",
                restore: "Ø§Ø³ØªØ¹Ø§Ø¯Ø©",
                no_archived_tasks: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø¤Ø±Ø´ÙØ©",
                archived_on: "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©",
                theme_light: "ÙØ§ØªØ­",
                theme_dark: "Ø¯Ø§ÙƒÙ†",
                settings: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
                logout: "Ø®Ø±ÙˆØ¬",
                week: "Ø£Ø³Ø¨ÙˆØ¹",
                selected_period: "Ù†Ù‚Ø§Ø· Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©",
                avg_per_day: "Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ",
                connection_error: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª.",
                config_error: "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ù…Ù†Ø·Ù‚Ø© FIREBASE_CONFIG ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ.",
                pomodoro: "Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ",
                start: "Ø§Ø¨Ø¯Ø£",
                pause: "Ø¥ÙŠÙ‚Ø§Ù",
                reset: "Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·",
                work: "Ø¹Ù…Ù„",
                break: "Ø§Ø³ØªØ±Ø§Ø­Ø©",
                session_points: "Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬Ù„Ø³Ø©",
                focus_time: "ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²",
                total_hours: "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¹Ø§Øª",
                footer_security: "Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¢Ù…Ù†Ø© ÙˆÙ…ØªØ§Ø­Ø© Ù„Ùƒ ÙÙ‚Ø·.",
                settings: "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
                save: "Ø­ÙØ¸",
                weekly: "Ø£Ø³Ø¨ÙˆØ¹ÙŠ",
                monthly: "Ø´Ù‡Ø±ÙŠ",
                yearly: "Ø³Ù†ÙˆÙŠ",
                pomodoro_stats: "Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ",
                total_sessions: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø§Øª",
                habit_success: "Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ø§Ø¯Ø©",
                task_efficiency: "ÙƒÙØ§Ø¡Ø© Ø§Ù„Ù…Ù‡Ù…Ø©",
                current_streak: "Ø§Ù„Ø®Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ",
                best_streak: "Ø£ÙØ¶Ù„ Ø®Ø·",
                motivation_1: "Ø¨Ø¯Ø§ÙŠØ© Ø±Ø§Ø¦Ø¹Ø©!",
                motivation_2: "Ù‚ÙˆØ© Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±!",
                motivation_3: "Ø£Ø³Ø¨ÙˆØ¹ Ø£Ø³Ø·ÙˆØ±ÙŠ!",
                motivation_4: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ÙŠÙ‚Ø§ÙÙƒ!",
                today_status: "Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…",
                chain_status: "Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ù„Ø³Ù„Ø©",
                hours_short: "Ø³",
                min: "Ø¯",
                avg_session: "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¬Ù„Ø³Ø©",
                passed_days: "Ù…Ø¶Ù‰",
                marked_days: "Ù…Ø­Ø¯Ø¯",
                offline_warning: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª",
                offline_message: "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø¨ÙƒØ© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©",
                reconnecting: "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...",
                combo: "ÙƒÙˆÙ…Ø¨Ùˆ",
                current_combo: "Ø§Ù„ÙƒÙˆÙ…Ø¨Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠ",
                max_combo: "Ø£ÙØ¶Ù„ ÙƒÙˆÙ…Ø¨Ùˆ",
                // Category names
                cat_general: "Ø¹Ø§Ù…",
                cat_work: "Ø¹Ù…Ù„",
                cat_personal: "Ø´Ø®ØµÙŠ",
                cat_health: "ØµØ­Ø©",
                cat_education: "ØªØ¹Ù„ÙŠÙ…",
                cat_health: "ØµØ­Ø©",
                cat_education: "ØªØ¹Ù„ÙŠÙ…",
                cat_other: "Ø¢Ø®Ø±",
                excuse_history: "Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¹Ø°Ø§Ø±",
                add_excuse: "Ø£Ø¶Ù Ø¹Ø°Ø±",
                edit_excuse: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø°Ø±",
                excuse_reason: "Ù„Ù…Ø§Ø°Ø§ Ù„Ù… ØªØ³ØªØ·Ø¹ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ø°Ù„ÙƒØŸ",
                excuse_placeholder: "Ø£ÙƒØªØ¨ Ø¹Ø°Ø±Ùƒ Ù‡Ù†Ø§...",
                all_excuses_desc: "Ø¬Ù…ÙŠØ¹ Ø£Ø¹Ø°Ø§Ø±Ùƒ Ù‡Ù†Ø§",
                no_excuses_title: "Ù„Ø§ Ø£Ø¹Ø°Ø§Ø±!",
                no_excuses_desc: "ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ØŒ Ù„Ù… ØªÙ‚Ø¯Ù… Ø£ÙŠ Ø£Ø¹Ø°Ø§Ø±!",
                total: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",
                no_data: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª",
                daily_habits: "Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©",
                weekly_habits: "Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©",
                monthly_habits: "Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©",
                all_habits: "ÙƒÙ„ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª",
                overall_success: "Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„ÙƒÙ„ÙŠ",
                go_to_today: "Ø§Ø°Ù‡Ø¨ Ù„Ù„ÙŠÙˆÙ…",
                go_to_current: "Ø§Ø°Ù‡Ø¨ Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
                lifetime_success: "Ù†Ø¬Ø§Ø­ ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª",
                habit_based: "Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø§Ø¯Ø©",
                today_tasks: "Ø§Ù„ÙŠÙˆÙ…",
                this_week_tasks: "Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹",
                this_week: "Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹",
                this_month_tasks: "Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±",
                this_month: "Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±",
                this_year: "Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©",
                score_breakdown: "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©",
                days_active: "Ø£ÙŠØ§Ù… Ù†Ø´Ø·Ø©",
                all_tasks_period: "ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª",
                completed_today: "Ù…ÙƒØªÙ…Ù„ Ø§Ù„ÙŠÙˆÙ…",
                on_time: "ÙÙŠ Ø§Ù„ÙˆÙ‚Øª",
                overdue_tasks: "Ù…ØªØ£Ø®Ø±",
                task_streak: "Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ø§Ù…",
                best_category: "Ø£ÙØ¶Ù„ ÙØ¦Ø©",
                avg_completion: "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²",
                trend_up: "ØµØ¹ÙˆØ¯",
                trend_down: "Ù‡Ø¨ÙˆØ·",
                trend_stable: "Ø«Ø§Ø¨Øª",
                vs_last_period: "Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©",
                category_stats: "Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ¦Ø©",
                total_tasks_cat: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…",
                efficiency: "Ø§Ù„ÙƒÙØ§Ø¡Ø©",
                in_progress_short: "Ø¬Ø§Ø±ÙŠ",
                most_productive: "Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ù†ØªØ§Ø¬ÙŠØ©",
                least_productive: "Ø§Ù„Ø£Ù‚Ù„ Ø¥Ù†ØªØ§Ø¬ÙŠØ©",
                category_breakdown: "ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª",
                avg_per_category: "Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ù‡Ø§Ù…/Ø§Ù„ÙØ¦Ø©",
                active_categories: "Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©",
                top_categories: "Ø£ÙØ¶Ù„ Ø§Ù„ÙØ¦Ø§Øª",
                by_completion: "Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²",
                quick_stats: "Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹",
                needs_work: "ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†",
                category_overview: "Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙØ¦Ø§Øª",
                category_heatmap: "Ø®Ø±ÙŠØ·Ø© Ø­Ø±Ø§Ø±ÙŠØ© Ù„Ù„ÙØ¦Ø§Øª",
                last_28_days: "Ø¢Ø®Ø± 28 ÙŠÙˆÙ…Ù‹Ø§",
                total_activity: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø´Ø§Ø·",
                active_days: "Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù†Ø´Ø·Ø©",
                coverage: "Ø§Ù„ØªØºØ·ÙŠØ©",
                best_day: "Ø£ÙØ¶Ù„ ÙŠÙˆÙ…",
                current_streak_heat: "Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
                max_streak_heat: "Ø£ÙØ¶Ù„ Ø³Ù„Ø³Ù„Ø©",
                no_activity: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·",
                activity_level: "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ø´Ø§Ø·",
                xp_log: "Ø³Ø¬Ù„ XP",
                xp_log_title: "Ø³Ø¬Ù„ ÙƒØ³Ø¨ XP",
                source_task: "Ù…Ù‡Ù…Ø©",
                source_habit: "Ø¹Ø§Ø¯Ø©",
                source_chain: "Ø³Ù„Ø³Ù„Ø©",
                source_pomodoro: "Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ",
                source_all: "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±",
                all: "Ø§Ù„ÙƒÙ„",
                filter_source: "Ø§Ù„Ù…ØµØ¯Ø±",
                filter_category: "Ø§Ù„ÙØ¦Ø©",
                filter_date: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
                date_range: "Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®",
                start_date: "Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©",
                end_date: "Ø§Ù„Ù†Ù‡Ø§ÙŠØ©",
                clear_filters: "Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±",
                total_xp_filtered: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ XP (Ù…ÙÙ„ØªØ±)",
                no_xp_records: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª XP",
                xp_earned: "XP Ù…ÙƒØªØ³Ø¨",
                task_completed: "Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ù‡Ù…Ø©",
                habit_completed: "Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ø¹Ø§Ø¯Ø©",
                chain_marked: "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ù„Ø³Ù„Ø©",
                pomo_session: "Ø§ÙƒØªÙ…Ù„Øª Ø¬Ù„Ø³Ø© Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ",
                xp_source_task_desc: "Ø¨Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©",
                xp_source_habit_desc: "Ø¨ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ø§Ø¯Ø©",
                xp_source_chain_desc: "Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ù„Ø³Ù„Ø©",
                xp_source_pomo_desc: "Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† Ø§Ù„ØªØ±ÙƒÙŠØ²",
                filters: "Ø§Ù„ÙÙ„Ø§ØªØ±",
                entries: "Ø³Ø¬Ù„Ø§Øª",
                lvl_1_msg: "ØªØ¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©! ğŸ’ª",
                lvl_5_msg: "Ø£Ù†Øª ØªØ¨Ù„ÙŠ Ø¨Ù„Ø§Ø¡Ù‹ Ø­Ø³Ù†Ø§Ù‹! ğŸ”¥",
                lvl_10_msg: "Ø£ØµØ¨Ø­Øª Ø³ÙŠØ¯ Ø§Ù„Ø¥Ø±Ø§Ø¯Ø©! â­",
                lvl_max_msg: "Ù…Ø³ØªÙˆÙ‰ Ø£Ø³Ø·ÙˆØ±ÙŠ! ğŸ†",
                level_info: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰",
                current_level: "Ø§Ù„Ø­Ø§Ù„ÙŠ",
                leaderboard: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†",
                leave_leaderboard: "Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†",
                cancel: "Ø¥Ù„ØºØ§Ø¡",
                confirm_leave: "SÄ±ralamadan ayrÄ±lmak istediÄŸine emin misin? Verilerin silinmeyecek ama listeden Ã§Ä±kacaksÄ±n.",
                join_leaderboard: "Ø§Ù†Ø¶Ù… Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†",
                update_profile: "tahdith almalaff",
                join_desc: "Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ù…Ø³ØªØ¹Ø§Ø±Ø§Ù‹ Ù„Ù„Ù…Ù†Ø§ÙØ³Ø©.",
                nickname: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±",
                avatar: "Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø²ÙŠØ©",
                rank: "Ø§Ù„Ù…Ø±ØªØ¨Ø©",
                points: "Ø§Ù„Ù†Ù‚Ø§Ø·",
                score: "Ø§Ù„Ù†ØªÙŠØ¬Ø©",
                save_profile: "Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",
                daily_leaderboard: "Ù…ØªØµØ¯Ø±Ùˆ Ø§Ù„ÙŠÙˆÙ…",
                weekly_leaderboard: "Ù…ØªØµØ¯Ø±Ùˆ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹",
                monthly_leaderboard: "Ù…ØªØµØ¯Ø±Ùˆ Ø§Ù„Ø´Ù‡Ø±",
                yearly_leaderboard: "Ù…ØªØµØ¯Ø±Ùˆ Ø§Ù„Ø³Ù†Ø©",
                all_time_leaderboard: "ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª",
                max_combo_leaderboard: "ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙˆÙ…Ø¨Ùˆ",
                joined_leaderboard: "Ù„Ù‚Ø¯ Ø§Ù†Ø¶Ù…Ù…Øª Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†!",
                update_profile: "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",
                you: "Ø£Ù†Øª",
                top_50: "Ø£ÙØ¶Ù„ 50",
                no_leaderboard_data: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.",
                category_leaderboard: "Ù…ØªØµØ¯Ø±Ùˆ Ø§Ù„ÙØ¦Ø§Øª",
                warrior: "SavaÅŸÃ§Ä±",
                skip: "Åimdilik GeÃ§",
                join_arena: "Arenaya KatÄ±l",
                join_arena_desc: "DiÄŸerleriyle yarÄ±ÅŸmak iÃ§in sÄ±ralamaya gir.",
                generated_user: "Ä°simsiz SavaÅŸÃ§Ä±",
                join_benefit: "SÄ±ralamada yerini al ve rozetler kazan!",
            }
        };

        // --- HATA KALKANI ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="h-screen flex flex-col items-center justify-center p-6 text-center bg-red-50 text-red-800 dark:bg-red-900/20 dark:text-red-300">
                            <h2 className="text-2xl font-bold mb-2">Hata / Error / Ø®Ø·Ø£</h2>
                            <pre className="text-xs bg-white dark:bg-slate-800 p-4 rounded border border-red-200 dark:border-red-800 mb-4 overflow-auto max-w-full">{this.state.error?.toString()}</pre>
                            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="bg-red-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-700">Reset / SÄ±fÄ±rla</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- AUDIO SYSTEM ---
        const ALARM_SOUNDS = {
            classic: "data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEAAFMtUy85M1VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV", // Classic Bell (placeholder for real base64)
            digital: "data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEAAFMtUy85M1VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV" // Digital Beep placeholder
        };

        const playAlarm = (type = 'classic') => {
            try {
                const audio = new Audio(ALARM_SOUNDS[type] || ALARM_SOUNDS.classic);
                audio.volume = 0.5;
                audio.play();
                // If notifications supported
                if ("Notification" in window && Notification.permission === "granted") {
                    new Notification("Iradah Pomodoro", { body: "SÃ¼re doldu!", icon: "assets/logo.ico" });
                }
            } catch (e) { console.error("Audio Play Error", e); }
        };


        const IradahSpinner = () => (
            <div className="flex flex-col items-center justify-center p-6">
                <svg width="220" height="110" viewBox="0 0 200 100" className="overflow-visible">
                    <text x="50%" y="60%" textAnchor="middle" direction="rtl" style={{ fontFamily: "'Times New Roman', serif", fontSize: '50px', fontWeight: 'bold' }}>
                        <tspan className="letter-path loop-anim d-1 text-blue-600 dark:text-blue-400">Ø¥Ù</tspan>
                        <tspan className="letter-path loop-anim d-2 text-blue-600 dark:text-blue-400">Ø±Ù</tspan>
                        <tspan className="letter-path loop-anim d-3 text-blue-600 dark:text-blue-400">Ø§</tspan>
                        <tspan className="letter-path loop-anim d-4 text-blue-600 dark:text-blue-400">Ø¯Ù</tspan>
                        <tspan className="letter-path loop-anim d-5 text-blue-600 dark:text-blue-400">Ø©</tspan>
                    </text>
                </svg>
            </div>
        );

        const ICONS = {
            Plus: <path d="M5 12h14M12 5v14" />,
            Info: <><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></>,
            Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></>,
            Calendar: <path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" />,
            Layout: <><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><path d="M3 9h18M9 21V9" /></>,
            CheckCircle2: <><path d="M12 22c5.523 0 10-5 10-10S17.523 2 12 2 2 7 2 12s4.477 10 10 10z" /><path d="m9 12 2 2 4-4" /></>,
            Trophy: <><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" /><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" /></>,
            Flame: <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" />,
            BarChart3: <><path d="M3 3v18h18" /><path d="M18 17V9" /><path d="M13 17V5" /><path d="M8 17v-3" /></>,
            PieChart: <><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10z" /></>,
            Trash2: <><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>,
            RotateCcw: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></>,
            Upload: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></>,
            Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></>,
            AlertTriangle: <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />,
            Link2: <><path d="M9 17H7A5 5 0 0 1 7 7h2" /><path d="M15 7h2a5 5 0 1 1 0 10h-2" /><line x1="8" x2="16" y1="12" y2="12" /></>,
            Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
            Medal: <><circle cx="12" cy="8" r="7" /><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" /></>,
            TrendingUp: <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />,
            ChevronLeft: <polyline points="15 18 9 12 15 6" />,
            ChevronRight: <polyline points="9 18 15 12 9 6" />,
            ChevronDown: <polyline points="6 9 12 15 18 9" />,
            X: <><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>,
            Star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />,
            History: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />,
            LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></>,
            Moon: <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />,
            Sun: <><circle cx="12" cy="12" r="5" /><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" /></>,
            Globe: <><circle cx="12" cy="12" r="10" /><line x1="2" y1="12" x2="22" y2="12" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z" /></>,
            Lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
            Timer: <><line x1="10" x2="14" y1="2" y2="2" /><line x1="12" x2="15" y1="14" y2="11" /><circle cx="12" cy="14" r="8" /></>,
            Play: <polygon points="5 3 19 12 5 21 5 3" />,
            Pause: <><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></>,
            Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.45a2 2 0 0 0 0 2l.08.18a2 2 0 0 1 0 2l-.25.43a2 2 0 0 1-1.73 1h-.18a2 2 0 0 0-2 2v.44a2 2 0 0 0 2 2h.18a2 2 0 0 1 1.73 1l.25.43a2 2 0 0 1 0 2l-.08.18a2 2 0 0 0 0 2l.45.45a2 2 0 0 0 2 0l.18-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.18.08a2 2 0 0 0 2 0l.45-.45a2 2 0 0 0 0-2l-.08-.18a2 2 0 0 1 0-2l.25-.43a2 2 0 0 1 1.73-1h.18a2 2 0 0 0 2-2v-.44a2 2 0 0 0-2-2h-.18a2 2 0 0 1-1.73-1l-.25-.43a2 2 0 0 1 0-2l.08-.18a2 2 0 0 0 0-2l-.45-.45a2 2 0 0 0-2 0l-.18.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />,
            BookOpen: <><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></>,
            Heart: <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />,
            Activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />,
            Briefcase: <><rect width="20" height="14" x="2" y="7" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></>,
            DollarSign: <><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></>,
            Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
            MessageCircle: <><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" /></>,
            Music: <><path d="M9 18V5l12-2v13" /><circle cx="6" cy="18" r="3" /><circle cx="18" cy="16" r="3" /></>,
            Palette: <><circle cx="13.5" cy="6.5" r=".5" /><circle cx="17.5" cy="10.5" r=".5" /><circle cx="8.5" cy="7.5" r=".5" /><circle cx="6.5" cy="12.5" r=".5" /><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z" /></>,
            FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><line x1="10" x2="8" y1="9" y2="9" /></>,
            ShoppingCart: <><circle cx="8" cy="21" r="1" /><circle cx="19" cy="21" r="1" /><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12" /></>,
            Sparkles: <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /><path d="M5 3v4M9 5H1" /></>,
            Utensils: <><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2" /><path d="M7 2v20" /><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" /></>,
            Brain: <><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z" /><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z" /></>,
            Kanban: <><path d="M3 3h5v18H3zM10 3h5v12h-5zM17 3h5v8h-5z" /></>,
            Repeat: <><path d="m17 2 4 4-4 4" /><path d="M3 11v-1a4 4 0 0 1 4-4h14" /><path d="m7 22-4-4 4-4" /><path d="M21 13v1a4 4 0 0 1-4 4H3" /></>,
            CheckSquare: <><polyline points="9 11 12 14 22 4" /><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" /></>,
            Archive: <><path d="M2 4h20v5H2zM4 9v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9" /><path d="M10 13h4" /></>,
            FolderOpen: <><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2" /></>,
            List: <><line x1="8" x2="21" y1="6" y2="6" /><line x1="8" x2="21" y1="12" y2="12" /><line x1="8" x2="21" y1="18" y2="18" /><line x1="3" x2="3.01" y1="6" y2="6" /><line x1="3" x2="3.01" y1="12" y2="12" /><line x1="3" x2="3.01" y1="18" y2="18" /></>,
            Edit2: <><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" /></>,
            Crown: <><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14" /></>,
            UserCircle: <><circle cx="12" cy="12" r="10" /><circle cx="12" cy="10" r="3" /><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662" /></>,
            Grid3X3: <><rect width="18" height="18" x="3" y="3" rx="2" /><path d="M3 9h18" /><path d="M3 15h18" /><path d="M9 3v18" /><path d="M15 3v18" /></>,
            RefreshCw: <><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M3 21v-5h5" /></>,
            Tag: <><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z" /><path d="M7 7h.01" /></>,
            Loader: <><line x1="12" x2="12" y1="2" y2="6" /><line x1="12" x2="12" y1="18" y2="22" /><line x1="4.93" x2="7.76" y1="4.93" y2="7.76" /><line x1="16.24" x2="19.07" y1="16.24" y2="19.07" /><line x1="2" x2="6" y1="12" y2="12" /><line x1="18" x2="22" y1="12" y2="12" /><line x1="4.93" x2="7.76" y1="19.07" y2="16.24" /><line x1="16.24" x2="19.07" y1="7.76" y2="4.93" /></>,
            Check: <polyline points="20 6 9 17 4 12" />
        };

        const Icon = ({ name, size = 20, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{ICONS[name] || null}</svg>
        );

        // Predefined Categories with Icons
        const PREDEFINED_CATEGORIES = [
            { id: 'general', name: 'Genel', nameEn: 'General', nameAr: 'Ø¹Ø§Ù…', icon: 'Layout', color: 'bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300' },
            { id: 'education', name: 'EÄŸitim', nameEn: 'Education', nameAr: 'ØªØ¹Ù„ÙŠÙ…', icon: 'BookOpen', color: 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400' },
            { id: 'religion', name: 'Din', nameEn: 'Religion', nameAr: 'Ø¯ÙŠÙ†', icon: 'Star', color: 'bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400' },
            { id: 'health', name: 'SaÄŸlÄ±k', nameEn: 'Health', nameAr: 'ØµØ­Ø©', icon: 'Heart', color: 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400' },
            { id: 'personal', name: 'KiÅŸisel GeliÅŸim', nameEn: 'Personal Development', nameAr: 'ØªØ·ÙˆÙŠØ± Ø´Ø®ØµÙŠ', icon: 'TrendingUp', color: 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400' },
            { id: 'sports', name: 'Spor', nameEn: 'Sports', nameAr: 'Ø±ÙŠØ§Ø¶Ø©', icon: 'Activity', color: 'bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400' },
            { id: 'work', name: 'Ä°ÅŸ', nameEn: 'Work', nameAr: 'Ø¹Ù…Ù„', icon: 'Briefcase', color: 'bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400' },
            { id: 'finance', name: 'Finans', nameEn: 'Finance', nameAr: 'Ù…Ø§Ù„ÙŠØ©', icon: 'DollarSign', color: 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400' },
            { id: 'family', name: 'Aile', nameEn: 'Family', nameAr: 'Ø¹Ø§Ø¦Ù„Ø©', icon: 'Users', color: 'bg-pink-100 dark:bg-pink-900/30 text-pink-600 dark:text-pink-400' },
            { id: 'social', name: 'Sosyal', nameEn: 'Social', nameAr: 'Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ', icon: 'MessageCircle', color: 'bg-cyan-100 dark:bg-cyan-900/30 text-cyan-600 dark:text-cyan-400' },
            { id: 'hobbies', name: 'Hobiler', nameEn: 'Hobbies', nameAr: 'Ù‡ÙˆØ§ÙŠØ§Øª', icon: 'Music', color: 'bg-violet-100 dark:bg-violet-900/30 text-violet-600 dark:text-violet-400' },
            { id: 'creativity', name: 'YaratÄ±cÄ±lÄ±k', nameEn: 'Creativity', nameAr: 'Ø¥Ø¨Ø¯Ø§Ø¹', icon: 'Palette', color: 'bg-fuchsia-100 dark:bg-fuchsia-900/30 text-fuchsia-600 dark:text-fuchsia-400' },
            { id: 'shopping', name: 'AlÄ±ÅŸveriÅŸ', nameEn: 'Shopping', nameAr: 'ØªØ³ÙˆÙ‘Ù‚', icon: 'ShoppingCart', color: 'bg-teal-100 dark:bg-teal-900/30 text-teal-600 dark:text-teal-400' },
            { id: 'cleaning', name: 'Temizlik', nameEn: 'Cleaning', nameAr: 'Ù†Ø¸Ø§ÙØ©', icon: 'Sparkles', color: 'bg-sky-100 dark:bg-sky-900/30 text-sky-600 dark:text-sky-400' },
            { id: 'nutrition', name: 'Beslenme', nameEn: 'Nutrition', nameAr: 'ØªØºØ°ÙŠØ©', icon: 'Utensils', color: 'bg-lime-100 dark:bg-lime-900/30 text-lime-600 dark:text-lime-400' },
            { id: 'mindfulness', name: 'FarkÄ±ndalÄ±k', nameEn: 'Mindfulness', nameAr: 'ÙŠÙ‚Ø¸Ø©', icon: 'Brain', color: 'bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400' }
        ];

        // Helper function to get category display name based on language
        const getCategoryName = (category, lang) => {
            const cat = PREDEFINED_CATEGORIES.find(c =>
                c.name.toLowerCase() === category.toLowerCase() ||
                c.nameEn.toLowerCase() === category.toLowerCase() ||
                c.nameAr === category ||
                c.id === category.toLowerCase()
            );
            if (!cat) return category;
            if (lang === 'en') return cat.nameEn;
            if (lang === 'ar') return cat.nameAr;
            return cat.name;
        };

        // Helper function to normalize category name to Turkish default
        const normalizeCategoryName = (category) => {
            if (!category) return 'Genel';
            const cat = PREDEFINED_CATEGORIES.find(c =>
                c.name.toLowerCase() === category.toLowerCase() ||
                c.nameEn.toLowerCase() === category.toLowerCase() ||
                c.nameAr === category ||
                c.id === category.toLowerCase()
            );
            return cat ? cat.name : 'Genel';
        };

        // Helper function to get category color
        const getCategoryColor = (category) => {
            const cat = PREDEFINED_CATEGORIES.find(c =>
                c.name.toLowerCase() === category.toLowerCase() ||
                c.nameEn.toLowerCase() === category.toLowerCase() ||
                c.nameAr === category ||
                c.id === category.toLowerCase()
            );
            return cat ? cat.color : 'bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300';
        };

        // Helper function to get category icon
        const getCategoryIcon = (category) => {
            const cat = PREDEFINED_CATEGORIES.find(c =>
                c.name.toLowerCase() === category.toLowerCase() ||
                c.nameEn.toLowerCase() === category.toLowerCase() ||
                c.nameAr === category ||
                c.id === category.toLowerCase()
            );
            return cat ? cat.icon : 'Layout';
        };

        const getHeatColor = (streak) => {
            if (!streak || streak === 0) return 'bg-gray-100 dark:bg-slate-700 text-gray-400 dark:text-slate-500 hover:bg-gray-200 dark:hover:bg-slate-600';
            if (streak >= 100) return 'bg-rose-600 text-white shadow-[0_0_10px_rgba(225,29,72,0.6)] border-none';
            if (streak >= 40) return 'bg-red-500 text-white border-none';
            if (streak >= 15) return 'bg-yellow-500 text-white border-none';
            return 'bg-green-500 text-white border-none';
        };

        const POINTS = { TASK_DONE: 15, HABIT_DAILY: 5, HABIT_WEEKLY: 30, HABIT_MONTHLY: 100, CHAIN_DAY_BASE: 10 };

        // Progressive Level Thresholds (Gap increases by 150 each level)
        const LEVEL_THRESHOLDS = [
            0,      // Lvl 1
            150,    // Lvl 2 (+150)
            450,    // Lvl 3 (+300)
            900,    // Lvl 4 (+450)
            1500,   // Lvl 5 (+600)
            2250,   // Lvl 6 (+750)
            3150,   // Lvl 7 (+900)
            4200,   // Lvl 8 (+1050)
            5400,   // Lvl 9 (+1200)
            6750,   // Lvl 10 (+1350)
            8250,   // Lvl 11 (+1500)
            9900,   // Lvl 12 (+1650)
            11700,  // Lvl 13 (+1800)
            13650,  // Lvl 14 (+1950)
            15750   // Lvl 15 (+2100) (Max)
        ];

        const LEVEL_MESSAGES = {
            1: { en: "Beginner's Spark", tr: "Acemi KÄ±vÄ±lcÄ±mÄ±", ar: "Ø´Ø±Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†" },
            2: { en: "Apprentice's Focus", tr: "Ã‡Ä±raÄŸÄ±n OdaklanmasÄ±", ar: "ØªØ±ÙƒÙŠØ² Ø§Ù„Ù…ØªØ¯Ø±Ø¨" },
            3: { en: "Dedicated Learner", tr: "AdanmÄ±ÅŸ Ã–ÄŸrenci", ar: "Ù…ØªØ¹Ù„Ù… Ù…Ø®Ù„Øµ" },
            4: { en: "Rising Willpower", tr: "YÃ¼kselen Ä°rade", ar: "Ø¥Ø±Ø§Ø¯Ø© ØµØ§Ø¹Ø¯Ø©" },
            5: { en: "Consistent Achiever", tr: "TutarlÄ± BaÅŸarÄ±", ar: "Ù…Ø­Ù‚Ù‚ Ø«Ø§Ø¨Øª" },
            6: { en: "Master of Habits", tr: "AlÄ±ÅŸkanlÄ±klarÄ±n UstasÄ±", ar: "Ø³ÙŠØ¯ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª" },
            7: { en: "Focused Practitioner", tr: "OdaklanmÄ±ÅŸ UygulayÄ±cÄ±", ar: "Ù…Ù…Ø§Ø±Ø³ Ù…Ø±ÙƒØ²" },
            8: { en: "Disciplined Mind", tr: "Disiplinli Zihin", ar: "Ø¹Ù‚Ù„ Ù…Ù†Ø¶Ø¨Ø·" },
            9: { en: "Resilient Spirit", tr: "DirenÃ§li Ruh", ar: "Ø±ÙˆØ­ Ù…Ø±Ù†Ø©" },
            10: { en: "Willpower Warrior", tr: "Ä°rade SavaÅŸÃ§Ä±sÄ±", ar: "Ù…Ø­Ø§Ø±Ø¨ Ø§Ù„Ø¥Ø±Ø§Ø¯Ø©" },
            11: { en: "Virtuous Leader", tr: "Erdemli Lider", ar: "Ù‚Ø§Ø¦Ø¯ ÙØ§Ø¶Ù„" },
            12: { en: "Exemplary Dedication", tr: "Ã–rnek AdanmÄ±ÅŸlÄ±k", ar: "ØªÙØ§Ù†ÙŠ Ù…Ø«Ø§Ù„ÙŠ" },
            13: { en: "Unwavering Resolve", tr: "SarsÄ±lmaz KararlÄ±lÄ±k", ar: "Ø¹Ø²ÙŠÙ…Ø© Ù„Ø§ ØªØªØ²Ø¹Ø²Ø¹" },
            14: { en: "Master of Self", tr: "Nefsin Efendisi", ar: "Ø³ÙŠØ¯ Ø§Ù„Ø°Ø§Øª" },
            15: { en: "Iradah Grandmaster", tr: "Ä°rade BÃ¼yÃ¼k UstasÄ±", ar: "Ø¥Ø±Ø§Ø¯Ø© Ø¬Ø±Ø§Ù†Ø¯ Ù…Ø§Ø³ØªØ±" }
        };

        // Dynamic chain points based on streak length
        const getChainPoints = (streakDay) => {
            if (streakDay >= 100) return 50;
            if (streakDay >= 61) return 40;
            if (streakDay >= 31) return 30;
            if (streakDay >= 15) return 20;
            if (streakDay >= 8) return 15;
            return POINTS.CHAIN_DAY_BASE; // 10 for days 1-7
        };

        // Calculate chain streak map from chainData
        const calculateChainStreakMap = (chainData) => {
            const map = {};
            const dates = Object.keys(chainData || {}).sort();
            if (dates.length === 0) return map;
            dates.forEach(dateStr => {
                const d = new Date(dateStr);
                const prevD = new Date(d);
                prevD.setDate(d.getDate() - 1);
                const prevKey = prevD.toISOString().split('T')[0];
                if (map[prevKey]) {
                    map[dateStr] = map[prevKey] + 1;
                } else {
                    map[dateStr] = 1;
                }
            });
            return map;
        };

        // Calculate total chain points using dynamic scoring
        const calculateTotalChainPoints = (chainData) => {
            const streakMap = calculateChainStreakMap(chainData);
            let total = 0;
            Object.values(streakMap).forEach(streakDay => {
                total += getChainPoints(streakDay);
            });
            return total;
        };

        // Helper function to get level title
        const getLevelTitle = (level) => {
            if (level >= 15) return "Master"; // Cap at 15 for title
            return `Level ${level}`; // Fallback
        };



        // --- COMPONENTS ---
        const WeeklyBarChart = ({ data }) => {
            const values = data.map(d => d.value);
            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const range = maxVal - minVal;
            const containerHeight = 100; // pixels for the bar area

            return (
                <div className="flex items-end justify-between w-full gap-2 mt-4" style={{ height: `${containerHeight + 24}px` }}>
                    {data.map((d, i) => {
                        let heightPx;
                        if (maxVal === 0) {
                            // All values are 0 - show tiny bars
                            heightPx = 4;
                        } else if (range === 0) {
                            // All values are the same (non-zero) - show medium bars
                            heightPx = containerHeight * 0.6;
                        } else {
                            // Scale from 8px minimum to containerHeight maximum
                            const minBarHeight = 8;
                            const normalized = (d.value - minVal) / range;
                            heightPx = minBarHeight + normalized * (containerHeight - minBarHeight);
                        }
                        return (
                            <div key={i} className="flex flex-col items-center flex-1 group relative" style={{ height: `${containerHeight + 24}px` }}>
                                <div className="absolute -top-6 bg-slate-800 dark:bg-slate-700 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity z-10 whitespace-nowrap">{d.value} XP</div>
                                <div className="flex-1 flex items-end w-full">
                                    <div
                                        className="w-full bg-blue-500 dark:bg-blue-600 rounded-t transition-all duration-500 group-hover:bg-blue-600 dark:group-hover:bg-blue-500"
                                        style={{ height: `${heightPx}px` }}
                                    ></div>
                                </div>
                                <span className="text-[9px] md:text-[10px] text-gray-400 dark:text-slate-500 mt-1 font-medium">{d.label}</span>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const SimplePieChart = ({ data }) => {
            const total = data.reduce((sum, d) => sum + d.value, 0);
            let currentAngle = 0;
            if (total === 0) return <div className="h-32 flex items-center justify-center text-gray-400 text-xs dark:text-slate-500">Veri yok</div>;
            return (
                <div className="flex items-center gap-4">
                    <div className="relative w-20 h-20 md:w-24 md:h-24 shrink-0">
                        <svg viewBox="-1 -1 2 2" style={{ transform: "rotate(-90deg)" }} className="overflow-visible">
                            {data.map((d, i) => {
                                const sliceAngle = (d.value / total) * 2 * Math.PI;
                                const x1 = Math.cos(currentAngle); const y1 = Math.sin(currentAngle);
                                const x2 = Math.cos(currentAngle + sliceAngle); const y2 = Math.sin(currentAngle + sliceAngle);
                                const largeArc = sliceAngle > Math.PI ? 1 : 0;
                                const pathData = `M 0 0 L ${x1} ${y1} A 1 1 0 ${largeArc} 1 ${x2} ${y2} Z`;
                                currentAngle += sliceAngle;
                                return <path key={i} d={pathData} fill={d.color} stroke="white" strokeWidth="0.05" className="dark:stroke-slate-800" />;
                            })}
                        </svg>
                    </div>
                    <div className="flex flex-col gap-1 text-[10px] md:text-xs">
                        {data.map((d, i) => <div key={i} className="flex items-center gap-2"><div className="w-2 h-2 rounded-full" style={{ backgroundColor: d.color }}></div><span className="text-gray-600 dark:text-slate-300 font-medium">{d.label}</span><span className="text-gray-400 dark:text-slate-500">({Math.round((d.value / total) * 100)}%)</span></div>)}
                    </div>
                </div>
            );
        };

        const SetupModal = ({ onSave, t }) => {
            const [configStr, setConfigStr] = useState('');
            const handleSave = () => {
                try {
                    let raw = configStr.trim();
                    const firstBrace = raw.indexOf('{');
                    const lastBrace = raw.lastIndexOf('}');
                    if (firstBrace === -1 || lastBrace === -1) throw new Error("SÃ¼slÃ¼ parantez { } bulunamadÄ±.");
                    let objStr = raw.substring(firstBrace, lastBrace + 1);
                    const parsed = new Function('return ' + objStr)();
                    if (!parsed.apiKey) throw new Error("GeÃ§ersiz yapÄ±: apiKey bulunamadÄ±.");
                    onSave(JSON.stringify(parsed));
                } catch (e) {
                    alert("Format hatasÄ±! " + e.message);
                }
            };
            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-dark-card p-8 rounded-2xl w-full max-w-lg shadow-2xl">
                        <h2 className="text-2xl font-bold text-slate-800 dark:text-white mb-4">{t('setup_title')}</h2>
                        <textarea value={configStr} onChange={e => setConfigStr(e.target.value)} placeholder='const firebaseConfig = { ... }' className="w-full h-32 p-3 bg-gray-50 dark:bg-slate-900 border dark:border-slate-700 rounded-lg text-xs font-mono mb-4 outline-none dark:text-white"></textarea>
                        <button onClick={handleSave} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">{t('connect')}</button>
                    </div>
                </div>
            );
        };

        const TaskModal = ({ isOpen, onClose, onSave, initialData, t, lang, columnId }) => {
            const [title, setTitle] = useState('');
            const [tag, setTag] = useState('Genel');
            const [date, setDate] = useState('');
            const [points, setPoints] = useState('15');
            useEffect(() => { if (initialData) { setTitle(initialData.title || ''); setTag(initialData.tag || 'Genel'); setDate(initialData.date || ''); setPoints(initialData.points?.toString() || '15'); } else { setTitle(''); setTag('Genel'); setDate(''); setPoints('15'); } }, [isOpen, initialData]);

            // Date validation: only 'done' column can have past dates
            const today = new Date().toISOString().split('T')[0];
            const minDate = (columnId === 'done') ? '' : today;

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white dark:bg-dark-card p-6 rounded-2xl w-[95%] max-w-sm shadow-xl relative animate-slide-up" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6 border-b dark:border-slate-700 pb-2"><h3 className="font-bold text-lg text-slate-800 dark:text-white">{initialData ? t('edit_task') : t('new_task')}</h3><button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-white"><Icon name="X" size={20} /></button></div>
                        <form onSubmit={e => { e.preventDefault(); const validPoints = Math.min(50, Math.max(5, parseInt(points) || 15)); onSave(title, normalizeCategoryName(tag), date, validPoints); onClose(); }} className="space-y-4">
                            <div><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 mb-1">{t('task_title')}</label><input required type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-2.5 bg-gray-50 dark:bg-slate-700 dark:text-white dark:border-slate-600 border rounded-lg outline-none text-sm" /></div>
                            <CategorySelector value={tag} onChange={setTag} lang={lang} t={t} />
                            <div><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 mb-1">{t('points_xp')} (5-50)</label><input type="number" min="5" max="50" value={points} onChange={e => setPoints(e.target.value)} className="w-full p-2.5 bg-gray-50 dark:bg-slate-700 dark:text-white dark:border-slate-600 border rounded-lg outline-none text-sm" /></div>
                            <div><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 mb-1">{t('due_date')}</label><input type="date" value={date} onChange={e => setDate(e.target.value)} min={minDate} className="w-full p-2.5 bg-gray-50 dark:bg-slate-700 dark:text-white dark:border-slate-600 border rounded-lg outline-none text-sm" /></div>
                            <button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg mt-2">{t('save')}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const HabitModal = ({ isOpen, onClose, onSave, frequency, initialData, t, lang }) => {
            if (!isOpen) return null;
            const [title, setTitle] = useState(''); const [category, setCategory] = useState('Genel');
            useEffect(() => { if (isOpen) { setTitle(initialData?.title || ''); setCategory(initialData?.category || 'Genel'); } }, [isOpen, initialData]);
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white dark:bg-dark-card p-6 rounded-2xl w-[95%] max-w-sm shadow-xl relative animate-slide-up" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6 border-b dark:border-slate-700 pb-2"><h3 className="font-bold text-lg text-slate-800 dark:text-white">{initialData ? t('edit_habit') : `${t('new_habit')} (${t(frequency)})`}</h3><button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-white"><Icon name="X" size={20} /></button></div>
                        <form onSubmit={e => { e.preventDefault(); onSave(title, normalizeCategoryName(category)); setTitle(''); setCategory('Genel'); onClose(); }} className="space-y-4">
                            <div><label className="block text-xs font-bold text-gray-500 dark:text-slate-400 mb-1">{t('habit_name')}</label><input required type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-2.5 bg-gray-50 dark:bg-slate-700 dark:text-white dark:border-slate-600 border rounded-lg outline-none text-sm" /></div>
                            <CategorySelector value={category} onChange={setCategory} lang={lang} t={t} />
                            <button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg mt-2">{initialData ? t('save') : t('add')}</button>
                        </form>
                    </div>
                </div>
            );
        };


        // Category Selector Component
        const CategorySelector = ({ value, onChange, lang, t }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [recentCategories, setRecentCategories] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('iradah_recent_categories') || '[]');
                } catch {
                    return [];
                }
            });

            const handleSelect = (category) => {
                onChange(category.name);
                // Update recent categories
                const updated = [category.id, ...recentCategories.filter(id => id !== category.id)].slice(0, 3);
                setRecentCategories(updated);
                localStorage.setItem('iradah_recent_categories', JSON.stringify(updated));
                setIsOpen(false);
            };

            // Sort categories: recent first, then alphabetical
            const sortedCategories = [...PREDEFINED_CATEGORIES].sort((a, b) => {
                const aIndex = recentCategories.indexOf(a.id);
                const bIndex = recentCategories.indexOf(b.id);
                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;
                return 0;
            });

            const selectedCategory = PREDEFINED_CATEGORIES.find(c =>
                c.name === value || c.nameEn === value || c.nameAr === value
            ) || PREDEFINED_CATEGORIES[0];

            return (
                <div className="relative">
                    <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 mb-1">{t('category')}</label>
                    <button
                        type="button"
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full p-2.5 bg-gray-50 dark:bg-slate-700 dark:text-white dark:border-slate-600 border rounded-lg outline-none text-sm flex items-center justify-between hover:bg-gray-100 dark:hover:bg-slate-600 transition-colors"
                    >
                        <div className="flex items-center gap-2">
                            <Icon name={selectedCategory.icon} size={16} />
                            <span>{getCategoryName(selectedCategory.name, lang)}</span>
                        </div>
                        <Icon name="ChevronDown" size={16} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                    </button>
                    {isOpen && (
                        <div className="absolute left-0 right-0 top-full mt-1 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto">
                            <div className="grid grid-cols-2 gap-1 p-2">
                                {sortedCategories.map(category => (
                                    <button
                                        key={category.id}
                                        type="button"
                                        onClick={() => handleSelect(category)}
                                        className={`flex items-center gap-2 p-2.5 rounded-lg text-left text-sm transition-all ${selectedCategory.id === category.id
                                            ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-bold'
                                            : 'hover:bg-gray-50 dark:hover:bg-slate-700 text-gray-700 dark:text-gray-200'
                                            } ${recentCategories.includes(category.id) ? 'ring-1 ring-blue-200 dark:ring-blue-800' : ''}`}
                                    >
                                        <Icon name={category.icon} size={16} />
                                        <span className="truncate">{getCategoryName(category.name, lang)}</span>
                                        {recentCategories.indexOf(category.id) === 0 && (
                                            <Icon name="Star" size={12} className="ml-auto shrink-0 text-yellow-500" />
                                        )}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Universal Excuse Modal Component
        const ExcuseModal = ({ isOpen, onClose, onSave, onDelete, title, dateText, initialValue, excuseType, t }) => {
            const [excuse, setExcuse] = useState('');

            useEffect(() => {
                if (isOpen) {
                    setExcuse(initialValue || '');
                }
            }, [isOpen, initialValue]);

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                if (excuse.trim()) {
                    onSave(excuse);
                    setExcuse('');
                    onClose();
                }
            };

            const handleDelete = () => {
                if (confirm(t('delete_confirm') || 'Silmek istediÄŸinize emin misiniz?')) {
                    onDelete();
                    setExcuse('');
                    onClose();
                }
            };

            // Type-based styling
            const typeStyles = {
                habit: { icon: 'Repeat', color: 'emerald', bg: 'bg-emerald-50 dark:bg-emerald-900/20', text: 'text-emerald-600 dark:text-emerald-400' },
                task: { icon: 'CheckSquare', color: 'blue', bg: 'bg-blue-50 dark:bg-blue-900/20', text: 'text-blue-600 dark:text-blue-400' },
                chain: { icon: 'Link2', color: 'orange', bg: 'bg-orange-50 dark:bg-orange-900/20', text: 'text-orange-600 dark:text-orange-400' }
            };
            const style = typeStyles[excuseType] || typeStyles.habit;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white dark:bg-dark-card p-6 rounded-2xl w-[95%] max-w-sm shadow-xl relative animate-slide-up" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-start mb-4 border-b dark:border-slate-700 pb-3">
                            <div className="flex items-start gap-3">
                                <div className={`${style.bg} p-2 rounded-xl ${style.text}`}>
                                    <Icon name={style.icon} size={20} />
                                </div>
                                <div>
                                    <h3 className="font-bold text-lg text-slate-800 dark:text-white">{initialValue ? (t('edit_excuse') || 'Bahane DÃ¼zenle') : (t('add_excuse') || 'Bahane Ekle')}</h3>
                                    <p className="text-sm font-medium text-slate-600 dark:text-slate-300 mt-0.5">{title}</p>
                                    <p className="text-xs text-gray-400 dark:text-slate-500">{dateText}</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-white">
                                <Icon name="X" size={20} />
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 dark:text-slate-400 mb-1">
                                    {t('excuse_reason') || 'Neden yapamadÄ±n?'}
                                </label>
                                <textarea
                                    value={excuse}
                                    onChange={e => setExcuse(e.target.value)}
                                    className="w-full p-3 bg-gray-50 dark:bg-slate-700 dark:text-white dark:border-slate-600 border rounded-xl outline-none text-sm resize-none focus:ring-2 focus:ring-blue-500/20 transition-all"
                                    rows="3"
                                    placeholder={t('excuse_placeholder') || 'Bahanenizi buraya yazÄ±n...'}
                                    autoFocus
                                    required
                                />
                            </div>
                            <div className="flex gap-2">
                                {initialValue && (
                                    <button type="button" onClick={handleDelete} className="bg-red-50 text-red-600 dark:bg-red-900/30 dark:text-red-400 px-4 py-3 rounded-xl font-bold hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors">
                                        <Icon name="Trash2" size={20} />
                                    </button>
                                )}
                                <button type="submit" className={`flex-1 bg-${style.color}-600 text-white font-bold py-3 rounded-xl hover:bg-${style.color}-700 transition-colors flex items-center justify-center gap-2`}>
                                    <Icon name="Save" size={18} />
                                    {t('save') || 'Kaydet'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // XP Log Modal Component
        const XpLogModal = ({ isOpen, onClose, xpLog, t, lang, getCategoryColor, translateCategory }) => {
            const [filterSource, setFilterSource] = useState('all');
            const [filterCategory, setFilterCategory] = useState('all');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [searchQuery, setSearchQuery] = useState('');

            // Kaynak tÃ¼rleri
            const sources = ['all', 'task', 'habit', 'chain', 'pomodoro'];

            // Kategorileri topla
            const categories = useMemo(() => {
                const cats = new Set(['all']);
                (xpLog || []).forEach(entry => {
                    if (entry.category) cats.add(entry.category);
                });
                return Array.from(cats);
            }, [xpLog]);

            // FiltrelenmiÅŸ log
            const filteredLog = useMemo(() => {
                const filtered = (xpLog || []).filter(entry => {
                    // Kaynak filtresi
                    if (filterSource !== 'all' && entry.source !== filterSource) return false;
                    // Kategori filtresi
                    if (filterCategory !== 'all' && entry.category !== filterCategory) return false;
                    // Tarih filtresi
                    if (startDate && entry.date < startDate) return false;
                    if (endDate && entry.date > endDate) return false;
                    // Arama filtresi
                    if (searchQuery) {
                        const query = searchQuery.toLowerCase();
                        const title = (entry.title || '').toLowerCase();
                        const category = (entry.category || '').toLowerCase();
                        if (!title.includes(query) && !category.includes(query)) return false;
                    }
                    return true;
                });
                // Sort by timestamp (newest first), then by date as fallback
                return filtered.sort((a, b) => {
                    // Primary sort: timestamp (newest first)
                    if (a.timestamp && b.timestamp) {
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    }
                    // Fallback: date (newest first)
                    if (a.date && b.date) {
                        return b.date.localeCompare(a.date);
                    }
                    return 0;
                });
            }, [xpLog, filterSource, filterCategory, startDate, endDate, searchQuery]);

            // Early return AFTER all hooks
            if (!isOpen) return null;

            // Toplam XP
            const totalXp = filteredLog.reduce((sum, entry) => sum + (entry.points || 0), 0);

            // Kaynak renkleri ve ikonlarÄ±
            const getSourceStyle = (source) => {
                switch (source) {
                    case 'task': return { icon: 'CheckCircle2', color: 'text-blue-500', bg: 'bg-blue-50 dark:bg-blue-900/20' };
                    case 'habit': return { icon: 'Repeat', color: 'text-green-500', bg: 'bg-green-50 dark:bg-green-900/20' };
                    case 'chain': return { icon: 'Link2', color: 'text-orange-500', bg: 'bg-orange-50 dark:bg-orange-900/20' };
                    case 'pomodoro': return { icon: 'Timer', color: 'text-red-500', bg: 'bg-red-50 dark:bg-red-900/20' };
                    default: return { icon: 'Zap', color: 'text-yellow-500', bg: 'bg-yellow-50 dark:bg-yellow-900/20' };
                }
            };

            // Kaynak adÄ± Ã§evirisi
            const getSourceName = (source) => {
                switch (source) {
                    case 'task': return t('source_task');
                    case 'habit': return t('source_habit');
                    case 'chain': return t('source_chain');
                    case 'pomodoro': return t('source_pomodoro');
                    case 'all': return t('source_all');
                    default: return source;
                }
            };

            // AÃ§Ä±klama oluÅŸtur
            const getDescription = (entry) => {
                switch (entry.source) {
                    case 'task':
                        return `"${entry.title}" ${t('xp_source_task_desc')}`;
                    case 'habit':
                        const freqText = entry.frequency === 'daily' ? t('daily') : entry.frequency === 'weekly' ? t('weekly') : t('monthly');
                        return `"${entry.title}" (${freqText}) ${t('xp_source_habit_desc')}`;
                    case 'chain':
                        return entry.streakDay ? `${t('streak_day')} ${entry.streakDay} - ${t('xp_source_chain_desc')}` : t('xp_source_chain_desc');
                    case 'pomodoro':
                        return `${entry.duration} ${t('xp_source_pomo_desc')}`;
                    default:
                        return '';
                }
            };

            // Tarih formatla
            const formatLogDate = (timestamp) => {
                const d = new Date(timestamp);
                return d.toLocaleDateString(lang === 'tr' ? 'tr-TR' : lang === 'ar' ? 'ar-SA' : 'en-US', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            // Filtreleri temizle
            const clearFilters = () => {
                setFilterSource('all');
                setFilterCategory('all');
                setStartDate('');
                setEndDate('');
                setSearchQuery('');
            };

            const hasFilters = filterSource !== 'all' || filterCategory !== 'all' || startDate || endDate || searchQuery;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white dark:bg-dark-card rounded-2xl w-full max-w-2xl max-h-[90vh] shadow-xl relative animate-slide-up flex flex-col" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="flex justify-between items-center p-5 border-b dark:border-slate-700">
                            <div className="flex items-center gap-3">
                                <div className="bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded-xl text-yellow-600 dark:text-yellow-400">
                                    <Icon name="Zap" size={24} />
                                </div>
                                <div>
                                    <h3 className="font-bold text-lg text-slate-800 dark:text-white">{t('xp_log_title')}</h3>
                                    <p className="text-xs text-gray-500 dark:text-slate-400">{filteredLog.length} {t('entries')}</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-white p-1">
                                <Icon name="X" size={24} />
                            </button>
                        </div>

                        {/* Filters */}
                        <div className="p-4 border-b dark:border-slate-700 bg-gray-50 dark:bg-slate-900/50">
                            <div className="flex items-center gap-2 mb-3">
                                <Icon name="Filter" size={16} className="text-gray-400" />
                                <span className="text-xs font-bold text-gray-500 uppercase">{t('filters')}</span>
                                {hasFilters && (
                                    <button onClick={clearFilters} className="ml-auto text-xs text-blue-500 hover:text-blue-600 font-bold flex items-center gap-1">
                                        <Icon name="X" size={12} /> {t('clear_filters')}
                                    </button>
                                )}
                            </div>

                            <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                {/* Kaynak Filtresi */}
                                <select
                                    value={filterSource}
                                    onChange={e => setFilterSource(e.target.value)}
                                    className="bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg px-2 py-1.5 text-xs font-bold outline-none"
                                >
                                    {sources.map(s => <option key={s} value={s}>{getSourceName(s)}</option>)}
                                </select>

                                {/* Kategori Filtresi */}
                                <select
                                    value={filterCategory}
                                    onChange={e => setFilterCategory(e.target.value)}
                                    className="bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg px-2 py-1.5 text-xs font-bold outline-none"
                                >
                                    {categories.map(c => <option key={c} value={c}>{c === 'all' ? t('source_all') : translateCategory(c)}</option>)}
                                </select>

                                {/* BaÅŸlangÄ±Ã§ Tarihi */}
                                <input
                                    type="date"
                                    value={startDate}
                                    onChange={e => setStartDate(e.target.value)}
                                    className="bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg px-2 py-1.5 text-xs font-bold outline-none"
                                    placeholder={t('start_date')}
                                />

                                {/* BitiÅŸ Tarihi */}
                                <input
                                    type="date"
                                    value={endDate}
                                    onChange={e => setEndDate(e.target.value)}
                                    className="bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg px-2 py-1.5 text-xs font-bold outline-none"
                                    placeholder={t('end_date')}
                                />
                            </div>

                            {/* Arama */}
                            <div className="mt-2 relative">
                                <Icon name="Search" size={14} className="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400" />
                                <input
                                    type="text"
                                    value={searchQuery}
                                    onChange={e => setSearchQuery(e.target.value)}
                                    placeholder="GÃ¶rev veya kategori ara..."
                                    className="w-full bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg pl-8 pr-3 py-1.5 text-xs outline-none"
                                />
                            </div>
                        </div>

                        {/* Summary */}
                        <div className="p-4 bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 border-b dark:border-slate-700">
                            <div className="flex items-center justify-between">
                                <span className="text-sm font-bold text-gray-600 dark:text-gray-300">{t('total_xp_filtered')}</span>
                                <div className="flex items-center gap-2">
                                    <Icon name="Zap" size={20} className="text-yellow-500" />
                                    <span className="text-2xl font-black text-yellow-600 dark:text-yellow-400">{totalXp.toLocaleString()}</span>
                                    <span className="text-sm font-bold text-gray-400">XP</span>
                                </div>
                            </div>
                        </div>

                        {/* Log List */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-2">
                            {filteredLog.length === 0 ? (
                                <div className="text-center py-12">
                                    <Icon name="FileText" size={48} className="mx-auto mb-4 text-gray-300 dark:text-slate-600" />
                                    <p className="text-gray-400 dark:text-slate-500 text-sm">{t('no_xp_records')}</p>
                                </div>
                            ) : (
                                filteredLog.map(entry => {
                                    const style = getSourceStyle(entry.source);
                                    return (
                                        <div key={entry.id} className={`flex items-start gap-3 p-3 rounded-xl ${style.bg} transition-all hover:scale-[1.01]`}>
                                            <div className={`p-2 rounded-lg bg-white dark:bg-slate-800 ${style.color}`}>
                                                <Icon name={style.icon} size={18} />
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className={`text-xs font-bold uppercase ${style.color}`}>{getSourceName(entry.source)}</span>
                                                    {entry.category && (
                                                        <span className={`${getCategoryColor(entry.category)} px-1.5 py-0.5 rounded text-[10px] font-bold`}>
                                                            {translateCategory(entry.category)}
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="text-sm text-gray-700 dark:text-gray-200 leading-snug">{getDescription(entry)}</p>
                                                <p className="text-[10px] text-gray-400 mt-1">{formatLogDate(entry.timestamp)}</p>
                                            </div>
                                            <div className="flex items-center gap-1 bg-white dark:bg-slate-800 px-2 py-1 rounded-lg shrink-0">
                                                <span className="text-lg font-black text-yellow-600 dark:text-yellow-400">+{entry.points}</span>
                                                <span className="text-[10px] font-bold text-gray-400">XP</span>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const Pomodoro = ({
            history,
            onSessionComplete,
            t,
            timeLeft,
            isActive,
            mode,
            toggleTimer,
            resetTimer,
            workDur,
            setWorkDur,
            breakDur,
            setBreakDur,
            setMode,
            setTimeLeft,
            setIsActive,
            alarmType,
            setAlarmType
        }) => {
            // Points are now calculated automatically: work = minutes * 5, break = minutes * 1
            const [showSettings, setShowSettings] = useState(false);
            const [historyView, setHistoryView] = useState('weekly');

            const formatTime = (seconds) => { const m = Math.floor(seconds / 60); const s = seconds % 60; return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; };
            const requestNotify = () => { if ("Notification" in window) Notification.requestPermission(); };

            const chartData = useMemo(() => {
                const data = [];
                const now = new Date();
                if (historyView === 'weekly') {
                    for (let i = 6; i >= 0; i--) {
                        const d = new Date(); d.setDate(now.getDate() - i);
                        const k = d.toISOString().split('T')[0];
                        const val = history[k]?.totalTime ? (history[k].totalTime / 3600) : 0;
                        const label = d.toLocaleDateString(document.documentElement.lang === 'tr' ? 'tr-TR' : 'en-US', { day: 'numeric', month: 'short' });
                        data.push({ label: label, value: parseFloat(val.toFixed(1)) });
                    }
                } else if (historyView === 'monthly') {
                    for (let i = 29; i >= 0; i--) {
                        const d = new Date(); d.setDate(now.getDate() - i);
                        const k = d.toISOString().split('T')[0];
                        const val = history[k]?.totalTime ? (history[k].totalTime / 3600) : 0;
                        const label = d.toLocaleDateString(document.documentElement.lang === 'tr' ? 'tr-TR' : 'en-US', { day: 'numeric', month: 'short' });
                        if (i % 5 === 0 || i === 0) data.push({ label: label, value: parseFloat(val.toFixed(1)) });
                        else data.push({ label: '', value: parseFloat(val.toFixed(1)) });
                    }
                } else if (historyView === 'yearly') {
                    for (let i = 0; i < 12; i++) {
                        const d = new Date(now.getFullYear(), i, 1);
                        const mName = d.toLocaleDateString(document.documentElement.lang === 'tr' ? 'tr-TR' : 'en-US', { month: 'short' });
                        let mTotal = 0;
                        Object.keys(history).forEach(k => {
                            const [y, m] = k.split('-');
                            if (parseInt(y) === now.getFullYear() && parseInt(m) === i + 1) {
                                mTotal += (history[k].totalTime || 0);
                            }
                        });
                        data.push({ label: mName, value: parseFloat((mTotal / 3600).toFixed(1)) });
                    }
                }
                return data;
            }, [history, historyView]);

            // Local state for settings inputs
            const [localWorkDur, setLocalWorkDur] = useState(workDur);
            const [localBreakDur, setLocalBreakDur] = useState(breakDur);

            // Sync local state when props change (initial load or external update)
            useEffect(() => {
                if (!showSettings) { // Only sync when NOT editing
                    setLocalWorkDur(workDur);
                    setLocalBreakDur(breakDur);
                }
            }, [workDur, breakDur, showSettings]);

            return (
                <div className={`max-w-xl mx-auto space-y-6 transition-all duration-500 ${isActive ? (mode === 'work' ? 'p-4 -m-4 rounded-3xl bg-gradient-to-br from-red-50 to-orange-50 dark:from-red-900/20 dark:to-orange-900/20' : 'p-4 -m-4 rounded-3xl bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20') : ''}`}>
                    <div className={`bg-white dark:bg-dark-card p-8 rounded-3xl shadow-lg border transition-all duration-500 text-center relative ${isActive ? (mode === 'work' ? 'border-red-300 dark:border-red-700 ring-4 ring-red-100 dark:ring-red-900/30' : 'border-green-300 dark:border-green-700 ring-4 ring-green-100 dark:ring-green-900/30') : 'border-gray-100 dark:border-dark-border'}`}>
                        <button onClick={() => setShowSettings(!showSettings)} className="absolute top-6 right-6 text-gray-400 hover:text-gray-600 dark:hover:text-white transition-colors"><Icon name="Settings" size={24} /></button>

                        {showSettings ? (
                            <div className="animate-fade-in p-4 bg-gray-50 dark:bg-slate-900 rounded-xl mb-6">
                                <h3 className="font-bold text-slate-700 dark:text-white mb-4">{t('settings')}</h3>
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div className="text-left">
                                        <label className="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">{t('work')} (min)</label>
                                        <input type="number" value={localWorkDur} onChange={e => setLocalWorkDur(e.target.value)} className="w-full p-2.5 rounded-xl border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-white font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all text-center" />
                                    </div>
                                    <div className="text-left">
                                        <label className="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">{t('break')} (min)</label>
                                        <input type="number" value={localBreakDur} onChange={e => setLocalBreakDur(e.target.value)} className="w-full p-2.5 rounded-xl border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-white font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all text-center" />
                                    </div>
                                </div>
                                <button onClick={requestNotify} className="w-full mb-4 py-2.5 rounded-xl bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 text-xs font-bold hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors flex items-center justify-center gap-2">
                                    <Icon name="Zap" size={14} /> {t('enable_notifications')}
                                </button>
                                <button onClick={() => {
                                    const w = parseInt(localWorkDur) || 25;
                                    const b = parseInt(localBreakDur) || 5;
                                    setWorkDur(w);
                                    setBreakDur(b);
                                    setShowSettings(false);
                                    resetTimer();
                                }} className="w-full bg-blue-600 text-white font-bold py-2 rounded-lg">{t('save')}</button>
                            </div>
                        ) : (
                            <>
                                <div className="flex justify-center gap-4 mb-8">
                                    <button onClick={() => { if (!isActive) { setMode('work'); resetTimer('work'); } }} className={`px-4 py-2 rounded-full font-bold transition-all ${mode === 'work' ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400 ring-2 ring-red-500/20' : 'text-gray-400 hover:bg-gray-100'}`}>{t('work')}</button>
                                    <button onClick={() => { if (!isActive) { setMode('break'); resetTimer('break'); } }} className={`px-4 py-2 rounded-full font-bold transition-all ${mode === 'break' ? 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400 ring-2 ring-green-500/20' : 'text-gray-400 hover:bg-gray-100'}`}>{t('break')}</button>
                                </div>
                                <div className="text-8xl font-black text-slate-800 dark:text-white mb-8 tracking-tighter tabular-nums select-none">
                                    {formatTime(timeLeft)}
                                </div>
                                <div className="flex justify-center gap-4 mb-6">
                                    <button onClick={toggleTimer} className="w-16 h-16 rounded-2xl bg-blue-600 text-white flex items-center justify-center hover:bg-blue-700 shadow-lg shadow-blue-200 dark:shadow-none transition-all hover:scale-105 active:scale-95">
                                        <Icon name={isActive ? "Pause" : "Play"} size={32} className="fill-current" />
                                    </button>
                                    <button onClick={() => { resetTimer(); }} className="w-16 h-16 rounded-2xl bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-slate-300 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-slate-600 transition-all">
                                        <Icon name="RotateCcw" size={24} />
                                    </button>
                                </div>
                                <div className="max-w-[200px] mx-auto text-center">
                                    <div className="text-xs text-gray-400 dark:text-slate-500">
                                        {mode === 'work' ? `${workDur} dk Ã— 5 = ${workDur * 5} XP` : `${breakDur} dk Ã— 1 = ${breakDur} XP`}
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            )
        };

        // --- LEADERBOARD & PROFILE COMPONENTS ---

        const ProfileSetupModal = ({ isOpen, onClose, user, fbRef, t, initialData }) => {
            const [nickname, setNickname] = useState(initialData?.nickname || '');
            const [avatar, setAvatar] = useState(initialData?.avatar || 'ğŸ‘¤');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (isOpen && initialData) {
                    setNickname(initialData.nickname || '');
                    setAvatar(initialData.avatar || 'ğŸ‘¤');
                }
            }, [isOpen, initialData]);

            // Mobile Profile Setup
            const avatars = [
                // Faces
                "ğŸ‘®", "ğŸ’‚", "ğŸ‘·", "ğŸ¤´", "ğŸ‘¸", "ğŸ‘³", "ğŸ‘²", "ğŸ§•", "ğŸ§”", "ğŸ‘±", "ğŸ‘¨â€ğŸ¦°", "ğŸ‘¨â€ğŸ¦±", "ğŸ‘¨â€ğŸ¦³", "ğŸ‘¨â€ğŸ¦²", "ğŸ‘©â€ğŸ¦°", "ğŸ‘©â€ğŸ¦±", "ğŸ‘©â€ğŸ¦³", "ğŸ‘©â€ğŸ¦²",
                "ğŸ¦", "ğŸ¯", "ğŸ»", "ğŸ¨", "ğŸ¼", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸ§", "ğŸ”", "ğŸ¦„", "ğŸ", "ğŸ", "ğŸ¦‹",
                "âš¡", "ğŸ”¥", "ğŸ’§", "ğŸŒŸ", "ğŸŒ™", "â˜€ï¸", "ğŸŒˆ", "ğŸŒªï¸", "â„ï¸", "ğŸ€", "ğŸ", "ğŸ„", "ğŸŒµ", "ğŸŒ´",
                "âš½", "ğŸ€", "ğŸˆ", "ğŸ¾", "ğŸ¥Š", "ğŸ¥‹", "ğŸ‹ï¸", "ğŸ¤¸", "ğŸš´", "ğŸ‡", "ğŸ®", "ğŸ²", "ğŸ¯", "ğŸ¨", "ğŸ¤", "ğŸ§", "ğŸ·", "ğŸ¸",
                "ğŸš€", "ğŸ›¸", "âš“", "âš”ï¸", "ğŸ›¡ï¸", "ğŸ¹", "ğŸ”®", "ğŸ§¬", "ğŸ”­", "ğŸ”¬", "ğŸ¤–", "ğŸ‘¾", "ğŸ‘»", "ğŸ‘½"
            ];

            const handleLeave = async () => {
                if (!confirm(t('confirm_leave'))) return;
                setLoading(true);
                try {
                    const { db, deleteField } = fbRef.current;
                    if (!db) throw new Error("Database not ready");

                    // Using deleteField to remove fields
                    await window.firebaseModules.updateDoc(window.firebaseModules.doc(db, "users", user.uid), {
                        nickname: window.firebaseModules.deleteField(),
                        avatar: window.firebaseModules.deleteField(),
                        joinedAt: window.firebaseModules.deleteField(),
                        totalScore: window.firebaseModules.deleteField(),
                        maxCombo: window.firebaseModules.deleteField()
                    });

                    onClose(false); // false = not joined/left
                } catch (e) {
                    console.error(e);
                    alert("Error: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleJoin = async () => {
                if (!nickname.trim()) return alert(t('nickname') + ' ?');
                setLoading(true);
                try {
                    const { db } = fbRef.current;
                    if (!db) throw new Error("Database not ready");

                    await window.firebaseModules.setDoc(window.firebaseModules.doc(db, "users", user.uid), {
                        nickname,
                        avatar,
                        joinedAt: new Date().toISOString(),
                        // IMPORTANT: Force immediate score update from local state if available, otherwise 0
                        totalScore: initialData?.totalScore || 0
                    }, { merge: true });

                    onClose({ joined: true, nickname, avatar });
                } catch (e) {
                    console.error(e);
                    alert("Error: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-3 sm:p-4 animate-fade-in">
                    <div className="bg-white dark:bg-dark-card rounded-2xl w-full max-w-sm relative animate-scale-up border dark:border-slate-700 shadow-2xl flex flex-col max-h-[80vh] sm:max-h-[85vh]">
                        {/* Header */}
                        <div className="p-4 sm:p-6 pb-2 shrink-0 text-center relative">
                            <button onClick={() => onClose(false)} className="absolute top-3 right-3 sm:top-4 sm:right-4 text-gray-400 hover:text-gray-600 dark:hover:text-white z-10 p-1">
                                <Icon name="X" size={20} />
                            </button>
                            <Icon name="Crown" size={32} className="mx-auto text-yellow-500 mb-2 sm:w-10 sm:h-10" />
                            <h2 className="text-lg sm:text-xl font-bold text-slate-800 dark:text-white">{initialData?.nickname ? t('update_profile') : t('join_leaderboard')}</h2>
                            <p className="text-[10px] sm:text-xs text-gray-500 dark:text-slate-400 mt-1">{t('join_desc')}</p>
                        </div>

                        {/* Scrollable Content */}
                        <div className="overflow-y-auto px-4 sm:px-6 py-2 custom-scrollbar flex-1 min-h-0">
                            <div className="space-y-3 sm:space-y-4">
                                <div>
                                    <label className="block text-[10px] sm:text-xs font-bold text-gray-500 dark:text-slate-400 mb-1">{t('nickname')}</label>
                                    <input value={nickname} onChange={e => setNickname(e.target.value)} className="w-full p-2.5 sm:p-3 bg-gray-50 dark:bg-slate-800 dark:text-white dark:border-slate-600 border rounded-xl font-bold text-center text-base sm:text-lg outline-none focus:ring-2 focus:ring-yellow-500 transition-all" placeholder="WillPower" maxLength={15} />
                                </div>

                                <div>
                                    <label className="block text-[10px] sm:text-xs font-bold text-gray-500 dark:text-slate-400 mb-2">{t('avatar')}</label>
                                    <div className="flex flex-wrap justify-center gap-1.5 sm:gap-2 pb-2 max-h-32 sm:max-h-40 overflow-y-auto">
                                        {avatars.map(a => (
                                            <button key={a} onClick={() => setAvatar(a)} className={`w-8 h-8 sm:w-9 sm:h-9 rounded-full text-base sm:text-lg flex items-center justify-center transition-all ${avatar === a ? 'bg-blue-100 ring-2 ring-blue-500 scale-110' : 'bg-gray-50 hover:bg-gray-100 dark:bg-slate-800 dark:hover:bg-slate-700'}`}>{a}</button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Fixed Footer */}
                        <div className="p-4 sm:p-6 pt-2 shrink-0 border-t border-gray-100 dark:border-slate-800 bg-gray-50/50 dark:bg-slate-900/50 flex flex-col gap-2 sm:gap-3">
                            <button onClick={handleJoin} disabled={loading} className="w-full bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white font-bold py-2.5 sm:py-3 rounded-xl shadow-lg shadow-purple-500/30 active:scale-95 transition-all text-xs sm:text-sm flex items-center justify-center gap-2">
                                {loading ? <Icon name="Loader" className="animate-spin" size={16} /> : <><Icon name="Check" size={16} className="sm:w-[18px] sm:h-[18px]" /> {initialData?.joinedAt ? t('save_profile') : t('join_leaderboard')}</>}
                            </button>
                            {!initialData?.joinedAt && (
                                <button onClick={() => onClose(false)} className="w-full text-gray-400 dark:text-slate-500 hover:text-gray-600 dark:hover:text-slate-300 text-[10px] sm:text-xs font-bold py-1.5 sm:py-2">
                                    {t('skip')}
                                </button>
                            )}
                            {initialData?.joinedAt && (
                                <button onClick={handleLeave} disabled={loading} className="w-full bg-red-50 dark:bg-red-900/20 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 py-2 sm:py-2.5 rounded-xl text-[10px] sm:text-xs font-bold transition-all flex items-center justify-center gap-1">
                                    <Icon name="LogOut" size={12} className="sm:w-[14px] sm:h-[14px]" />
                                    {t('leave_leaderboard')}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const LeaderboardView = ({ user, fbRef, t, leaderboardUser, onJoinClick, lang }) => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('score'); // 'score', 'combo', 'category'
            const [timePeriod, setTimePeriod] = useState('all'); // 'today', 'week', 'month', 'year', 'all'
            const [selectedCategory, setSelectedCategory] = useState('all');
            const [refreshing, setRefreshing] = useState(false);

            // Confetti animation state
            const [showConfetti, setShowConfetti] = useState(false);

            const fetchLeaders = async () => {
                if (!fbRef.current?.db) {
                    setLoading(false);
                    return;
                }
                setLoading(true);
                try {
                    const { db } = fbRef.current;
                    const { collection, query, limit, getDocs } = window.firebaseModules;

                    const q = query(collection(db, "users"), limit(100));
                    const snap = await getDocs(q);
                    const list = [];
                    snap.forEach(doc => {
                        const d = doc.data();
                        if (d.nickname) list.push({ id: doc.id, ...d });
                    });
                    setUsers(list);
                } catch (e) {
                    console.error("Leaderboard fetch error:", e);
                    setUsers([]);
                } finally {
                    setLoading(false);
                    setRefreshing(false);
                }
            };

            useEffect(() => {
                fetchLeaders();
                const interval = setInterval(fetchLeaders, 60000);
                return () => clearInterval(interval);
            }, [fbRef.current]);

            const handleRefresh = () => {
                setRefreshing(true);
                fetchLeaders();
            };

            // Get score based on time period
            const getScoreForPeriod = (u, period) => {
                if (period === 'today') return u.scoreToday || 0;
                if (period === 'week') return u.scoreWeek || 0;
                if (period === 'month') return u.scoreMonth || 0;
                if (period === 'year') return u.scoreYear || 0;
                return u.totalScore || 0;
            };

            // Get category score based on time period
            const getCategoryScore = (u, category, period) => {
                if (!u.categoryScores) return 0;
                const catKey = category === 'all' ? null : category;
                if (period === 'all') {
                    if (catKey) return u.categoryScores?.[catKey]?.total || 0;
                    return Object.values(u.categoryScores || {}).reduce((sum, c) => sum + (c.total || 0), 0);
                }
                const periodKey = { today: 'today', week: 'week', month: 'month', year: 'year' }[period] || 'total';
                if (catKey) return u.categoryScores?.[catKey]?.[periodKey] || 0;
                return Object.values(u.categoryScores || {}).reduce((sum, c) => sum + (c[periodKey] || 0), 0);
            };

            // Sort users based on active tab and filters
            const sortedUsers = useMemo(() => {
                let sorted = [...users];
                if (activeTab === 'score') {
                    sorted.sort((a, b) => getScoreForPeriod(b, timePeriod) - getScoreForPeriod(a, timePeriod));
                } else if (activeTab === 'combo') {
                    sorted.sort((a, b) => (b.maxCombo || 0) - (a.maxCombo || 0));
                } else if (activeTab === 'category') {
                    sorted.sort((a, b) => getCategoryScore(b, selectedCategory, timePeriod) - getCategoryScore(a, selectedCategory, timePeriod));
                } else if (activeTab === 'pomodoro') {
                    sorted.sort((a, b) => (b.pomodoroTime || 0) - (a.pomodoroTime || 0));
                }
                return sorted.slice(0, 50);
            }, [users, activeTab, timePeriod, selectedCategory]);

            // Find user rank in current view
            const userRank = sortedUsers.findIndex(u => u.id === user?.uid);

            // Get display score for a user
            const getDisplayScore = (u) => {
                if (activeTab === 'score') return getScoreForPeriod(u, timePeriod);
                if (activeTab === 'combo') return u.maxCombo || 0;
                if (activeTab === 'category') return getCategoryScore(u, selectedCategory, timePeriod);
                if (activeTab === 'pomodoro') return u.pomodoroTime || 0;
                return u.totalScore || 0;
            };

            // Format time for pomodoro display
            const formatPomodoroTime = (seconds) => {
                const hours = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                if (hours > 0) return `${hours}s ${mins}dk`;
                return `${mins}dk`;
            };

            // Period label translations
            const periodLabels = {
                today: { tr: 'BugÃ¼n', en: 'Today', ar: 'Ø§Ù„ÙŠÙˆÙ…' },
                week: { tr: 'Bu Hafta', en: 'This Week', ar: 'Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹' },
                month: { tr: 'Bu Ay', en: 'This Month', ar: 'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±' },
                year: { tr: 'Bu YÄ±l', en: 'This Year', ar: 'Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©' },
                all: { tr: 'TÃ¼m Zamanlar', en: 'All Time', ar: 'ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª' }
            };

            // Category options
            const categories = [
                { id: 'all', name: { tr: 'TÃ¼mÃ¼', en: 'All', ar: 'Ø§Ù„ÙƒÙ„' } },
                { id: 'Genel', name: { tr: 'Genel', en: 'General', ar: 'Ø¹Ø§Ù…' } },
                { id: 'EÄŸitim', name: { tr: 'EÄŸitim', en: 'Education', ar: 'ØªØ¹Ù„ÙŠÙ…' } },
                { id: 'Din', name: { tr: 'Din', en: 'Religion', ar: 'Ø¯ÙŠÙ†' } },
                { id: 'SaÄŸlÄ±k', name: { tr: 'SaÄŸlÄ±k', en: 'Health', ar: 'ØµØ­Ø©' } },
                { id: 'KiÅŸisel GeliÅŸim', name: { tr: 'KiÅŸisel GeliÅŸim', en: 'Personal Dev', ar: 'ØªØ·ÙˆÙŠØ± Ø´Ø®ØµÙŠ' } },
                { id: 'Spor', name: { tr: 'Spor', en: 'Sports', ar: 'Ø±ÙŠØ§Ø¶Ø©' } },
                { id: 'Ä°ÅŸ', name: { tr: 'Ä°ÅŸ', en: 'Work', ar: 'Ø¹Ù…Ù„' } }
            ];

            // Tab icons
            const tabConfig = {
                score: { icon: 'Trophy', label: { tr: 'XP', en: 'XP', ar: 'XP' } },
                combo: { icon: 'Flame', label: { tr: 'Combo', en: 'Combo', ar: 'ÙƒÙˆÙ…Ø¨Ùˆ' } },
                pomodoro: { icon: 'Timer', label: { tr: 'Pomo', en: 'Pomo', ar: 'Ø¨ÙˆÙ…Ùˆ' } },
                category: { icon: 'Grid3X3', label: { tr: 'Kategori', en: 'Category', ar: 'ÙØ¦Ø©' } }
            };

            // Rank badge styles
            const getRankBadge = (rank) => {
                if (rank === 0) return { bg: 'bg-gradient-to-br from-yellow-300 via-yellow-400 to-amber-500', shadow: 'shadow-lg shadow-yellow-300/50', icon: 'ğŸ‘‘', animate: 'animate-pulse' };
                if (rank === 1) return { bg: 'bg-gradient-to-br from-slate-200 via-slate-300 to-slate-400', shadow: 'shadow-lg shadow-slate-300/50', icon: 'ğŸ¥ˆ', animate: '' };
                if (rank === 2) return { bg: 'bg-gradient-to-br from-orange-300 via-orange-400 to-orange-500', shadow: 'shadow-lg shadow-orange-300/50', icon: 'ğŸ¥‰', animate: '' };
                return { bg: 'bg-gray-100 dark:bg-slate-700', shadow: '', icon: null, animate: '' };
            };

            // Score unit based on tab
            const getScoreUnit = () => {
                if (activeTab === 'combo') return 'ğŸ”¥';
                if (activeTab === 'pomodoro') return '';
                return 'XP';
            };

            // Format display score based on tab
            const formatDisplayScore = (score) => {
                if (activeTab === 'pomodoro') {
                    return formatPomodoroTime(score);
                }
                return Math.floor(score).toLocaleString();
            };

            return (
                <div className="max-w-2xl mx-auto pb-32 md:pb-24 px-3 sm:px-4 pt-4 sm:pt-6">
                    {/* Animated Header Card */}
                    <div className="relative mb-4 sm:mb-6">
                        {/* Background Glow Effect */}
                        <div className="absolute inset-0 bg-gradient-to-r from-purple-500/20 via-pink-500/20 to-orange-500/20 blur-3xl rounded-full scale-150 -z-10"></div>
                        
                        <div className="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 p-4 sm:p-6 md:p-8 rounded-2xl sm:rounded-3xl text-white shadow-2xl relative overflow-hidden">
                            {/* Animated Background Pattern */}
                            <div className="absolute inset-0 opacity-10">
                                <div className="absolute top-0 left-0 w-40 h-40 bg-white rounded-full blur-3xl animate-pulse"></div>
                                <div className="absolute bottom-0 right-0 w-60 h-60 bg-yellow-300 rounded-full blur-3xl animate-pulse" style={{animationDelay: '1s'}}></div>
                            </div>
                            
                            {/* Trophy Icon */}
                            <div className="absolute -top-4 -right-4 sm:top-0 sm:right-0 p-4 opacity-20 transform rotate-12">
                                <Icon name="Crown" size={100} className="sm:w-[140px] sm:h-[140px]" />
                            </div>
                            
                            <div className="relative z-10">
                                <div className="flex items-center justify-between mb-3 sm:mb-4">
                                    <h2 className="text-xl sm:text-2xl md:text-3xl font-black flex items-center gap-2">
                                        <span className="text-2xl sm:text-3xl">ğŸ†</span> {t('leaderboard')}
                                    </h2>
                                    <button 
                                        onClick={handleRefresh}
                                        disabled={refreshing}
                                        className="p-2 sm:p-2.5 bg-white/20 hover:bg-white/30 rounded-xl transition-all active:scale-95"
                                    >
                                        <Icon name="RefreshCw" size={16} className={`sm:w-5 sm:h-5 ${refreshing ? 'animate-spin' : ''}`} />
                                    </button>
                                </div>

                                {!leaderboardUser?.nickname ? (
                                    <div className="text-center py-2 sm:py-4">
                                        <button onClick={onJoinClick} className="bg-white text-purple-600 px-6 sm:px-8 py-3 sm:py-4 rounded-xl sm:rounded-2xl font-black text-base sm:text-lg hover:scale-105 transition-transform shadow-xl flex items-center gap-2 mx-auto group">
                                            <span className="group-hover:animate-bounce">ğŸš€</span>
                                            {t('join_leaderboard')} 
                                            <Icon name="ChevronRight" size={18} className="sm:w-5 sm:h-5 group-hover:translate-x-1 transition-transform" />
                                        </button>
                                        <p className="text-white/70 text-xs mt-2 font-medium">{t('join_desc')}</p>
                                    </div>
                                ) : (
                                    <div className="flex flex-col gap-2 w-full">
                                        <div className="flex items-center gap-2 sm:gap-3 bg-white/15 backdrop-blur-md p-2.5 sm:p-3 rounded-xl sm:rounded-2xl border border-white/20 relative group w-full">
                                            <div className="text-2xl sm:text-3xl bg-white/20 w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-lg sm:rounded-xl shadow-inner shrink-0">
                                                {leaderboardUser.avatar}
                                            </div>
                                            <div className="flex-1 min-w-0 text-left">
                                                <div className="text-[9px] sm:text-[10px] opacity-70 uppercase font-bold tracking-wider flex items-center gap-1">
                                                    {userRank !== -1 && userRank < 3 && <span>{getRankBadge(userRank).icon}</span>}
                                                    {t('rank')} #{userRank !== -1 ? userRank + 1 : '-'}
                                                </div>
                                                <div className="font-bold text-base sm:text-lg leading-tight truncate">{leaderboardUser.nickname}</div>
                                            </div>
                                            <div className="bg-white text-purple-600 px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg sm:rounded-xl font-black shrink-0 shadow-sm text-xs sm:text-sm">
                                                {formatDisplayScore(getDisplayScore(leaderboardUser))} {getScoreUnit()}
                                            </div>
                                            <button onClick={onJoinClick} className="absolute -top-2 -right-2 sm:-top-3 sm:-right-3 bg-white text-gray-500 hover:text-purple-600 p-1.5 sm:p-2 rounded-full shadow-lg hover:rotate-12 transition-all z-10">
                                                <Icon name="Edit2" size={12} className="sm:w-[14px] sm:h-[14px]" />
                                            </button>
                                        </div>
                                        <div className="flex items-center justify-center gap-1 text-[9px] sm:text-[10px] text-white/50 font-medium">
                                            <span className="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-green-400 rounded-full animate-pulse"></span>
                                            {t('synced')}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Tab Navigation */}
                    <div className="bg-white dark:bg-dark-card rounded-xl sm:rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm p-1 sm:p-1.5 mb-3 sm:mb-4 flex gap-1">
                        {Object.entries(tabConfig).map(([key, config]) => (
                            <button
                                key={key}
                                onClick={() => setActiveTab(key)}
                                className={`flex-1 flex items-center justify-center gap-1 sm:gap-1.5 py-2 sm:py-2.5 px-2 sm:px-3 rounded-lg sm:rounded-xl text-xs sm:text-sm font-bold transition-all ${
                                    activeTab === key
                                        ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg'
                                        : 'text-gray-500 dark:text-slate-400 hover:bg-gray-50 dark:hover:bg-slate-800'
                                }`}
                            >
                                <Icon name={config.icon} size={14} className="sm:w-4 sm:h-4" />
                                <span className="hidden xs:inline sm:inline">{config.label[lang] || config.label.en}</span>
                            </button>
                        ))}
                    </div>

                    {/* Time Period Filter (for score and category tabs) */}
                    {(activeTab === 'score' || activeTab === 'category') && (
                        <div className="bg-white dark:bg-dark-card rounded-xl sm:rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm p-2 sm:p-3 mb-3 sm:mb-4">
                            <div className="flex items-center gap-2 mb-2">
                                <Icon name="Calendar" size={14} className="text-purple-500 sm:w-4 sm:h-4" />
                                <span className="text-xs sm:text-sm font-bold text-gray-700 dark:text-slate-300">
                                    {lang === 'tr' ? 'DÃ¶nem' : lang === 'ar' ? 'Ø§Ù„ÙØªØ±Ø©' : 'Period'}
                                </span>
                            </div>
                            <div className="flex flex-wrap gap-1.5 sm:gap-2">
                                {Object.entries(periodLabels).map(([key, labels]) => (
                                    <button
                                        key={key}
                                        onClick={() => setTimePeriod(key)}
                                        className={`px-2.5 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl text-[10px] sm:text-xs font-bold transition-all ${
                                            timePeriod === key
                                                ? 'bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 ring-2 ring-purple-300 dark:ring-purple-700'
                                                : 'bg-gray-50 dark:bg-slate-800 text-gray-600 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-700'
                                        }`}
                                    >
                                        {labels[lang] || labels.en}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Category Filter (only for category tab) */}
                    {activeTab === 'category' && (
                        <div className="bg-white dark:bg-dark-card rounded-xl sm:rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm p-2 sm:p-3 mb-3 sm:mb-4">
                            <div className="flex items-center gap-2 mb-2">
                                <Icon name="Tag" size={14} className="text-pink-500 sm:w-4 sm:h-4" />
                                <span className="text-xs sm:text-sm font-bold text-gray-700 dark:text-slate-300">
                                    {lang === 'tr' ? 'Kategori' : lang === 'ar' ? 'Ø§Ù„ÙØ¦Ø©' : 'Category'}
                                </span>
                            </div>
                            <div className="flex flex-wrap gap-1.5 sm:gap-2">
                                {categories.map(cat => (
                                    <button
                                        key={cat.id}
                                        onClick={() => setSelectedCategory(cat.id)}
                                        className={`px-2.5 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl text-[10px] sm:text-xs font-bold transition-all ${
                                            selectedCategory === cat.id
                                                ? 'bg-pink-100 dark:bg-pink-900/30 text-pink-600 dark:text-pink-400 ring-2 ring-pink-300 dark:ring-pink-700'
                                                : 'bg-gray-50 dark:bg-slate-800 text-gray-600 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-700'
                                        }`}
                                    >
                                        {cat.name[lang] || cat.name.en}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Combo Info Card (only for combo tab) */}
                    {activeTab === 'combo' && (
                        <div className="bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 rounded-xl sm:rounded-2xl border border-orange-200 dark:border-orange-800/30 p-3 sm:p-4 mb-3 sm:mb-4">
                            <div className="flex items-center gap-2 sm:gap-3">
                                <div className="text-2xl sm:text-3xl animate-bounce">ğŸ”¥</div>
                                <div>
                                    <div className="font-bold text-orange-800 dark:text-orange-300 text-xs sm:text-sm">
                                        {lang === 'tr' ? 'Max Combo SÄ±ralamasÄ±' : lang === 'ar' ? 'ØªØ±ØªÙŠØ¨ Ø£Ø¹Ù„Ù‰ ÙƒÙˆÙ…Ø¨Ùˆ' : 'Max Combo Ranking'}
                                    </div>
                                    <div className="text-[10px] sm:text-xs text-orange-600 dark:text-orange-400/80">
                                        {lang === 'tr' ? 'Zincir veya gÃ¼nlÃ¼k alÄ±ÅŸkanlÄ±klardaki en uzun seri' : lang === 'ar' ? 'Ø£Ø·ÙˆÙ„ Ø³Ù„Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø£Ùˆ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©' : 'Longest streak from chain or daily habits'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Pomodoro Info Card (only for pomodoro tab) */}
                    {activeTab === 'pomodoro' && (
                        <div className="bg-gradient-to-r from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 rounded-xl sm:rounded-2xl border border-red-200 dark:border-red-800/30 p-3 sm:p-4 mb-3 sm:mb-4">
                            <div className="flex items-center gap-2 sm:gap-3">
                                <div className="text-2xl sm:text-3xl">ğŸ…</div>
                                <div>
                                    <div className="font-bold text-red-800 dark:text-red-300 text-xs sm:text-sm">
                                        {lang === 'tr' ? 'Pomodoro SÄ±ralamasÄ±' : lang === 'ar' ? 'ØªØ±ØªÙŠØ¨ Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ' : 'Pomodoro Ranking'}
                                    </div>
                                    <div className="text-[10px] sm:text-xs text-red-600 dark:text-red-400/80">
                                        {lang === 'tr' ? 'Toplam odaklanma sÃ¼resine gÃ¶re' : lang === 'ar' ? 'Ø­Ø³Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²' : 'By total focus time'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Leaderboard List */}
                    <div className="bg-white dark:bg-dark-card rounded-xl sm:rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm overflow-hidden">
                        {/* List Header */}
                        <div className="p-3 sm:p-4 border-b border-gray-50 dark:border-slate-800 bg-gray-50/50 dark:bg-slate-900/50 flex justify-between items-center">
                            <h3 className="font-bold text-slate-700 dark:text-white flex items-center gap-2 text-xs sm:text-sm">
                                <Icon name="Users" size={14} className="sm:w-4 sm:h-4" />
                                {periodLabels[timePeriod]?.[lang] || periodLabels[timePeriod]?.en || 'Leaders'}
                            </h3>
                            <div className="text-[10px] sm:text-xs text-gray-400 dark:text-slate-500 font-medium">
                                {sortedUsers.length} {lang === 'tr' ? 'oyuncu' : lang === 'ar' ? 'Ù„Ø§Ø¹Ø¨' : 'players'}
                            </div>
                        </div>

                        {loading ? (
                            <div className="p-8 sm:p-12 text-center">
                                <div className="inline-flex items-center gap-2 sm:gap-3 text-purple-500">
                                    <Icon name="Loader" size={20} className="animate-spin sm:w-6 sm:h-6" />
                                    <span className="text-sm sm:text-base font-medium">{t('loading')}</span>
                                </div>
                            </div>
                        ) : sortedUsers.length === 0 ? (
                            <div className="p-8 sm:p-12 text-center">
                                <div className="text-4xl sm:text-5xl mb-3">ğŸœï¸</div>
                                <div className="text-gray-400 dark:text-slate-500 font-medium text-sm sm:text-base">{t('no_leaderboard_data')}</div>
                                <p className="text-xs text-gray-300 dark:text-slate-600 mt-1">
                                    {lang === 'tr' ? 'Ä°lk sen ol!' : lang === 'ar' ? 'ÙƒÙ† Ø§Ù„Ø£ÙˆÙ„!' : 'Be the first!'}
                                </p>
                            </div>
                        ) : (
                            <div className="divide-y divide-gray-50 dark:divide-slate-800">
                                {/* Top 3 Podium (Special Display) */}
                                {sortedUsers.length >= 3 && (
                                    <div className="p-3 sm:p-4 bg-gradient-to-r from-yellow-50 via-gray-50 to-orange-50 dark:from-yellow-900/10 dark:via-slate-900/50 dark:to-orange-900/10">
                                        <div className="flex items-end justify-center gap-2 sm:gap-4">
                                            {/* 2nd Place */}
                                            <div className="flex flex-col items-center w-20 sm:w-24">
                                                <div className="text-xl sm:text-2xl mb-1">{sortedUsers[1]?.avatar || 'ğŸ‘¤'}</div>
                                                <div className="w-full bg-gradient-to-t from-slate-200 to-slate-100 dark:from-slate-700 dark:to-slate-600 rounded-t-lg p-2 sm:p-3 text-center h-16 sm:h-20 flex flex-col justify-end">
                                                    <div className="text-base sm:text-lg">ğŸ¥ˆ</div>
                                                    <div className="text-[9px] sm:text-[10px] font-bold text-slate-600 dark:text-slate-300 truncate">{sortedUsers[1]?.nickname}</div>
                                                    <div className="text-[9px] sm:text-[10px] font-bold text-slate-500 dark:text-slate-400">{formatDisplayScore(getDisplayScore(sortedUsers[1]))}</div>
                                                </div>
                                            </div>
                                            {/* 1st Place */}
                                            <div className="flex flex-col items-center w-24 sm:w-28 -mb-2">
                                                <div className="text-2xl sm:text-3xl mb-1 animate-bounce">{sortedUsers[0]?.avatar || 'ğŸ‘¤'}</div>
                                                <div className="w-full bg-gradient-to-t from-yellow-300 to-yellow-100 dark:from-yellow-700 dark:to-yellow-600 rounded-t-lg p-2 sm:p-3 text-center h-20 sm:h-24 flex flex-col justify-end shadow-lg">
                                                    <div className="text-lg sm:text-xl">ğŸ‘‘</div>
                                                    <div className="text-[10px] sm:text-xs font-black text-yellow-800 dark:text-yellow-200 truncate">{sortedUsers[0]?.nickname}</div>
                                                    <div className="text-[10px] sm:text-xs font-bold text-yellow-700 dark:text-yellow-300">{formatDisplayScore(getDisplayScore(sortedUsers[0]))}</div>
                                                </div>
                                            </div>
                                            {/* 3rd Place */}
                                            <div className="flex flex-col items-center w-20 sm:w-24">
                                                <div className="text-xl sm:text-2xl mb-1">{sortedUsers[2]?.avatar || 'ğŸ‘¤'}</div>
                                                <div className="w-full bg-gradient-to-t from-orange-200 to-orange-100 dark:from-orange-800 dark:to-orange-700 rounded-t-lg p-2 sm:p-3 text-center h-14 sm:h-16 flex flex-col justify-end">
                                                    <div className="text-base sm:text-lg">ğŸ¥‰</div>
                                                    <div className="text-[9px] sm:text-[10px] font-bold text-orange-700 dark:text-orange-300 truncate">{sortedUsers[2]?.nickname}</div>
                                                    <div className="text-[9px] sm:text-[10px] font-bold text-orange-600 dark:text-orange-400">{formatDisplayScore(getDisplayScore(sortedUsers[2]))}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Rest of the list (starting from 4th place or 1st if less than 3) */}
                                {sortedUsers.slice(sortedUsers.length >= 3 ? 3 : 0).map((u, idx) => {
                                    const actualRank = sortedUsers.length >= 3 ? idx + 3 : idx;
                                    const rankBadge = getRankBadge(actualRank);
                                    const isCurrentUser = u.id === user?.uid;
                                    const score = getDisplayScore(u);

                                    return (
                                        <div 
                                            key={u.id} 
                                            className={`flex items-center gap-2 sm:gap-3 p-2.5 sm:p-3 md:p-4 transition-all hover:bg-gray-50 dark:hover:bg-slate-800/50 ${
                                                isCurrentUser ? 'bg-purple-50 dark:bg-purple-900/20 ring-1 ring-purple-200 dark:ring-purple-800' : ''
                                            }`}
                                        >
                                            {/* Rank */}
                                            <div className={`w-7 h-7 sm:w-8 sm:h-8 flex shrink-0 items-center justify-center font-black rounded-lg text-xs sm:text-sm ${rankBadge.bg} ${rankBadge.shadow} ${rankBadge.animate}`}>
                                                {actualRank + 1}
                                            </div>

                                            {/* Avatar */}
                                            <div className="text-xl sm:text-2xl shrink-0">{u.avatar || 'ğŸ‘¤'}</div>

                                            {/* User Info */}
                                            <div className="flex-1 min-w-0">
                                                <div className="font-bold text-slate-800 dark:text-white truncate flex items-center gap-1.5 sm:gap-2 text-xs sm:text-sm">
                                                    {u.nickname || 'Unknown'}
                                                    {isCurrentUser && (
                                                        <span className="text-[8px] sm:text-[9px] bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 px-1 sm:px-1.5 py-0.5 rounded font-bold uppercase">
                                                            {t('you')}
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="text-[9px] sm:text-[10px] text-gray-400 dark:text-slate-500 font-medium flex items-center gap-1 sm:gap-2">
                                                    <span>Lv.{Math.floor(Math.sqrt((u.totalScore || 0) / 100)) + 1}</span>
                                                    {activeTab !== 'combo' && activeTab !== 'pomodoro' && (
                                                        <>
                                                            <span className="opacity-50">â€¢</span>
                                                            <span className="flex items-center gap-0.5">ğŸ”¥ {u.maxCombo || 0}</span>
                                                        </>
                                                    )}
                                                    {activeTab === 'pomodoro' && (
                                                        <>
                                                            <span className="opacity-50">â€¢</span>
                                                            <span className="flex items-center gap-0.5">ğŸ… {u.pomodoroSessions || 0} seans</span>
                                                        </>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Score */}
                                            <div className="text-right shrink-0">
                                                <div className="font-black text-slate-700 dark:text-slate-200 text-xs sm:text-sm whitespace-nowrap">
                                                    {formatDisplayScore(score)}
                                                </div>
                                                <div className="text-[9px] sm:text-[10px] text-gray-400 font-medium">
                                                    {getScoreUnit()}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    {/* Fun Stats Card */}
                    {leaderboardUser?.nickname && sortedUsers.length > 0 && (
                        <div className="mt-3 sm:mt-4 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl sm:rounded-2xl border border-purple-100 dark:border-purple-800/30 p-3 sm:p-4">
                            <div className="flex items-center gap-2 mb-2 sm:mb-3">
                                <span className="text-base sm:text-lg">ğŸ“Š</span>
                                <span className="font-bold text-purple-800 dark:text-purple-300 text-xs sm:text-sm">
                                    {lang === 'tr' ? 'Senin Durumun' : lang === 'ar' ? 'Ø­Ø§Ù„ØªÙƒ' : 'Your Status'}
                                </span>
                            </div>
                            <div className="grid grid-cols-3 gap-2 sm:gap-3">
                                <div className="bg-white dark:bg-slate-800/50 rounded-lg sm:rounded-xl p-2 sm:p-3 text-center">
                                    <div className="text-lg sm:text-xl font-black text-purple-600 dark:text-purple-400">
                                        #{userRank !== -1 ? userRank + 1 : '-'}
                                    </div>
                                    <div className="text-[9px] sm:text-[10px] text-gray-500 dark:text-slate-400 font-medium">
                                        {lang === 'tr' ? 'SÄ±ralama' : lang === 'ar' ? 'Ø§Ù„ØªØ±ØªÙŠØ¨' : 'Rank'}
                                    </div>
                                </div>
                                <div className="bg-white dark:bg-slate-800/50 rounded-lg sm:rounded-xl p-2 sm:p-3 text-center">
                                    <div className="text-lg sm:text-xl font-black text-pink-600 dark:text-pink-400">
                                        {userRank !== -1 && userRank > 0 
                                            ? (activeTab === 'pomodoro' 
                                                ? formatPomodoroTime(getDisplayScore(sortedUsers[userRank - 1]) - getDisplayScore(leaderboardUser))
                                                : Math.floor(getDisplayScore(sortedUsers[userRank - 1]) - getDisplayScore(leaderboardUser)).toLocaleString())
                                            : 'ğŸ†'}
                                    </div>
                                    <div className="text-[9px] sm:text-[10px] text-gray-500 dark:text-slate-400 font-medium">
                                        {lang === 'tr' ? 'Bir Ãœste' : lang === 'ar' ? 'Ù„Ù„ØªÙÙˆÙ‚' : 'To Beat'}
                                    </div>
                                </div>
                                <div className="bg-white dark:bg-slate-800/50 rounded-lg sm:rounded-xl p-2 sm:p-3 text-center">
                                    <div className="text-lg sm:text-xl font-black text-orange-600 dark:text-orange-400">
                                        {sortedUsers.length > 0 ? Math.round((userRank !== -1 ? (sortedUsers.length - userRank) / sortedUsers.length * 100 : 0)) : 0}%
                                    </div>
                                    <div className="text-[9px] sm:text-[10px] text-gray-500 dark:text-slate-400 font-medium">
                                        {lang === 'tr' ? 'Ãœst YÃ¼zde' : lang === 'ar' ? 'Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©' : 'Top %'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const IradahApp = () => {
            const [isConfigured, setIsConfigured] = useState(false);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [loadingStatus, setLoadingStatus] = useState("ModÃ¼ller yÃ¼kleniyor...");
            const [moduleLoadError, setModuleLoadError] = useState(false);
            const fbRef = useRef({});
            const lastLocalUpdate = useRef(0);
            const [autoSaveStatus, setAutoSaveStatus] = useState('idle');
            const [dataLoaded, setDataLoaded] = useState(false); // Prevents overwrite
            const [minLoadingTime, setMinLoadingTime] = useState(false);
            const [alarmType, setAlarmType] = useState(localStorage.getItem('iradah_alarm_sound') || 'classic');
            const [levelInfoModalOpen, setLevelInfoModalOpen] = useState(false); // New state for Level Info Modal

            const initialData = {
                columns: { todo: { id: 'todo', items: [] }, inProgress: { id: 'inProgress', items: [] }, done: { id: 'done', items: [] } },
                habitExcuses: {}, // Legacy - habits only
                excuses: { // New universal excuse system
                    habits: {},  // { habitId: { dateKey: "text" } }
                    tasks: {},   // { taskId: "text" }
                    chain: {}    // { dateKey: "text" }
                },
                habits: [],
                chainData: {},
                chainTarget: '',
                pomodoroHistory: {},
                xpLog: [], // XP kazanÄ±m geÃ§miÅŸi
                archivedTasks: [], // ArÅŸivlenen gÃ¶revler
                settings: {
                    theme: 'light',
                    alarmType: 'classic'
                    // lang is device-specific (localStorage only)
                    // workDur and breakDur are user-specific (localStorage only)
                }
            };

            const [columns, setColumns] = useState(initialData.columns);
            const [habits, setHabits] = useState(initialData.habits);
            const [chainData, setChainData] = useState(initialData.chainData);
            const [chainTarget, setChainTarget] = useState(initialData.chainTarget);
            const [pomodoroHistory, setPomodoroHistory] = useState(initialData.pomodoroHistory);
            const [xpLog, setXpLog] = useState(initialData.xpLog);
            const [xpLogModalOpen, setXpLogModalOpen] = useState(false);
            const [archivedTasks, setArchivedTasks] = useState(initialData.archivedTasks);
            const [showArchive, setShowArchive] = useState(false);

            const [activeTab, setActiveTab] = useState(localStorage.getItem('iradah_active_tab') || 'board');
            const [modalColId, setModalColId] = useState(null);
            const [editingTask, setEditingTask] = useState(null);

            // Modal States (Restored)
            const [taskModalOpen, setTaskModalOpen] = useState(false);
            const [habitModalOpen, setHabitModalOpen] = useState(false);
            const [habitModalFreq, setHabitModalFreq] = useState('daily');
            const [editingHabit, setEditingHabit] = useState(null);
            const [habitViewDate, setHabitViewDate] = useState(new Date());
            const [habitTab, setHabitTab] = useState('daily');
            const [statPeriod, setStatPeriod] = useState('all');
            const [statDate, setStatDate] = useState(new Date());
            // Decoupled Habit Stats State - Separate for Daily, Weekly, Monthly
            const [dailyHabitStatPeriod, setDailyHabitStatPeriod] = useState('daily');
            const [dailyHabitStatDate, setDailyHabitStatDate] = useState(new Date());
            const [weeklyHabitStatPeriod, setWeeklyHabitStatPeriod] = useState('weekly');
            const [weeklyHabitStatDate, setWeeklyHabitStatDate] = useState(new Date());
            const [monthlyHabitStatPeriod, setMonthlyHabitStatPeriod] = useState('monthly');
            const [monthlyHabitStatDate, setMonthlyHabitStatDate] = useState(new Date());
            // Task Efficiency Card State
            const [taskStatPeriod, setTaskStatPeriod] = useState('today'); // today, weekly, monthly, all
            // Category Activity Card State
            const [categoryStatPeriod, setCategoryStatPeriod] = useState('all'); // today, weekly, monthly, all
            // Legacy (for backward compatibility)
            const [habitStatPeriod, setHabitStatPeriod] = useState('weekly');
            const [habitStatDate, setHabitStatDate] = useState(new Date());
            const [excuseCategory, setExcuseCategory] = useState('all');
            const [habitExcuses, setHabitExcuses] = useState({});
            // Universal Excuses System
            const [excuses, setExcuses] = useState({ habits: {}, tasks: {}, chain: {} });
            const [excuseModalOpen, setExcuseModalOpen] = useState(false);
            const [excuseModalData, setExcuseModalData] = useState({
                type: 'habit', // 'habit', 'task', 'chain'
                id: null, // habitId, taskId, or null for chain
                dateKey: '',
                title: '', // habit name, task title, or chain text
                dateText: ''
            });
            const [pomoSeconds, setPomoSeconds] = useState(() => {
                // Try to restore standard state
                const saved = parseInt(localStorage.getItem('iradah_pomo_seconds'));
                return !isNaN(saved) ? saved : 25 * 60;
            });
            const [pomoActive, setPomoActive] = useState(localStorage.getItem('iradah_pomo_active') === 'true');
            const [pomoMode, setPomoMode] = useState(localStorage.getItem('iradah_pomo_mode') || 'work');
            const [workDur, setWorkDur] = useState(parseInt(localStorage.getItem('iradah_work_dur')) || 25);
            const [breakDur, setBreakDur] = useState(parseInt(localStorage.getItem('iradah_break_dur')) || 5);

            // Leaderboard State
            const [leaderboardUser, setLeaderboardUser] = useState(null);
            const [showProfileModal, setShowProfileModal] = useState(false);
            const openProfileSetup = () => setShowProfileModal(true); /* Fix: Define helper */

            // Check if user has joined leaderboard
            useEffect(() => {
                if (!user || !fbRef.current?.db) return;
                const checkJoin = async () => {
                    try {
                        const { doc, getDoc } = window.firebaseModules;
                        const snap = await getDoc(doc(fbRef.current.db, "users", user.uid));
                        if (snap.exists()) setLeaderboardUser(snap.data());
                        else setLeaderboardUser(null);
                    } catch (e) { console.error("Check join error", e); }
                };
                checkJoin();
            }, [user, dataLoaded]);

            // Sync score to leaderboard (Enhanced with time-based, category scores, and pomodoro stats)
            useEffect(() => {
                if (!user || !leaderboardUser || !fbRef.current?.db) return;

                const timer = setTimeout(async () => {
                    try {
                        const currentTotalScore = xpLog.reduce((acc, curr) => acc + (curr.points || 0), 0);
                        
                        // Calculate max combo from CHAIN
                        let maxChainStreak = 0;
                        let currentChainStreak = 0;
                        const sortedDates = Object.keys(chainData || {}).sort();
                        if (sortedDates.length > 0) {
                            const oneDay = 24 * 60 * 60 * 1000;
                            let lastDate = null;
                            sortedDates.forEach(dStr => {
                                const d = new Date(dStr);
                                if (lastDate) {
                                    const diff = Math.round((d - lastDate) / oneDay);
                                    if (diff === 1) currentChainStreak++;
                                    else currentChainStreak = 1;
                                } else {
                                    currentChainStreak = 1;
                                }
                                if (currentChainStreak > maxChainStreak) maxChainStreak = currentChainStreak;
                                lastDate = d;
                            });
                        }

                        // Calculate max combo from DAILY HABITS
                        let maxHabitStreak = 0;
                        (habits || []).filter(h => h.frequency === 'daily').forEach(habit => {
                            const dates = Object.keys(habit.completedDays || {}).sort();
                            if (dates.length === 0) return;
                            
                            let currentHabitStreak = 0;
                            let habitMaxStreak = 0;
                            let lastHabitDate = null;
                            const oneDay = 24 * 60 * 60 * 1000;
                            
                            dates.forEach(dStr => {
                                const d = new Date(dStr);
                                if (lastHabitDate) {
                                    const diff = Math.round((d - lastHabitDate) / oneDay);
                                    if (diff <= 1.5) currentHabitStreak++;
                                    else currentHabitStreak = 1;
                                } else {
                                    currentHabitStreak = 1;
                                }
                                if (currentHabitStreak > habitMaxStreak) habitMaxStreak = currentHabitStreak;
                                lastHabitDate = d;
                            });
                            
                            if (habitMaxStreak > maxHabitStreak) maxHabitStreak = habitMaxStreak;
                        });

                        // Use the higher of chain or habit streak
                        const maxStreak = Math.max(maxChainStreak, maxHabitStreak);

                        // Calculate POMODORO stats
                        const pomodoroEntries = Object.entries(pomodoroHistory || {});
                        const pomodoroTotalTime = pomodoroEntries.reduce((sum, [, d]) => sum + (d.totalTime || 0), 0);
                        const pomodoroTotalSessions = pomodoroEntries.reduce((sum, [, d]) => sum + (d.sessions || 1), 0);
                        const pomodoroTotalPoints = pomodoroEntries.reduce((sum, [, d]) => sum + (d.totalPoints || 0), 0);

                        // Calculate time-based scores
                        const now = new Date();
                        const todayKey = getDateKey(now);
                        
                        // Week start (Monday)
                        const weekStart = new Date(now);
                        const dayOfWeek = weekStart.getDay();
                        const diffToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                        weekStart.setDate(weekStart.getDate() - diffToMonday);
                        weekStart.setHours(0, 0, 0, 0);
                        const weekStartKey = getDateKey(weekStart);
                        
                        // Month start
                        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                        const monthStartKey = getDateKey(monthStart);
                        
                        // Year start
                        const yearStart = new Date(now.getFullYear(), 0, 1);
                        const yearStartKey = getDateKey(yearStart);

                        // Calculate scores for each period and category
                        let scoreToday = 0, scoreWeek = 0, scoreMonth = 0, scoreYear = 0;
                        const categoryScores = {};

                        (xpLog || []).forEach(entry => {
                            const entryDate = entry.date || (entry.timestamp ? entry.timestamp.split('T')[0] : null);
                            if (!entryDate) return;
                            const points = entry.points || 0;
                            const category = entry.category || 'Genel';

                            // Initialize category if needed
                            if (!categoryScores[category]) {
                                categoryScores[category] = { total: 0, today: 0, week: 0, month: 0, year: 0 };
                            }

                            // Always add to total
                            categoryScores[category].total += points;

                            // Time-based accumulation
                            if (entryDate === todayKey) {
                                scoreToday += points;
                                categoryScores[category].today += points;
                            }
                            if (entryDate >= weekStartKey) {
                                scoreWeek += points;
                                categoryScores[category].week += points;
                            }
                            if (entryDate >= monthStartKey) {
                                scoreMonth += points;
                                categoryScores[category].month += points;
                            }
                            if (entryDate >= yearStartKey) {
                                scoreYear += points;
                                categoryScores[category].year += points;
                            }
                        });

                        // Prepare update data
                        const updateData = {
                            totalScore: currentTotalScore,
                            maxCombo: maxStreak,
                            scoreToday,
                            scoreWeek,
                            scoreMonth,
                            scoreYear,
                            categoryScores,
                            pomodoroTime: pomodoroTotalTime,
                            pomodoroSessions: pomodoroTotalSessions,
                            pomodoroPoints: pomodoroTotalPoints,
                            lastUpdated: new Date().toISOString()
                        };

                        // Check if update is needed
                        const needsUpdate = 
                            leaderboardUser.totalScore !== currentTotalScore || 
                            (leaderboardUser.maxCombo || 0) < maxStreak ||
                            leaderboardUser.scoreToday !== scoreToday ||
                            leaderboardUser.scoreWeek !== scoreWeek ||
                            leaderboardUser.pomodoroTime !== pomodoroTotalTime;

                        if (needsUpdate) {
                            const { doc, setDoc } = window.firebaseModules;
                            await setDoc(doc(fbRef.current.db, "users", user.uid), updateData, { merge: true });
                            setLeaderboardUser(prev => ({ ...prev, ...updateData }));
                        }
                    } catch (e) { console.error("Score sync error", e); }
                }, 5000);
                return () => clearTimeout(timer);
            }, [xpLog, chainData, habits, pomodoroHistory, user, leaderboardUser]);

            // Critical Fix: Restore endTimeRef logic
            const endTimeRef = useRef(null);

            // Restore logic on mount
            useEffect(() => {
                const savedEnd = localStorage.getItem('iradah_pomo_endtime');
                if (savedEnd && savedEnd !== "null") {
                    endTimeRef.current = parseInt(savedEnd);
                }
            }, []);

            // Persist Duration Settings & Mode (Cloud + Local)
            // Unified Settings Persistence (Cloud + Local)
            // This prevents stale closure checks by grouping all dependencies
            useEffect(() => {
                // Update LocalStorage immediately
                localStorage.setItem('iradah_work_dur', workDur);
                localStorage.setItem('iradah_break_dur', breakDur);
                localStorage.setItem('iradah_alarm_sound', alarmType);
                localStorage.setItem('iradah_theme', theme);
                // Language is NOT stored here - it's handled separately below

                // Only sync to cloud if user is logged in
                if (!user) return;

                // Mark the timestamp when we make a local change
                lastLocalUpdate.current = Date.now();

                // Sync ONLY theme and alarmType to cloud (lang is device-specific, workDur/breakDur are user-specific)
                persistData({ settings: { alarmType, theme } });
            }, [alarmType, theme, workDur, breakDur, user]);

            useEffect(() => {
                const timer = setTimeout(() => setMinLoadingTime(true), 2000);
                return () => clearTimeout(timer);
            }, []);

            useEffect(() => {
                localStorage.setItem('iradah_pomo_mode', pomoMode);
            }, [pomoMode]);

            useEffect(() => {
                localStorage.setItem('iradah_active_tab', activeTab);
            }, [activeTab]);

            // Robust Timer Logic with Persistence
            useEffect(() => {
                let interval = null;
                // If checking active, confirm integrity
                if (pomoActive) {
                    // Logic: If active but no endTime, RECOVER IT from seconds (new session) OR localstorage
                    if (!endTimeRef.current) {
                        const savedEnd = localStorage.getItem('iradah_pomo_endtime');
                        if (savedEnd && savedEnd !== "null") {
                            endTimeRef.current = parseInt(savedEnd);
                        } else {
                            // New start?
                            endTimeRef.current = Date.now() + pomoSeconds * 1000;
                            localStorage.setItem('iradah_pomo_endtime', endTimeRef.current);
                        }
                    }

                    interval = setInterval(() => {
                        const now = Date.now();
                        const remaining = Math.ceil((endTimeRef.current - now) / 1000);

                        if (remaining <= 0) {
                            // Complete
                            setPomoSeconds(0);
                            setPomoActive(false);
                            endTimeRef.current = null;
                            localStorage.removeItem('iradah_pomo_endtime');
                            localStorage.setItem('iradah_pomo_active', 'false');
                            localStorage.setItem('iradah_pomo_seconds', 0);

                            playAlarm(localStorage.getItem('iradah_alarm_sound'));
                            if (pomoMode === 'work') {
                                handlePomodoroComplete(workDur * 60, workDur * 5); // Ã‡alÄ±ÅŸÄ±lan dakika Ã— 5 puan
                            } else {
                                handlePomodoroComplete(breakDur * 60, breakDur * 1); // Mola dakikasÄ± Ã— 1 puan
                            }
                        } else {
                            setPomoSeconds(remaining);
                            // Optional: sync seconds to LS occasionally for backup
                            // localStorage.setItem('iradah_pomo_seconds', remaining); // Don't spam LS
                        }
                    }, 200);
                } else {
                    // Paused
                    if (endTimeRef.current) {
                        // We just paused. Save 'remaining' as seconds. Clear endtime.
                        endTimeRef.current = null;
                        localStorage.removeItem('iradah_pomo_endtime');
                        // Seconds are already in state, but assure LS sync happens in effect below
                    }
                    localStorage.setItem('iradah_pomo_active', 'false');
                }
                return () => clearInterval(interval);
            }, [pomoActive, pomoMode, workDur]); // Simplified dependencies

            const togglePomoTimer = () => {
                if (!pomoActive) {
                    // Starting
                    endTimeRef.current = Date.now() + pomoSeconds * 1000;
                    localStorage.setItem('iradah_pomo_endtime', endTimeRef.current);
                } else {
                    // Pausing
                    localStorage.setItem('iradah_pomo_seconds', pomoSeconds); // Save current freeze
                }
                setPomoActive(!pomoActive);
                localStorage.setItem('iradah_pomo_active', (!pomoActive).toString());
            }

            const resetPomoTimer = (targetMode = null) => {
                const m = targetMode || pomoMode;
                setPomoActive(false);
                endTimeRef.current = null;
                const newSeconds = m === 'work' ? workDur * 60 : breakDur * 60;
                setPomoSeconds(newSeconds);
                localStorage.removeItem('iradah_pomo_endtime');
                localStorage.setItem('iradah_pomo_active', 'false');
                localStorage.setItem('iradah_pomo_seconds', newSeconds);
            }
            // Removed the dangerous auto-reset effect (useEffect(() => { if (!pomoActive) ... }))
            // Replaced by specific dependency on Durations only:
            useEffect(() => {
                if (!pomoActive && !endTimeRef.current) {
                    const target = pomoMode === 'work' ? workDur * 60 : breakDur * 60;
                    // Only auto-update if we are in a 'fresh' state (full duration matches previous setting?)
                    // Better: Update seconds if user changes duration settings while paused
                    setPomoSeconds(target);
                    localStorage.setItem('iradah_pomo_seconds', target);
                }
            }, [workDur, breakDur, pomoMode]); // Removed pomoActive dependency to avoid loops

            // Logo Size Fix
            // In Header...

            const [draggedItem, setDraggedItem] = useState(null);
            const [draggedSource, setDraggedSource] = useState(null);

            const [lang, setLang] = useState(() => localStorage.getItem('iradah_lang') || 'tr');
            const [theme, setTheme] = useState(() => localStorage.getItem('iradah_theme') || 'light');

            // Online/Offline Detection
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            // Language persistence (localStorage only - device-specific)
            useEffect(() => {
                localStorage.setItem('iradah_lang', lang);
                document.documentElement.setAttribute('lang', lang);
                document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
            }, [lang]);

            // Theme Application - Fixed for persistence
            useEffect(() => {
                localStorage.setItem('iradah_theme', theme);
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                // Sync theme to cloud immediately
                if (user && dataLoaded) {
                    persistData({ settings: { theme, alarmType } });
                }
            }, [theme, user, dataLoaded]);

            // Apply theme on mount
            useEffect(() => {
                const savedTheme = localStorage.getItem('iradah_theme') || 'light';
                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                }
            }, []);

            // Online/Offline Event Listeners
            useEffect(() => {
                const handleOnline = () => {
                    console.log('âœ… [Network] Back online');
                    setIsOnline(true);
                };

                const handleOffline = () => {
                    console.log('âŒ [Network] Connection lost');
                    setIsOnline(false);
                };

                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            const t = (key) => (TRANSLATIONS[lang] ? TRANSLATIONS[lang][key] : TRANSLATIONS['tr'][key]) || key;

            // Helper to translate category names
            const translateCategory = (cat) => {
                // Use getCategoryName for consistent translation across all languages
                return getCategoryName(cat, lang);
            };

            useEffect(() => {
                let attempts = 0;
                const interval = setInterval(() => {
                    attempts++;
                    if (window.firebaseModulesLoaded) {
                        clearInterval(interval);

                        // Config kontrolÃ¼ - Check if config.js loaded properly
                        const activeConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : FIREBASE_CONFIG;

                        // Check if config is missing or invalid
                        if (!activeConfig || !activeConfig.apiKey || activeConfig.apiKey === "YOUR_API_KEY_HERE" || activeConfig.apiKey === "BURAYA_YAPISTIRIN") {
                            setLoading(true);
                            setLoadingStatus(t('config_error'));
                            console.error("âŒ Firebase config not found. Please create config.js from config.example.js");
                            return;
                        }

                        setLoadingStatus(t('loading'));
                        initializeFirebase(activeConfig);
                    } else if (attempts > 50) {
                        clearInterval(interval);
                        setModuleLoadError(true);
                        setLoading(false);
                    }
                }, 100);
                return () => clearInterval(interval);
            }, [lang]);

            const initializeFirebase = (cfg) => {
                try {
                    const mod = window.firebaseModules;
                    try { mod.initializeApp(cfg); } catch (e) { }
                    fbRef.current = { auth: mod.getAuth(), db: mod.getFirestore(), googleProvider: new mod.GoogleAuthProvider(), ...mod };

                    // Enable Offline Persistence
                    try {
                        mod.enableIndexedDbPersistence(fbRef.current.db).catch((err) => {
                            if (err.code == 'failed-precondition') {
                                console.log('Persistence failed: Multiple tabs open');
                            } else if (err.code == 'unimplemented') {
                                console.log('Persistence not supported by browser');
                            }
                        });
                    } catch (e) { console.log("Persistence setup error:", e); }

                    setIsConfigured(true);
                    fbRef.current.onAuthStateChanged(fbRef.current.auth, (u) => {
                        setUser(u);
                        if (u) {
                            setLoadingStatus(t('loading'));
                            loadData(u.uid);
                        } else {
                            setColumns(initialData.columns); setHabits(initialData.habits); setChainData(initialData.chainData); setChainTarget(initialData.chainTarget); setHabitExcuses(initialData.habitExcuses); setExcuses(initialData.excuses); setXpLog(initialData.xpLog); setLoading(false);
                        }
                    });
                } catch (e) {
                    console.error(e);
                    setLoading(false);
                }
            };

            const handleLogin = async () => { try { await fbRef.current.signInWithPopup(fbRef.current.auth, fbRef.current.googleProvider); } catch (e) { alert("Auth Error: " + e.message); } };
            const handleLogout = () => fbRef.current.signOut(fbRef.current.auth);

            const loadData = (uid) => {
                const { onSnapshot, doc, db } = fbRef.current;
                const docRef = doc(db, 'users', uid);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    // if (docSnap.metadata.hasPendingWrites) return; // Ignore local echoes to prevent reverb, trust local optimistic state

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setColumns(prev => data.columns || prev);
                        if (data.habits) setHabits(prev => data.habits || prev);
                        if (data.chainData) setChainData(prev => data.chainData || prev);
                        if (data.chainTarget) setChainTarget(prev => data.chainTarget || prev);
                        if (data.habitExcuses) setHabitExcuses(prev => data.habitExcuses || prev);
                        if (data.excuses) setExcuses(prev => ({ ...prev, ...data.excuses }));
                        if (data.pomodoroHistory) setPomodoroHistory(prev => data.pomodoroHistory || prev);
                        if (data.xpLog) setXpLog(prev => data.xpLog || prev);
                        if (data.archivedTasks) setArchivedTasks(prev => data.archivedTasks || prev);

                        // Cloud Sync for Settings
                        // Only apply cloud settings if we haven't made a local change recently (within 2 seconds)
                        // This prevents the sync loop where Firebase overwrites our local changes
                        const timeSinceLocalUpdate = Date.now() - lastLocalUpdate.current;
                        const shouldApplyCloudSettings = timeSinceLocalUpdate > 2000; // 2 second grace period

                        if (data.settings && shouldApplyCloudSettings) {
                            // Theme is synced from cloud but also respects local changes
                            if (data.settings.theme && shouldApplyCloudSettings) setTheme(data.settings.theme);
                            if (data.settings.alarmType) setAlarmType(data.settings.alarmType);
                            // Note: lang is NOT synced from cloud - it's device-specific (localStorage only)
                        }
                        // Note: workDur and breakDur are NO LONGER synced from cloud - they remain user-specific

                        setDataLoaded(true);
                    } else {
                        // New user - initialize with default data
                        // This assumes initialData is available in scope
                        fbRef.current.setDoc(docRef, { ...initialData, lastUpdated: new Date().toISOString() });
                        setDataLoaded(true);
                    }
                    setLoading(false);
                }, (err) => {
                    console.error("Firestore snapshot error:", err);
                    setLoading(false);
                });
                // Return unsubscribe function for cleanup if needed
                return unsubscribe;
            };

            // Event-Driven Save Helper
            const persistData = async (dataToUpdate) => {
                if (!user || !fbRef.current.db) return;

                // CRITICAL SAFETY GUARD: Do NOT save if data hasn't loaded yet.
                // This prevents empty state from overwriting cloud data on offline load.
                if (!dataLoaded) {
                    console.warn("ğŸš« Safety Stop: Attempted to save before data load completed.");
                    return;
                }

                try {
                    setAutoSaveStatus('saving');
                    lastLocalUpdate.current = Date.now();
                    const { updateDoc, setDoc, doc, db } = fbRef.current;
                    try {
                        await updateDoc(doc(db, 'users', user.uid), {
                            ...dataToUpdate,
                            lastUpdated: new Date().toISOString()
                        });
                    } catch (e) {
                        // Fallback for new documents
                        await setDoc(doc(db, 'users', user.uid), {
                            ...dataToUpdate,
                            lastUpdated: new Date().toISOString()
                        }, { merge: true });
                    }
                    setAutoSaveStatus('saved');
                } catch (e) {
                    console.error("Save Error", e);
                    setAutoSaveStatus('error');
                }
            };

            const getWeekNumber = (d) => {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return `${d.getUTCFullYear()}-W${weekNo}`;
            };
            const getDateKey = (d) => d.toISOString().split('T')[0];
            const formatDate = (dateStr, formatOpts = { day: 'numeric', month: 'long' }) => {
                if (!dateStr || dateStr === '-') return '-';
                const d = new Date(dateStr);
                const locale = lang === 'en' ? 'en-US' : lang === 'ar' ? 'ar-SA' : 'tr-TR';
                return d.toLocaleDateString(locale, formatOpts);
            };

            const calculations = useMemo(() => {
                let totalScore = 0; let maxGlobalStreak = 0;
                const todayKey = getDateKey(new Date());
                if (columns && columns.done) columns['done'].items.forEach(item => totalScore += (item.points || POINTS.TASK_DONE));

                // Find max streak among all daily habits
                let maxHabitStreak = 0;
                const habitsWithMaxStreak = (habits || []).map(h => {
                    let maxS = 0, currentRun = 0;
                    const dates = Object.keys(h.completedDays || {}).sort();
                    let lastDate = null;
                    for (let dStr of dates) {
                        const d = new Date(dStr);
                        if (lastDate) {
                            const diffDays = Math.ceil(Math.abs(d - lastDate) / (1000 * 60 * 60 * 24));
                            if (h.frequency === 'daily' && diffDays <= 1.5) currentRun++; else currentRun = 1;
                        } else currentRun = 1;
                        lastDate = d;
                        maxS = Math.max(maxS, currentRun);
                    }
                    if (h.frequency !== 'daily') maxS = Object.keys(h.completedDays || {}).length;
                    if (maxS > maxHabitStreak) maxHabitStreak = maxS;
                    Object.keys(h.completedDays || {}).forEach(() => {
                        if (h.frequency === 'daily') totalScore += POINTS.HABIT_DAILY;
                        if (h.frequency === 'weekly') totalScore += POINTS.HABIT_WEEKLY;
                        if (h.frequency === 'monthly') totalScore += POINTS.HABIT_MONTHLY;
                    });
                    return { ...h, maxStreakCalc: maxS };
                });
                // Chain streak calculation
                const chainMarkedCount = Object.keys(chainData || {}).length;
                const chainStreakMapCalc = calculateChainStreakMap(chainData);
                totalScore += calculateTotalChainPoints(chainData);
                // Find max chain streak
                let maxChainStreak = 0;
                let tempChainStreak = 0;
                let lastChainDate = null;
                Object.keys(chainData || {}).sort().forEach(dateKey => {
                    const d = new Date(dateKey);
                    if (lastChainDate) {
                        const diffDays = Math.round((d - lastChainDate) / (1000 * 60 * 60 * 24));
                        if (diffDays === 1) tempChainStreak++;
                        else tempChainStreak = 1;
                    } else tempChainStreak = 1;
                    lastChainDate = d;
                    if (tempChainStreak > maxChainStreak) maxChainStreak = tempChainStreak;
                });
                // Show the highest of all habit streaks and chain streaks as the record
                maxGlobalStreak = Math.max(maxHabitStreak, maxChainStreak);

                // Pomodoro detailed stats
                const pomodoroEntries = Object.entries(pomodoroHistory || {});
                const pomSessions = pomodoroEntries.reduce((sum, [, d]) => sum + (d.sessions || 1), 0);
                const pomTime = pomodoroEntries.reduce((sum, [, d]) => sum + (d.totalTime || 0), 0);
                const pomPoints = pomodoroEntries.reduce((sum, [, d]) => sum + (d.totalPoints || 0), 0);
                const pomDaysCount = pomodoroEntries.length;

                // This week pomodoro - Use Monday as week start
                const weekStart = new Date();
                const dayOfWeek = weekStart.getDay();
                const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday = 0 diff, Sunday = 6 diff
                weekStart.setDate(weekStart.getDate() - diff);
                weekStart.setHours(0, 0, 0, 0);
                const weekStartKey = getDateKey(weekStart);
                const pomThisWeek = pomodoroEntries.filter(([k]) => k >= weekStartKey);
                const pomTimeThisWeek = pomThisWeek.reduce((sum, [, d]) => sum + (d.totalTime || 0), 0);
                const pomSessionsThisWeek = pomThisWeek.reduce((sum, [, d]) => sum + (d.sessions || 1), 0);

                // Today pomodoro
                const todayPom = pomodoroHistory?.[todayKey];
                const pomTimeToday = todayPom?.totalTime || 0;
                const pomSessionsToday = todayPom?.sessions || (todayPom ? 1 : 0);

                // Average session length
                const avgSessionLength = pomSessions > 0 ? Math.round(pomTime / pomSessions / 60) : 0;

                // Best day (most time)
                let bestPomDay = { date: '-', time: 0 };
                pomodoroEntries.forEach(([dateKey, d]) => {
                    if ((d.totalTime || 0) > bestPomDay.time) {
                        bestPomDay = { date: dateKey, time: d.totalTime || 0 };
                    }
                });

                // Year Stats - Always visible
                const currentYear = new Date().getFullYear();
                const startOfYear = new Date(currentYear, 0, 1);
                const daysPassedInYear = Math.ceil((new Date() - startOfYear) / (1000 * 60 * 60 * 24));
                const chainDaysThisYear = Object.keys(chainData || {}).filter(k => k.startsWith(currentYear.toString())).length;

                // Chain year percentage
                const chainYearPercent = daysPassedInYear > 0 ? Math.round((chainDaysThisYear / daysPassedInYear) * 100) : 0;



                // Category Distribution - Both completed and all tasks
                const catDistCompleted = {};
                const catDistAll = {};

                // From habits (completed only)
                (habits || []).forEach(h => {
                    const cat = h.category || 'Genel';
                    const count = Object.keys(h.completedDays || {}).length;
                    if (count > 0) catDistCompleted[cat] = (catDistCompleted[cat] || 0) + count;
                });

                // From tasks - completed (done column)
                if (columns && columns.done) {
                    columns['done'].items.forEach(item => {
                        const t = item.tag || 'Genel';
                        catDistCompleted[t] = (catDistCompleted[t] || 0) + 1;
                    });
                }

                // From tasks - all (todo + inProgress + done)
                if (columns) {
                    ['todo', 'inProgress', 'done'].forEach(colKey => {
                        (columns[colKey]?.items || []).forEach(item => {
                            const t = item.tag || 'Genel';
                            catDistAll[t] = (catDistAll[t] || 0) + 1;
                        });
                    });
                }

                const pieDataCompleted = Object.keys(catDistCompleted).map((c, i) => ({
                    label: getCategoryName(c, lang),
                    value: catDistCompleted[c],
                    total: catDistAll[c] || catDistCompleted[c],
                    color: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'][i % 6]
                }));
                Object.values(pomodoroHistory || {}).forEach(d => totalScore += (d.totalPoints || 0));

                // Progressive Level Calculation
                let level = 1;
                let nextLevelXp = LEVEL_THRESHOLDS[1]; // Default to next level threshold
                let currentLevelThreshold = LEVEL_THRESHOLDS[0];

                for (let i = 0; i < LEVEL_THRESHOLDS.length; i++) {
                    if (totalScore >= LEVEL_THRESHOLDS[i]) {
                        level = i + 1;
                        currentLevelThreshold = LEVEL_THRESHOLDS[i];
                        if (i + 1 < LEVEL_THRESHOLDS.length) {
                            nextLevelXp = LEVEL_THRESHOLDS[i + 1];
                        } else {
                            // Max level reached
                            nextLevelXp = LEVEL_THRESHOLDS[i];
                        }
                    } else {
                        break;
                    }
                }
                if (level > 15) level = 15; // Hard cap

                // Calculate progress percentage
                let progress = 0;
                if (level < 15) {
                    const range = nextLevelXp - currentLevelThreshold;
                    const gained = totalScore - currentLevelThreshold;
                    progress = Math.min(100, Math.max(0, (gained / range) * 100));
                } else {
                    progress = 100; // Max level
                }

                const motivationalMessage = useMemo(() => {
                    const msgObj = LEVEL_MESSAGES[level] || LEVEL_MESSAGES[1];
                    return msgObj[lang] || msgObj['en'];
                }, [level, lang]);

                const activeHabits = habits || [];
                const habitsCompletedToday = activeHabits.filter(h => h.completedDays && h.completedDays[getDateKey(new Date())]).length;

                const weeklyScores = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i); const k = getDateKey(d);
                    const dayLabel = formatDate(k, { weekday: 'short' });
                    let dayPoints = 0;
                    (habits || []).filter(h => h.frequency === 'daily').forEach(h => { if (h.completedDays?.[k]) dayPoints += POINTS.HABIT_DAILY; });
                    if (chainData?.[k]) dayPoints += getChainPoints(chainStreakMapCalc[k] || 1);
                    if (columns && columns.done) columns['done'].items.forEach(item => { if (item.date === k) dayPoints += (item.points || POINTS.TASK_DONE); });
                    // Add pomodoro points for the day
                    if (pomodoroHistory?.[k]) dayPoints += (pomodoroHistory[k].totalPoints || 0);
                    weeklyScores.push({ label: dayLabel, value: dayPoints });
                }
                const catDist = {};
                (habits || []).forEach(h => { const count = Object.keys(h.completedDays || {}).length; if (count > 0) catDist[h.category] = (catDist[h.category] || 0) + count; });
                if (columns && columns.done) columns['done'].items.forEach(item => { const t = item.tag || 'Genel'; catDist[t] = (catDist[t] || 0) + 1; });
                const pieData = Object.keys(catDist).map((c, i) => ({ label: c, value: catDist[c], color: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'][i % 6] }));

                // ========== NEW: Simple Score Analysis ==========
                const calculateScoreForRange = (startKey, endKey) => {
                    let score = 0;
                    // Tasks
                    if (columns && columns.done) {
                        columns['done'].items.forEach(item => {
                            const itemDate = item.completedAt ? item.completedAt.split('T')[0] : item.date;
                            if (itemDate && itemDate >= startKey && itemDate <= endKey) {
                                score += (item.points || POINTS.TASK_DONE);
                            }
                        });
                    }
                    // Habits
                    (habits || []).forEach(h => {
                        Object.keys(h.completedDays || {}).forEach(dateKey => {
                            if (dateKey >= startKey && dateKey <= endKey) {
                                if (h.frequency === 'daily') score += POINTS.HABIT_DAILY;
                                if (h.frequency === 'weekly') score += POINTS.HABIT_WEEKLY;
                                if (h.frequency === 'monthly') score += POINTS.HABIT_MONTHLY;
                            }
                        });
                    });
                    // Chain
                    Object.keys(chainData || {}).forEach(dateKey => {
                        if (dateKey >= startKey && dateKey <= endKey) {
                            score += getChainPoints(chainStreakMapCalc[dateKey] || 1);
                        }
                    });
                    // Pomodoro
                    Object.entries(pomodoroHistory || {}).forEach(([dateKey, d]) => {
                        if (dateKey >= startKey && dateKey <= endKey) {
                            score += (d.totalPoints || 0);
                        }
                    });
                    return score;
                };

                // Calculate score for each period
                // Today
                const scoreToday = calculateScoreForRange(todayKey, todayKey);

                // This Week (Monday to Sunday)
                const scoreWeekStart = new Date();
                const scoreWeekDay = scoreWeekStart.getDay();
                const diffToMonday = scoreWeekDay === 0 ? 6 : scoreWeekDay - 1;
                scoreWeekStart.setDate(scoreWeekStart.getDate() - diffToMonday);
                const scoreWeekEnd = new Date(scoreWeekStart);
                scoreWeekEnd.setDate(scoreWeekStart.getDate() + 6);
                const scoreThisWeek = calculateScoreForRange(getDateKey(scoreWeekStart), getDateKey(scoreWeekEnd));

                // This Month
                const scoreMonthNow = new Date();
                const thisMonthStart = new Date(scoreMonthNow.getFullYear(), scoreMonthNow.getMonth(), 1);
                const thisMonthEnd = new Date(scoreMonthNow.getFullYear(), scoreMonthNow.getMonth() + 1, 0);
                const scoreThisMonth = calculateScoreForRange(getDateKey(thisMonthStart), getDateKey(thisMonthEnd));

                // This Year
                const scoreYearNow = new Date();
                const thisYearStart = new Date(scoreYearNow.getFullYear(), 0, 1);
                const thisYearEnd = new Date(scoreYearNow.getFullYear(), 11, 31);
                const scoreThisYear = calculateScoreForRange(getDateKey(thisYearStart), getDateKey(thisYearEnd));

                // All Time (use totalScore calculated earlier)
                // All Time: sum all completed tasks, habits, chains, pomodoro points (not period-based)
                let scoreAllTime = 0;
                // Tasks
                if (columns && columns.done) {
                    columns['done'].items.forEach(item => {
                        scoreAllTime += (item.points || POINTS.TASK_DONE);
                    });
                }
                // Habits
                (habits || []).forEach(h => {
                    Object.keys(h.completedDays || {}).forEach(() => {
                        if (h.frequency === 'daily') scoreAllTime += POINTS.HABIT_DAILY;
                        if (h.frequency === 'weekly') scoreAllTime += POINTS.HABIT_WEEKLY;
                        if (h.frequency === 'monthly') scoreAllTime += POINTS.HABIT_MONTHLY;
                    });
                });
                // Chain
                Object.keys(chainData || {}).forEach(dateKey => {
                    scoreAllTime += getChainPoints(chainStreakMapCalc[dateKey] || 1);
                });
                // Pomodoro
                Object.entries(pomodoroHistory || {}).forEach(([dateKey, d]) => {
                    scoreAllTime += (d.totalPoints || 0);
                });

                // Legacy support - keep old filteredScore working
                let filteredScore = 0; let periodLabel = t('all_time'); let startStr = "", endStr = "";
                if (statPeriod !== 'all') {
                    const start = new Date(statDate); const end = new Date(statDate);
                    if (statPeriod === 'daily') {
                        periodLabel = formatDate(start.toISOString(), { day: 'numeric', month: 'long', year: 'numeric' });
                    } else if (statPeriod === 'weekly') {
                        const day = start.getDay(); const diff = start.getDate() - day + (day == 0 ? -6 : 1);
                        start.setDate(diff); end.setDate(diff + 6);
                        periodLabel = `${formatDate(start.toISOString(), { day: 'numeric', month: 'short' })} - ${formatDate(end.toISOString(), { day: 'numeric', month: 'short' })}`;
                    } else if (statPeriod === 'monthly') {
                        start.setDate(1); end.setMonth(end.getMonth() + 1); end.setDate(0);
                        periodLabel = formatDate(start.toISOString(), { month: 'long', year: 'numeric' });
                    } else if (statPeriod === 'yearly') {
                        start.setMonth(0, 1); end.setMonth(11, 31);
                        periodLabel = start.getFullYear().toString();
                    }
                    startStr = getDateKey(start); endStr = getDateKey(end);
                    filteredScore = calculateScoreForRange(startStr, endStr);
                } else filteredScore = totalScore;

                const getStatRange = () => {
                    const start = new Date(statDate); const end = new Date(statDate);
                    if (statPeriod === 'daily') {
                        // Daily: start and end are same day
                    } else if (statPeriod === 'weekly') {
                        const day = start.getDay(); const diff = start.getDate() - day + (day == 0 ? -6 : 1);
                        start.setDate(diff); end.setDate(diff + 6);
                    } else if (statPeriod === 'monthly') {
                        start.setDate(1); end.setMonth(end.getMonth() + 1); end.setDate(0);
                    } else if (statPeriod === 'yearly') {
                        start.setMonth(0, 1); end.setMonth(11, 31);
                    }
                    const sStr = getDateKey(start); const eStr = getDateKey(end);
                    return { start, end, sStr, eStr };
                };
                const { start: rStart, end: rEnd, sStr: rangeStart, eStr: rangeEnd } = getStatRange();



                // 1. Habit Rate (Independent Filter)
                const getHabitStatRange = () => {
                    const start = new Date(habitStatDate); const end = new Date(habitStatDate);
                    if (habitStatPeriod === 'daily') {

                    } else if (habitStatPeriod === 'weekly') {
                        const day = start.getDay(); const diff = start.getDate() - day + (day == 0 ? -6 : 1);
                        start.setDate(diff); end.setDate(diff + 6);
                    } else if (habitStatPeriod === 'monthly') {
                        start.setDate(1); end.setMonth(end.getMonth() + 1); end.setDate(0);
                    } else if (habitStatPeriod === 'yearly') {
                        start.setMonth(0, 1); end.setMonth(11, 31);
                    }
                    const sStr = getDateKey(start); const eStr = getDateKey(end);

                    let label = "";
                    if (habitStatPeriod === 'daily') label = formatDate(start.toISOString());
                    else if (habitStatPeriod === 'weekly') label = `${formatDate(start.toISOString(), { day: 'numeric', month: 'short' })} - ${formatDate(end.toISOString(), { day: 'numeric', month: 'short' })}`;
                    else if (habitStatPeriod === 'monthly') label = formatDate(start.toISOString(), { month: 'long', year: 'numeric' });
                    else label = start.getFullYear();

                    return { sStr, eStr, start, end, label };
                };

                const { sStr: hStart, eStr: hEnd, start: hDateStart, end: hDateEnd, label: habitStatLabel } = getHabitStatRange();

                let habitRate = 0;
                let habitTotalExpected = 0;
                let habitTotalCompleted = 0;
                (habits || []).forEach(h => {
                    const daysInRange = Math.floor((hDateEnd - hDateStart) / (1000 * 60 * 60 * 24)) + 1;
                    let expected = 0;
                    if (h.frequency === 'daily') expected = daysInRange;
                    if (h.frequency === 'weekly') expected = Math.max(1, Math.ceil(daysInRange / 7));
                    if (h.frequency === 'monthly') expected = Math.max(1, Math.ceil(daysInRange / 30));

                    let completed = 0;
                    Object.keys(h.completedDays || {}).forEach(k => {
                        if (k >= hStart && k <= hEnd) completed++;
                    });
                    habitTotalExpected += expected;
                    habitTotalCompleted += completed;
                });
                habitRate = habitTotalExpected > 0 ? Math.round((habitTotalCompleted / habitTotalExpected) * 100) : 0;
                if (habitRate > 100) habitRate = 100;

                // ========== NEW: Separate Habit Success Calculations ==========

                // Helper function to calculate habit success for a specific frequency and date range
                const calcHabitSuccess = (freq, periodType, periodDate) => {
                    const start = new Date(periodDate);
                    const end = new Date(periodDate);

                    if (periodType === 'daily') {
                        // Single day
                    } else if (periodType === 'weekly') {
                        const day = start.getDay();
                        const diff = start.getDate() - day + (day === 0 ? -6 : 1);
                        start.setDate(diff);
                        end.setDate(diff + 6);
                    } else if (periodType === 'monthly') {
                        start.setDate(1);
                        end.setMonth(end.getMonth() + 1);
                        end.setDate(0);
                    } else if (periodType === 'yearly') {
                        start.setMonth(0, 1);
                        end.setMonth(11, 31);
                    }

                    const sStr = getDateKey(start);
                    const eStr = getDateKey(end);
                    const daysInRange = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;

                    let label = "";
                    if (periodType === 'daily') label = formatDate(start.toISOString());
                    else if (periodType === 'weekly') label = `${formatDate(start.toISOString(), { day: 'numeric', month: 'short' })} - ${formatDate(end.toISOString(), { day: 'numeric', month: 'short' })}`;
                    else if (periodType === 'monthly') label = formatDate(start.toISOString(), { month: 'long', year: 'numeric' });
                    else label = start.getFullYear();

                    let expected = 0;
                    let completed = 0;

                    (habits || []).filter(h => h.frequency === freq).forEach(h => {
                        // Calculate expected based on frequency and period
                        if (freq === 'daily') {
                            expected += daysInRange;
                        } else if (freq === 'weekly') {
                            expected += Math.max(1, Math.ceil(daysInRange / 7));
                        } else if (freq === 'monthly') {
                            expected += Math.max(1, Math.ceil(daysInRange / 30));
                        }

                        // Count completed
                        Object.keys(h.completedDays || {}).forEach(k => {
                            if (k >= sStr && k <= eStr) completed++;
                        });
                    });

                    const rate = expected > 0 ? Math.min(100, Math.round((completed / expected) * 100)) : 0;
                    return { rate, completed, expected, label, sStr, eStr, daysInRange };
                };

                // Daily habits success (filtered by dailyHabitStatPeriod and dailyHabitStatDate)
                const dailyHabitStats = calcHabitSuccess('daily', dailyHabitStatPeriod, dailyHabitStatDate);

                // Weekly habits success (filtered by weeklyHabitStatPeriod and weeklyHabitStatDate)
                const weeklyHabitStats = calcHabitSuccess('weekly', weeklyHabitStatPeriod, weeklyHabitStatDate);

                // Monthly habits success (filtered by monthlyHabitStatPeriod and monthlyHabitStatDate)
                const monthlyHabitStats = calcHabitSuccess('monthly', monthlyHabitStatPeriod, monthlyHabitStatDate);

                // ========== Lifetime/Overall Success Calculation ==========
                // This calculates the overall success since the user started using the app
                // Uses weighted average based on number of habits per type

                const dailyHabits = (habits || []).filter(h => h.frequency === 'daily');
                const weeklyHabits = (habits || []).filter(h => h.frequency === 'weekly');
                const monthlyHabits = (habits || []).filter(h => h.frequency === 'monthly');

                // Calculate lifetime success for each habit type
                const calcLifetimeSuccess = (habitList, freq) => {
                    if (habitList.length === 0) return { rate: 0, completed: 0, expected: 0 };

                    let totalCompleted = 0;
                    let totalExpected = 0;

                    habitList.forEach(h => {
                        const completedKeys = Object.keys(h.completedDays || {});
                        totalCompleted += completedKeys.length;

                        // Calculate expected: from first habit creation or first completion to today
                        if (completedKeys.length > 0) {
                            const sortedKeys = completedKeys.sort();
                            const firstKey = sortedKeys[0];
                            let firstDate;
                            const today = new Date();

                            if (freq === 'daily') {
                                // Daily format: "2024-06-15" (YYYY-MM-DD)
                                firstDate = new Date(firstKey);
                                const totalDays = Math.floor((today - firstDate) / (1000 * 60 * 60 * 24)) + 1;
                                totalExpected += totalDays;
                            } else if (freq === 'weekly') {
                                // Weekly format: "2024-W12" (YYYY-Www)
                                // Parse week number and calculate weeks since then
                                const match = firstKey.match(/(\d{4})-W(\d+)/);
                                if (match) {
                                    const firstYear = parseInt(match[1]);
                                    const firstWeek = parseInt(match[2]);
                                    const currentYear = today.getFullYear();
                                    const currentWeek = parseInt(getWeekNumber(today).split('-W')[1]);

                                    // Calculate total weeks between first and now
                                    const weeksSinceStart = ((currentYear - firstYear) * 52) + (currentWeek - firstWeek) + 1;
                                    totalExpected += Math.max(1, weeksSinceStart);
                                } else {
                                    // Fallback: just use completed count as expected
                                    totalExpected += completedKeys.length;
                                }
                            } else if (freq === 'monthly') {
                                // Monthly format: "2024-06" (YYYY-MM)
                                const match = firstKey.match(/(\d{4})-(\d{2})/);
                                if (match) {
                                    const firstYear = parseInt(match[1]);
                                    const firstMonth = parseInt(match[2]);
                                    const currentYear = today.getFullYear();
                                    const currentMonth = today.getMonth() + 1;

                                    // Calculate total months between first and now
                                    const monthsSinceStart = ((currentYear - firstYear) * 12) + (currentMonth - firstMonth) + 1;
                                    totalExpected += Math.max(1, monthsSinceStart);
                                } else {
                                    // Fallback: just use completed count as expected
                                    totalExpected += completedKeys.length;
                                }
                            }
                        }
                    });

                    const rate = totalExpected > 0 ? Math.min(100, Math.round((totalCompleted / totalExpected) * 100)) : 0;
                    return { rate, completed: totalCompleted, expected: totalExpected };
                };

                const dailyLifetime = calcLifetimeSuccess(dailyHabits, 'daily');
                const weeklyLifetime = calcLifetimeSuccess(weeklyHabits, 'weekly');
                const monthlyLifetime = calcLifetimeSuccess(monthlyHabits, 'monthly');

                // Overall weighted success (based on number of habits per type)
                const totalHabitCount = dailyHabits.length + weeklyHabits.length + monthlyHabits.length;
                let overallSuccessRate = 0;

                if (totalHabitCount > 0) {
                    const weightedSum =
                        (dailyLifetime.rate * dailyHabits.length) +
                        (weeklyLifetime.rate * weeklyHabits.length) +
                        (monthlyLifetime.rate * monthlyHabits.length);
                    overallSuccessRate = Math.round(weightedSum / totalHabitCount);
                }

                // ========== END NEW ==========

                // 2. Task Rate (Filtered)
                let totalTasks = 0;
                let doneCount = 0;
                let tasksByStatus = { todo: 0, inProgress: 0, done: 0 };
                let tasksByCategory = {};

                // Helper to get items safely
                const getItems = (cKey) => (columns && columns[cKey]) ? columns[cKey].items : [];

                ['todo', 'inProgress', 'done'].forEach(status => {
                    const items = getItems(status);
                    items.forEach(item => {
                        // Filter Logic
                        let include = true;
                        if (statPeriod !== 'all') {
                            if (!item.date) include = false;
                            else if (item.date < rangeStart || item.date > rangeEnd) include = false;
                        }

                        if (include) {
                            totalTasks++;
                            if (status === 'done') doneCount++;
                            tasksByStatus[status]++;
                            const cat = item.tag || 'Genel';
                            if (!tasksByCategory[cat]) tasksByCategory[cat] = { total: 0, done: 0 };
                            tasksByCategory[cat].total++;
                            if (status === 'done') tasksByCategory[cat].done++;
                        }
                    });
                });
                const taskRate = totalTasks > 0 ? Math.round((doneCount / totalTasks) * 100) : 0;

                // ========== NEW: Advanced Task Stats ==========
                // todayKey already defined at the start of calculations
                const now = new Date();

                // Calculate period ranges for task stats
                const getTaskStatRange = (period) => {
                    const today = new Date();
                    if (period === 'today') {
                        return { start: getDateKey(today), end: getDateKey(today) };
                    } else if (period === 'weekly') {
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        return { start: getDateKey(weekStart), end: getDateKey(weekEnd) };
                    } else if (period === 'monthly') {
                        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                        const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        return { start: getDateKey(monthStart), end: getDateKey(monthEnd) };
                    }
                    return { start: null, end: null }; // all
                };

                const taskPeriodRange = getTaskStatRange(taskStatPeriod);
                const prevTaskPeriodRange = (() => {
                    const today = new Date();
                    if (taskStatPeriod === 'today') {
                        const yesterday = new Date(today);
                        yesterday.setDate(today.getDate() - 1);
                        return { start: getDateKey(yesterday), end: getDateKey(yesterday) };
                    } else if (taskStatPeriod === 'weekly') {
                        const prevWeekStart = new Date(today);
                        prevWeekStart.setDate(today.getDate() - today.getDay() - 7);
                        const prevWeekEnd = new Date(prevWeekStart);
                        prevWeekEnd.setDate(prevWeekStart.getDate() + 6);
                        return { start: getDateKey(prevWeekStart), end: getDateKey(prevWeekEnd) };
                    } else if (taskStatPeriod === 'monthly') {
                        const prevMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        const prevMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                        return { start: getDateKey(prevMonthStart), end: getDateKey(prevMonthEnd) };
                    }
                    return { start: null, end: null };
                })();

                // Calculate detailed task stats
                let taskStatsFiltered = { total: 0, done: 0, todo: 0, inProgress: 0, onTime: 0, overdue: 0, byCategory: {} };
                let taskStatsPrev = { total: 0, done: 0 };
                let completedToday = 0;
                let taskDatesWithCompletion = new Set();

                const allTaskItems = [];
                ['todo', 'inProgress', 'done'].forEach(status => {
                    getItems(status).forEach(item => allTaskItems.push({ ...item, status }));
                });

                allTaskItems.forEach(item => {
                    const itemDate = item.date || '';
                    const dueDate = item.date || ''; // date is used as due date in this app
                    // For done items without completedAt, assume completed today (worst case for overdue check)
                    const completedDate = item.completedAt ? item.completedAt.split('T')[0] : (item.status === 'done' ? todayKey : '');

                    // Check if in current period
                    let inCurrentPeriod = true;
                    if (taskPeriodRange.start && taskPeriodRange.end) {
                        inCurrentPeriod = itemDate >= taskPeriodRange.start && itemDate <= taskPeriodRange.end;
                    }

                    // Check if in previous period
                    let inPrevPeriod = false;
                    if (prevTaskPeriodRange.start && prevTaskPeriodRange.end) {
                        inPrevPeriod = itemDate >= prevTaskPeriodRange.start && itemDate <= prevTaskPeriodRange.end;
                    }

                    if (inCurrentPeriod) {
                        taskStatsFiltered.total++;
                        taskStatsFiltered[item.status]++;

                        const cat = item.tag || 'Genel';
                        if (!taskStatsFiltered.byCategory[cat]) taskStatsFiltered.byCategory[cat] = { total: 0, done: 0 };
                        taskStatsFiltered.byCategory[cat].total++;

                        if (item.status === 'done') {
                            taskStatsFiltered.byCategory[cat].done++;
                            // Check if on time
                            if (dueDate && completedDate <= dueDate) {
                                taskStatsFiltered.onTime++;
                            } else if (!dueDate) {
                                taskStatsFiltered.onTime++; // No due date = on time
                            }
                            // Track completion dates for streak
                            if (completedDate) taskDatesWithCompletion.add(completedDate);
                        }

                        // Check overdue: not done + past due OR done but completed after due date
                        if (dueDate) {
                            if (item.status !== 'done' && dueDate < todayKey) {
                                // Not completed and past due date
                                taskStatsFiltered.overdue++;
                            } else if (item.status === 'done') {
                                // Completed - check if it was late
                                const completedAt = item.completedAt ? item.completedAt.split('T')[0] : completedDate;
                                if (completedAt > dueDate) {
                                    taskStatsFiltered.overdue++;
                                }
                            }
                        }
                    }

                    // Count completed today
                    if (item.status === 'done' && completedDate === todayKey) {
                        completedToday++;
                    }

                    // Previous period stats for trend
                    if (inPrevPeriod) {
                        taskStatsPrev.total++;
                        if (item.status === 'done') taskStatsPrev.done++;
                    }
                });

                // Task efficiency for selected period
                const taskEfficiencyRate = taskStatsFiltered.total > 0
                    ? Math.round((taskStatsFiltered.done / taskStatsFiltered.total) * 100) : 0;
                const prevTaskEfficiencyRate = taskStatsPrev.total > 0
                    ? Math.round((taskStatsPrev.done / taskStatsPrev.total) * 100) : 0;
                const taskTrend = taskEfficiencyRate - prevTaskEfficiencyRate;

                // On time percentage
                const onTimeRate = taskStatsFiltered.done > 0
                    ? Math.round((taskStatsFiltered.onTime / taskStatsFiltered.done) * 100) : 0;

                // Best category (highest efficiency with at least 1 task)
                let bestCategory = { name: '-', rate: 0 };
                Object.entries(taskStatsFiltered.byCategory).forEach(([cat, stats]) => {
                    if (stats.total > 0) {
                        const rate = Math.round((stats.done / stats.total) * 100);
                        if (rate > bestCategory.rate || (rate === bestCategory.rate && stats.done > 0)) {
                            bestCategory = { name: cat, rate, done: stats.done, total: stats.total };
                        }
                    }
                });

                // Task completion streak (consecutive days with at least 1 completion)
                let taskStreak = 0;
                let checkTaskDate = new Date();
                for (let i = 0; i < 365; i++) {
                    const checkKey = getDateKey(checkTaskDate);
                    if (taskDatesWithCompletion.has(checkKey)) {
                        taskStreak++;
                        checkTaskDate.setDate(checkTaskDate.getDate() - 1);
                    } else if (i === 0) {
                        // Check yesterday if today has no completions
                        checkTaskDate.setDate(checkTaskDate.getDate() - 1);
                    } else {
                        break;
                    }
                }
                // ========== END Task Stats ==========

                // ========== NEW: Category Activity Stats ==========
                const getCategoryStatRange = (period) => {
                    const today = new Date();
                    if (period === 'today') {
                        return { start: getDateKey(today), end: getDateKey(today) };
                    } else if (period === 'weekly') {
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        return { start: getDateKey(weekStart), end: getDateKey(weekEnd) };
                    } else if (period === 'monthly') {
                        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                        const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        return { start: getDateKey(monthStart), end: getDateKey(monthEnd) };
                    }
                    return { start: null, end: null }; // all
                };

                const catPeriodRange = getCategoryStatRange(categoryStatPeriod);

                // Build detailed category stats
                let categoryStats = {};
                let categoryTotals = { total: 0, done: 0, todo: 0, inProgress: 0, overdue: 0, habits: 0, habitsDone: 0 };

                allTaskItems.forEach(item => {
                    const itemDate = item.date || '';
                    const dueDate = item.date || ''; // date is used as due date

                    // Check if in category period
                    let inCatPeriod = true;
                    if (catPeriodRange.start && catPeriodRange.end) {
                        inCatPeriod = itemDate >= catPeriodRange.start && itemDate <= catPeriodRange.end;
                    }

                    if (inCatPeriod) {
                        const cat = item.tag || 'Genel';
                        if (!categoryStats[cat]) {
                            categoryStats[cat] = {
                                total: 0, done: 0, todo: 0, inProgress: 0,
                                overdue: 0, onTime: 0, avgPoints: 0, totalPoints: 0,
                                habits: 0, habitsDone: 0, habitRate: 0
                            };
                        }

                        categoryStats[cat].total++;
                        categoryStats[cat][item.status]++;
                        categoryStats[cat].totalPoints += (item.points || 0);
                        categoryTotals.total++;
                        categoryTotals[item.status]++;

                        // Check overdue: incomplete past due OR completed late
                        if (dueDate) {
                            const completedAt = item.completedAt ? item.completedAt.split('T')[0] : (item.status === 'done' ? todayKey : '');
                            if (item.status !== 'done' && dueDate < todayKey) {
                                categoryStats[cat].overdue++;
                                categoryTotals.overdue++;
                            } else if (item.status === 'done' && completedAt > dueDate) {
                                categoryStats[cat].overdue++;
                                categoryTotals.overdue++;
                            }
                        }

                        // Check on time (done before or on due date)
                        if (item.status === 'done') {
                            const completedDate = item.completedAt ? item.completedAt.split('T')[0] : todayKey;
                            if (!dueDate || completedDate <= dueDate) {
                                categoryStats[cat].onTime++;
                            }
                        }
                    }
                });

                // Calculate rates and find best/worst categories
                let bestCategoryStat = { name: '-', rate: 0, total: 0 };
                let worstCategoryStat = { name: '-', rate: 100, total: 0 };
                let activeCategoryCount = 0;

                Object.entries(categoryStats).forEach(([cat, stats]) => {
                    if (stats.total > 0) {
                        activeCategoryCount++;
                        stats.rate = Math.round((stats.done / stats.total) * 100);
                        stats.avgPoints = Math.round(stats.totalPoints / stats.total);
                        stats.onTimeRate = stats.done > 0 ? Math.round((stats.onTime / stats.done) * 100) : 0;

                        if (stats.rate > bestCategoryStat.rate || (stats.rate === bestCategoryStat.rate && stats.total > bestCategoryStat.total)) {
                            bestCategoryStat = { name: cat, rate: stats.rate, total: stats.total, done: stats.done };
                        }
                        if (stats.total >= 2 && (stats.rate < worstCategoryStat.rate || (stats.rate === worstCategoryStat.rate && stats.total > worstCategoryStat.total))) {
                            worstCategoryStat = { name: cat, rate: stats.rate, total: stats.total, done: stats.done };
                        }
                    }
                });

                // If no worst found with rate < 100, set to "-"
                if (worstCategoryStat.rate === 100) worstCategoryStat = { name: '-', rate: 0, total: 0 };

                const overallCategoryRate = categoryTotals.total > 0
                    ? Math.round((categoryTotals.done / categoryTotals.total) * 100) : 0;
                const avgTasksPerCategory = activeCategoryCount > 0
                    ? Math.round(categoryTotals.total / activeCategoryCount * 10) / 10 : 0;

                // Get period label for category stats
                const getCategoryPeriodLabel = () => {
                    const today = new Date();
                    if (categoryStatPeriod === 'today') {
                        return today.toLocaleDateString(lang === 'tr' ? 'tr-TR' : lang === 'ar' ? 'ar-SA' : 'en-US', { day: 'numeric', month: 'short' });
                    } else if (categoryStatPeriod === 'weekly') {
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        return `${weekStart.getDate()}/${weekStart.getMonth() + 1} - ${weekEnd.getDate()}/${weekEnd.getMonth() + 1}`;
                    } else if (categoryStatPeriod === 'monthly') {
                        return today.toLocaleDateString(lang === 'tr' ? 'tr-TR' : lang === 'ar' ? 'ar-SA' : 'en-US', { month: 'long', year: 'numeric' });
                    }
                    return t('all_time');
                };

                const categoryPeriodLabel = getCategoryPeriodLabel();

                // Add habits to category stats
                (habits || []).forEach(habit => {
                    const cat = habit.category || 'Genel';
                    if (!categoryStats[cat]) {
                        categoryStats[cat] = {
                            total: 0, done: 0, todo: 0, inProgress: 0,
                            overdue: 0, onTime: 0, avgPoints: 0, totalPoints: 0,
                            habits: 0, habitsDone: 0, habitRate: 0
                        };
                    }

                    categoryStats[cat].habits++;
                    categoryTotals.habits++;

                    // Count completed habits based on period
                    const completedKeys = Object.keys(habit.completedDays || {});
                    let periodCompleted = 0;
                    let periodExpected = 0;

                    if (categoryStatPeriod === 'today' && habit.frequency === 'daily') {
                        periodExpected = 1;
                        periodCompleted = habit.completedDays?.[todayKey] ? 1 : 0;
                    } else if (categoryStatPeriod === 'weekly') {
                        if (habit.frequency === 'daily') {
                            periodExpected = 7;
                            completedKeys.forEach(k => {
                                if (catPeriodRange.start && catPeriodRange.end && k >= catPeriodRange.start && k <= catPeriodRange.end) {
                                    periodCompleted++;
                                }
                            });
                        } else if (habit.frequency === 'weekly') {
                            periodExpected = 1;
                            const currentWeekKey = getWeekNumber(new Date());
                            periodCompleted = habit.completedDays?.[currentWeekKey] ? 1 : 0;
                        }
                    } else if (categoryStatPeriod === 'monthly') {
                        if (habit.frequency === 'daily') {
                            const today = new Date();
                            periodExpected = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                            completedKeys.forEach(k => {
                                if (catPeriodRange.start && catPeriodRange.end && k >= catPeriodRange.start && k <= catPeriodRange.end) {
                                    periodCompleted++;
                                }
                            });
                        } else if (habit.frequency === 'weekly') {
                            periodExpected = 4;
                            completedKeys.forEach(k => {
                                // Check if week key is in current month
                                const match = k.match(/(\d{4})-W(\d+)/);
                                if (match) {
                                    const weekYear = parseInt(match[1]);
                                    const today = new Date();
                                    if (weekYear === today.getFullYear()) {
                                        periodCompleted++;
                                    }
                                }
                            });
                        } else if (habit.frequency === 'monthly') {
                            periodExpected = 1;
                            const currentMonthKey = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
                            periodCompleted = habit.completedDays?.[currentMonthKey] ? 1 : 0;
                        }
                    } else {
                        // all time
                        periodCompleted = completedKeys.length;
                        periodExpected = completedKeys.length > 0 ? completedKeys.length : 1; // At least show what they completed
                    }

                    categoryStats[cat].habitsDone += periodCompleted;
                    categoryTotals.habitsDone += periodCompleted;
                });

                // Calculate habit rate per category
                Object.values(categoryStats).forEach(stats => {
                    if (stats.habits > 0) {
                        stats.habitRate = stats.habitsDone > 0 ? Math.min(100, Math.round((stats.habitsDone / stats.habits) * 100)) : 0;
                    }
                });

                // ========== CATEGORY HEAT MAP DATA ==========
                // Build a 4-week heat map for each category
                const categoryHeatMap = {};
                const heatMapCategories = new Set();
                const heatMapDays = [];

                // Generate last 28 days (4 weeks)
                for (let i = 27; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    heatMapDays.push({
                        key: getDateKey(d),
                        day: d.getDate(),
                        weekday: d.getDay(),
                        month: d.getMonth()
                    });
                }

                // Initialize heat map data structure
                heatMapDays.forEach(day => {
                    categoryHeatMap[day.key] = {};
                });

                // Populate with tasks
                allTaskItems.forEach(item => {
                    const itemDate = item.date || '';
                    const completedDate = item.completedAt ? item.completedAt.split('T')[0] : (item.status === 'done' ? itemDate : '');
                    const cat = item.tag || 'Genel';
                    heatMapCategories.add(cat);

                    if (categoryHeatMap[itemDate]) {
                        if (!categoryHeatMap[itemDate][cat]) {
                            categoryHeatMap[itemDate][cat] = { total: 0, done: 0, points: 0 };
                        }
                        categoryHeatMap[itemDate][cat].total++;
                        categoryHeatMap[itemDate][cat].points += (item.points || 0);
                        if (item.status === 'done') {
                            categoryHeatMap[itemDate][cat].done++;
                        }
                    }

                    // Also count completion date if different
                    if (completedDate && completedDate !== itemDate && categoryHeatMap[completedDate]) {
                        if (!categoryHeatMap[completedDate][cat]) {
                            categoryHeatMap[completedDate][cat] = { total: 0, done: 0, points: 0 };
                        }
                        if (item.status === 'done') {
                            categoryHeatMap[completedDate][cat].done++;
                        }
                    }
                });

                // Add habit completions to heat map
                (habits || []).forEach(habit => {
                    const cat = habit.category || 'Genel';
                    heatMapCategories.add(cat);
                    const completedKeys = Object.keys(habit.completedDays || {});

                    completedKeys.forEach(k => {
                        // Only daily habits have day-level keys
                        if (habit.frequency === 'daily' && categoryHeatMap[k]) {
                            if (!categoryHeatMap[k][cat]) {
                                categoryHeatMap[k][cat] = { total: 0, done: 0, points: 0, habits: 0 };
                            }
                            categoryHeatMap[k][cat].habits = (categoryHeatMap[k][cat].habits || 0) + 1;
                            categoryHeatMap[k][cat].done++;
                            categoryHeatMap[k][cat].points += POINTS.HABIT_DAILY;
                        }
                    });
                });

                // Calculate heat intensity (0-4 levels based on activity)
                const getHeatLevel = (dayData, cat) => {
                    if (!dayData || !dayData[cat]) return 0;
                    const data = dayData[cat];
                    const activity = data.done + (data.habits || 0);
                    if (activity === 0) return 0;
                    if (activity === 1) return 1;
                    if (activity <= 3) return 2;
                    if (activity <= 5) return 3;
                    return 4;
                };

                // Category summary for heat map
                const categoryHeatSummary = {};
                Array.from(heatMapCategories).forEach(cat => {
                    let totalActivity = 0;
                    let activeDays = 0;
                    let totalPoints = 0;
                    let bestDay = { date: null, count: 0 };
                    let currentStreak = 0;
                    let maxStreak = 0;
                    let tempStreak = 0;

                    heatMapDays.forEach((day, idx) => {
                        const dayData = categoryHeatMap[day.key]?.[cat];
                        if (dayData) {
                            const activity = dayData.done + (dayData.habits || 0);
                            if (activity > 0) {
                                totalActivity += activity;
                                activeDays++;
                                totalPoints += dayData.points || 0;

                                if (activity > bestDay.count) {
                                    bestDay = { date: day.key, count: activity };
                                }

                                tempStreak++;
                                if (tempStreak > maxStreak) maxStreak = tempStreak;
                            } else {
                                tempStreak = 0;
                            }
                        } else {
                            tempStreak = 0;
                        }
                    });

                    // Current streak (from today backwards)
                    for (let i = heatMapDays.length - 1; i >= 0; i--) {
                        const day = heatMapDays[i];
                        const dayData = categoryHeatMap[day.key]?.[cat];
                        if (dayData && (dayData.done + (dayData.habits || 0)) > 0) {
                            currentStreak++;
                        } else {
                            break;
                        }
                    }

                    categoryHeatSummary[cat] = {
                        totalActivity,
                        activeDays,
                        totalPoints,
                        avgPerDay: activeDays > 0 ? Math.round(totalActivity / activeDays * 10) / 10 : 0,
                        bestDay,
                        currentStreak,
                        maxStreak,
                        coverage: Math.round((activeDays / 28) * 100)
                    };
                });

                // Sort categories by total activity
                const sortedHeatCategories = Array.from(heatMapCategories).sort((a, b) => {
                    return (categoryHeatSummary[b]?.totalActivity || 0) - (categoryHeatSummary[a]?.totalActivity || 0);
                });

                // ========== END Category Heat Map ==========

                // ========== END Category Stats ==========

                // 3. Chain Streak Logic (Restored)
                const chainDates = Object.keys(chainData || {}).sort();
                let bestChainStreak = 0;
                let currentChainStreak = 0;
                let tempStreak = 0;
                let lastDate = null;

                if (chainDates.length > 0) {
                    // Best Streak
                    chainDates.forEach((dateStr) => {
                        const d = new Date(dateStr);
                        if (lastDate) {
                            const diff = (d - lastDate) / (1000 * 60 * 60 * 24);
                            if (diff === 1) tempStreak++;
                            else tempStreak = 1;
                        } else {
                            tempStreak = 1;
                        }
                        if (tempStreak > bestChainStreak) bestChainStreak = tempStreak;
                        lastDate = d;
                    });

                    // Current Streak
                    // Check backwards from today
                    let checkDate = new Date();
                    // If today is marked, start from today. If not, check yesterday.
                    if (!chainData[getDateKey(checkDate)]) {
                        checkDate.setDate(checkDate.getDate() - 1);
                    }
                    if (chainData[getDateKey(checkDate)]) {
                        currentChainStreak = 1;
                        for (let i = 1; i < 365; i++) {
                            checkDate.setDate(checkDate.getDate() - 1);
                            if (chainData[getDateKey(checkDate)]) currentChainStreak++;
                            else break;
                        }
                    }
                }

                return {
                    totalScore, level, progress, weeklyScores, nextLevelXp,
                    pieData: pieDataCompleted,
                    maxGlobalStreak: bestChainStreak,
                    habitsWithStats: habitsWithMaxStreak,
                    chainMarkedCount,
                    filteredScore, periodLabel,
                    // New simple score analysis
                    scoreToday, scoreThisWeek, scoreThisMonth, scoreThisYear, scoreAllTime,
                    habitRate, taskRate,
                    currentChainStreak,
                    bestChainStreak,
                    motivationalMessage, // Changed from motivationMsg
                    totalTasks, doneCount,
                    activeHabitsCount: activeHabits.length,
                    habitsCompletedToday,
                    chainMarkedYear: chainDaysThisYear,
                    pomodoroHours: Math.round(pomTime / 360) / 10,
                    pomSessions,
                    pomPoints,
                    pomDaysCount,
                    pomTimeThisWeek,
                    pomSessionsThisWeek,
                    pomTimeToday,
                    pomSessionsToday,
                    avgSessionLength,
                    bestPomDay,
                    daysPassedInYear,
                    chainDaysThisYear,
                    chainYearPercent,
                    rangeStart,
                    rangeEnd,
                    tasksByStatus,
                    tasksByCategory,
                    habitStatLabel,
                    // New: Separate habit success stats
                    dailyHabitStats,
                    weeklyHabitStats,
                    monthlyHabitStats,
                    // Lifetime/Overall
                    dailyLifetime,
                    weeklyLifetime,
                    monthlyLifetime,
                    overallSuccessRate,
                    dailyHabitsCount: dailyHabits.length,
                    weeklyHabitsCount: weeklyHabits.length,
                    monthlyHabitsCount: monthlyHabits.length,
                    // Advanced Task Stats
                    taskStatsFiltered,
                    taskEfficiencyRate,
                    taskTrend,
                    prevTaskEfficiencyRate,
                    onTimeRate,
                    bestCategory,
                    taskStreak,
                    completedToday,
                    taskStatsPrev,
                    // Category Activity Stats
                    categoryStats,
                    categoryTotals,
                    bestCategoryStat,
                    worstCategoryStat,
                    overallCategoryRate,
                    avgTasksPerCategory,
                    activeCategoryCount,
                    categoryPeriodLabel,
                    // Category Heat Map
                    categoryHeatMap,
                    heatMapDays,
                    sortedHeatCategories,
                    categoryHeatSummary,
                    getHeatLevel
                };
            }, [columns, habits, chainData, statPeriod, statDate, habitStatPeriod, habitStatDate,
                dailyHabitStatPeriod, dailyHabitStatDate, weeklyHabitStatPeriod, weeklyHabitStatDate,
                monthlyHabitStatPeriod, monthlyHabitStatDate, taskStatPeriod, categoryStatPeriod,
                lang, pomodoroHistory, t]);

            // Scroll Lock Effect for Modals
            useEffect(() => {
                const anyModalOpen = showProfileModal || levelInfoModalOpen; // Add other modals if needed
                if (anyModalOpen) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = 'unset';
                }
                return () => { document.body.style.overflow = 'unset'; };
            }, [showProfileModal, levelInfoModalOpen]);

            // Auto-Sync XP to Firestore (Enhanced with time-based scores)
            useEffect(() => {
                if (!user || !user.uid || !leaderboardUser) return;
                // Debounce slightly to avoid rapid writes
                const timer = setTimeout(() => {
                    // Check if local score differs significantly from last known remote score
                    if (calculations.totalScore !== leaderboardUser.totalScore) {
                        console.log("ğŸ”„ Syncing XP to Leaderboard...", calculations.totalScore);
                        try {
                            const { db, updateDoc, doc } = fbRef.current || {};
                            if (db && updateDoc && doc) {
                                // Update Firestore with time-based scores
                                const userRef = doc(db, "users", user.uid);
                                updateDoc(userRef, {
                                    totalScore: calculations.totalScore,
                                    level: calculations.level,
                                    scoreToday: calculations.scoreToday || 0,
                                    scoreWeek: calculations.scoreThisWeek || 0,
                                    scoreMonth: calculations.scoreThisMonth || 0,
                                    scoreYear: calculations.scoreThisYear || 0,
                                }).catch(e => console.error("Auto-sync failed", e));
                            }
                        } catch (err) {
                            console.error("Sync error", err);
                        }
                    }
                }, 2000); // 2 second debounce

                return () => clearTimeout(timer);
            }, [calculations.totalScore, calculations.level, calculations.scoreToday, calculations.scoreThisWeek, user, leaderboardUser]);

            // Shift functions for each habit type
            const shiftDailyHabitStatDate = (amt) => {
                const d = new Date(dailyHabitStatDate);
                if (dailyHabitStatPeriod === 'daily') d.setDate(d.getDate() + amt);
                else if (dailyHabitStatPeriod === 'weekly') d.setDate(d.getDate() + amt * 7);
                else if (dailyHabitStatPeriod === 'monthly') d.setMonth(d.getMonth() + amt);
                else if (dailyHabitStatPeriod === 'yearly') d.setFullYear(d.getFullYear() + amt);
                setDailyHabitStatDate(d);
            };

            const shiftWeeklyHabitStatDate = (amt) => {
                const d = new Date(weeklyHabitStatDate);
                if (weeklyHabitStatPeriod === 'weekly') d.setDate(d.getDate() + amt * 7);
                else if (weeklyHabitStatPeriod === 'monthly') d.setMonth(d.getMonth() + amt);
                else if (weeklyHabitStatPeriod === 'yearly') d.setFullYear(d.getFullYear() + amt);
                setWeeklyHabitStatDate(d);
            };

            const shiftMonthlyHabitStatDate = (amt) => {
                const d = new Date(monthlyHabitStatDate);
                if (monthlyHabitStatPeriod === 'monthly') d.setMonth(d.getMonth() + amt);
                else if (monthlyHabitStatPeriod === 'yearly') d.setFullYear(d.getFullYear() + amt);
                setMonthlyHabitStatDate(d);
            };

            const shiftAllHabitStatDate = (amt) => {
                const d = new Date(allHabitStatDate);
                if (allHabitStatPeriod === 'daily') d.setDate(d.getDate() + amt);
                else if (allHabitStatPeriod === 'weekly') d.setDate(d.getDate() + amt * 7);
                else if (allHabitStatPeriod === 'monthly') d.setMonth(d.getMonth() + amt);
                else if (allHabitStatPeriod === 'yearly') d.setFullYear(d.getFullYear() + amt);
                setAllHabitStatDate(d);
            };

            const shiftHabitStatDate = (amt) => { const d = new Date(habitStatDate); if (habitStatPeriod === 'weekly') d.setDate(d.getDate() + amt * 7); else if (habitStatPeriod === 'monthly') d.setMonth(d.getMonth() + amt); else if (habitStatPeriod === 'yearly') d.setFullYear(d.getFullYear() + amt); else d.setDate(d.getDate() + amt); setHabitStatDate(d); };

            const viewInfo = useMemo(() => {
                const start = new Date(habitViewDate);
                if (habitTab === 'daily') {
                    const day = start.getDay(); const diff = start.getDate() - day + (day == 0 ? -6 : 1);
                    const monday = new Date(start.setDate(diff)); const days = [];
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(monday); d.setDate(monday.getDate() + i);
                        days.push({ fullDate: formatDate(d.toISOString(), { day: 'numeric', month: 'short' }), shortName: formatDate(d.toISOString(), { weekday: 'short' }), dateKey: getDateKey(d), dayNum: d.getDate() });
                    }
                    return { days, label: `${days[0].fullDate} - ${days[6].fullDate}` };
                } else if (habitTab === 'weekly') {
                    // Calculate week start and end dates
                    const weekStart = new Date(start);
                    const day = weekStart.getDay();
                    const diff = weekStart.getDate() - day + (day == 0 ? -6 : 1);
                    weekStart.setDate(diff);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    const weekNum = getWeekNumber(habitViewDate);
                    const startDate = formatDate(weekStart.toISOString(), { day: 'numeric', month: 'short' });
                    const endDate = formatDate(weekEnd.toISOString(), { day: 'numeric', month: 'short' });
                    return { label: `${startDate} - ${endDate}`, currentKey: weekNum };
                } else { return { label: formatDate(start.toISOString(), { month: 'long', year: 'numeric' }), currentKey: `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}` }; }
            }, [habitViewDate, habitTab, lang, t]);

            const shiftDate = (amt) => { const d = new Date(habitViewDate); if (habitTab === 'daily') d.setDate(d.getDate() + amt * 7); else if (habitTab === 'weekly') d.setDate(d.getDate() + amt * 7); else d.setMonth(d.getMonth() + amt); setHabitViewDate(d); };
            const shiftStatDate = (amt) => { const d = new Date(statDate); if (statPeriod === 'weekly') d.setDate(d.getDate() + amt * 7); else if (statPeriod === 'monthly') d.setMonth(d.getMonth() + amt); else d.setFullYear(d.getFullYear() + amt); setStatDate(d); };

            const handleDragStart = (e, item, sourceId) => { setDraggedItem(item); setDraggedSource(sourceId); };
            const handleDrop = (e, targetId) => {
                if (!draggedItem || !draggedSource || draggedSource === targetId) return;
                const sCol = columns[draggedSource], tCol = columns[targetId];

                // Add completedAt timestamp when moving to done
                let itemToAdd = { ...draggedItem };
                if (targetId === 'done' && draggedSource !== 'done') {
                    itemToAdd.completedAt = new Date().toISOString();
                } else if (targetId !== 'done') {
                    // Remove completedAt if moving out of done
                    delete itemToAdd.completedAt;
                }

                const newItems = [...tCol.items, itemToAdd].sort((a, b) => (new Date(a.date || '9999-12-31') - new Date(b.date || '9999-12-31')));
                const newColumns = { ...columns, [draggedSource]: { ...sCol, items: sCol.items.filter(i => i.id !== draggedItem.id) }, [targetId]: { ...tCol, items: newItems } };
                setColumns(newColumns);
                persistData({ columns: newColumns });

                // XP Log kaydÄ± - done'a taÅŸÄ±ndÄ±ÄŸÄ±nda ekle
                if (targetId === 'done' && draggedSource !== 'done') {
                    const points = draggedItem.points || POINTS.TASK_DONE;
                    addXpLog('task', points, {
                        title: draggedItem.title,
                        category: draggedItem.tag || 'Genel'
                    });
                }
                // XP Log silme - done'dan Ã§Ä±karÄ±ldÄ±ÄŸÄ±nda sil
                if (draggedSource === 'done' && targetId !== 'done') {
                    removeXpLog('task', { title: draggedItem.title });
                }
                setDraggedItem(null);
            };
            const openAddModal = (colId) => { setModalColId(colId); setEditingTask(null); setTaskModalOpen(true); };
            const openEditModal = (colId, task) => { setModalColId(colId); setEditingTask(task); setTaskModalOpen(true); };
            const handleSaveTask = (title, tag, date, points) => {
                if (!title || !modalColId) return;
                const col = columns[modalColId];
                if (!col) return; // Safety check
                let newItems;
                if (editingTask) newItems = col.items.map(item => item.id === editingTask.id ? { ...item, title, tag, date, points } : item);
                else newItems = [...col.items, { id: Date.now().toString(), title, tag: tag || 'Genel', tagColor: 'bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-200', date: date || '', points: points || 15 }];
                newItems.sort((a, b) => (new Date(a.date || '9999-12-31') - new Date(b.date || '9999-12-31')));
                const newColumns = { ...columns, [modalColId]: { ...col, items: newItems } };
                setColumns(newColumns);
                persistData({ columns: newColumns });
            };
            const moveItem = (itemId, fromColId, direction) => {
                const colOrder = ['todo', 'inProgress', 'done']; const currIdx = colOrder.indexOf(fromColId);
                const nextIdx = direction === 'next' ? currIdx + 1 : currIdx - 1;
                if (nextIdx < 0 || nextIdx >= colOrder.length) return;
                const toColId = colOrder[nextIdx]; const sCol = columns[fromColId]; const tCol = columns[toColId]; const item = sCol.items.find(i => i.id === itemId); if (!item) return;

                // Add completedAt timestamp when moving to done
                let itemToMove = { ...item };
                if (toColId === 'done' && fromColId !== 'done') {
                    itemToMove.completedAt = new Date().toISOString();
                } else if (toColId !== 'done') {
                    delete itemToMove.completedAt;
                }

                const newColumns = { ...columns, [fromColId]: { ...sCol, items: sCol.items.filter(i => i.id !== itemId) }, [toColId]: { ...tCol, items: [...tCol.items, itemToMove].sort((a, b) => (new Date(a.date || '9999-12-31') - new Date(b.date || '9999-12-31'))) } };
                setColumns(newColumns);
                persistData({ columns: newColumns });
                // XP Log kaydÄ± - done'a taÅŸÄ±ndÄ±ÄŸÄ±nda ekle
                if (toColId === 'done' && fromColId !== 'done') {
                    const points = item.points || POINTS.TASK_DONE;
                    addXpLog('task', points, {
                        title: item.title,
                        category: item.tag || 'Genel'
                    });
                }
                // XP Log silme - done'dan Ã§Ä±karÄ±ldÄ±ÄŸÄ±nda sil
                if (fromColId === 'done' && toColId !== 'done') {
                    removeXpLog('task', { title: item.title });
                }
            };
            const deleteItem = (cId, iId) => {
                if (confirm(t('delete_confirm'))) {
                    // Find the item before deleting to remove its XP log if it was done
                    const item = columns[cId]?.items.find(i => i.id === iId);
                    if (item && cId === 'done') {
                        removeXpLog('task', { title: item.title });
                    }
                    const newColumns = { ...columns, [cId]: { ...columns[cId], items: columns[cId].items.filter(i => i.id !== iId) } };
                    setColumns(newColumns);
                    persistData({ columns: newColumns });
                }
            };

            // Archive functions
            const archiveTask = (item) => {
                const archivedItem = { ...item, archivedAt: new Date().toISOString() };
                const newArchived = [archivedItem, ...archivedTasks];
                const newColumns = { ...columns, done: { ...columns.done, items: columns.done.items.filter(i => i.id !== item.id) } };
                setArchivedTasks(newArchived);
                setColumns(newColumns);
                persistData({ archivedTasks: newArchived, columns: newColumns });
            };

            const archiveAllDone = () => {
                if (!columns.done.items.length) return;
                if (!confirm(t('archive_all_confirm'))) return;
                const now = new Date().toISOString();
                const itemsToArchive = columns.done.items.map(item => ({ ...item, archivedAt: now }));
                const newArchived = [...itemsToArchive, ...archivedTasks];
                const newColumns = { ...columns, done: { ...columns.done, items: [] } };
                setArchivedTasks(newArchived);
                setColumns(newColumns);
                persistData({ archivedTasks: newArchived, columns: newColumns });
            };

            const restoreFromArchive = (item) => {
                const newArchived = archivedTasks.filter(i => i.id !== item.id);
                const restoredItem = { ...item };
                delete restoredItem.archivedAt;
                const newColumns = { ...columns, done: { ...columns.done, items: [...columns.done.items, restoredItem] } };
                setArchivedTasks(newArchived);
                setColumns(newColumns);
                persistData({ archivedTasks: newArchived, columns: newColumns });
            };

            const deleteFromArchive = (id) => {
                if (!confirm(t('delete_confirm'))) return;
                const newArchived = archivedTasks.filter(i => i.id !== id);
                setArchivedTasks(newArchived);
                persistData({ archivedTasks: newArchived });
            };

            const clearArchive = () => {
                if (!confirm(t('clear_archive_confirm'))) return;
                setArchivedTasks([]);
                persistData({ archivedTasks: [] });
            };

            const openHabitModal = (freq) => { setHabitModalFreq(freq); setEditingHabit(null); setHabitModalOpen(true); };
            const openEditHabitModal = (habit) => { setEditingHabit(habit); setHabitModalFreq(habit.frequency); setHabitModalOpen(true); };
            const handleSaveHabit = (title, category) => {
                if (!title) return;
                let newHabits;
                if (editingHabit) {
                    newHabits = habits.map(h => h.id === editingHabit.id ? { ...h, title, category } : h);
                } else {
                    newHabits = [...habits, { id: Date.now(), title, category, frequency: habitModalFreq, completedDays: {} }];
                }
                setHabits(newHabits);
                persistData({ habits: newHabits });
            };
            const toggleHabit = (habitId, periodKey) => {
                const habit = habits.find(h => h.id === habitId);
                if (!habit) return;

                // Block future dates/periods
                const now = new Date();
                const todayKey = getDateKey(now);
                const currentWeek = getWeekNumber(now);
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

                if (habit.frequency === 'daily' && periodKey > todayKey) {
                    return; // Can't complete future days
                } else if (habit.frequency === 'weekly' && periodKey > currentWeek) {
                    return; // Can't complete future weeks
                } else if (habit.frequency === 'monthly' && periodKey > currentMonth) {
                    return; // Can't complete future months
                }

                const wasCompleted = habit?.completedDays?.[periodKey];

                setHabits(prevHabits => {
                    const newHabits = prevHabits.map(h => {
                        if (h.id === habitId) {
                            const n = { ...h.completedDays };
                            if (n[periodKey]) delete n[periodKey]; else n[periodKey] = true;
                            return { ...h, completedDays: n };
                        }
                        return h;
                    });
                    persistData({ habits: newHabits });
                    return newHabits;
                });

                if (habit) {
                    const points = habit.frequency === 'daily' ? POINTS.HABIT_DAILY :
                        habit.frequency === 'weekly' ? POINTS.HABIT_WEEKLY : POINTS.HABIT_MONTHLY;

                    if (!wasCompleted) {
                        // XP Log kaydÄ± - tamamlandÄ±ÄŸÄ±nda ekle
                        addXpLog('habit', points, {
                            title: habit.title,
                            category: habit.category || 'Genel',
                            frequency: habit.frequency
                        });
                    } else {
                        // XP Log silme - tamamlama kaldÄ±rÄ±ldÄ±ÄŸÄ±nda sil
                        removeXpLog('habit', {
                            title: habit.title,
                            frequency: habit.frequency,
                            date: getDateKey(new Date())
                        });
                    }
                }
            };
            const deleteHabit = (id) => {
                if (confirm(t('delete_confirm'))) {
                    const habit = habits.find(h => h.id === id);
                    // Remove all XP logs for this habit
                    if (habit) {
                        setXpLog(prev => {
                            const newLog = prev.filter(entry =>
                                !(entry.source === 'habit' && entry.title === habit.title)
                            );
                            persistData({ xpLog: newLog });
                            return newLog;
                        });
                    }
                    const newHabits = habits.filter(h => h.id !== id);
                    setHabits(newHabits);
                    persistData({ habits: newHabits });
                }
            };
            const calculateCombo = (habit) => { if (habit.frequency !== 'daily') return 0; let streak = 0; const today = new Date(); for (let i = 0; i < 365; i++) { const d = new Date(today); d.setDate(d.getDate() - i); if (habit.completedDays?.[getDateKey(d)]) streak++; else { if (i === 0) continue; break; } } return streak; };

            // Universal Excuse functions
            const openExcuseModal = (type, id, dateKey, title, dateText) => {
                // type: 'habit', 'task', 'chain'
                let existing = '';
                if (type === 'habit') {
                    existing = habitExcuses[id]?.[dateKey] || excuses.habits?.[id]?.[dateKey] || '';
                } else if (type === 'task') {
                    existing = excuses.tasks?.[id] || '';
                } else if (type === 'chain') {
                    existing = excuses.chain?.[dateKey] || '';
                }
                setExcuseModalData({ type, id, dateKey, title, dateText, initialValue: existing });
                setExcuseModalOpen(true);
            };

            const handleSaveExcuse = (excuseText) => {
                const { type, id, dateKey } = excuseModalData;

                if (type === 'habit') {
                    // Legacy habitExcuses support + new excuses
                    const newHabitExcuses = {
                        ...habitExcuses,
                        [id]: {
                            ...(habitExcuses[id] || {}),
                            [dateKey]: excuseText
                        }
                    };
                    setHabitExcuses(newHabitExcuses);

                    const newExcuses = {
                        ...excuses,
                        habits: {
                            ...excuses.habits,
                            [id]: {
                                ...(excuses.habits?.[id] || {}),
                                [dateKey]: excuseText
                            }
                        }
                    };
                    setExcuses(newExcuses);
                    persistData({ habitExcuses: newHabitExcuses, excuses: newExcuses });
                } else if (type === 'task') {
                    const newExcuses = {
                        ...excuses,
                        tasks: {
                            ...excuses.tasks,
                            [id]: excuseText
                        }
                    };
                    setExcuses(newExcuses);
                    persistData({ excuses: newExcuses });
                } else if (type === 'chain') {
                    const newExcuses = {
                        ...excuses,
                        chain: {
                            ...excuses.chain,
                            [dateKey]: excuseText
                        }
                    };
                    setExcuses(newExcuses);
                    persistData({ excuses: newExcuses });
                }
            };

            const handleDeleteExcuse = () => {
                const { type, id, dateKey } = excuseModalData;

                if (type === 'habit') {
                    // Delete from habitExcuses (legacy)
                    const newHabitExcuses = { ...habitExcuses };
                    if (newHabitExcuses[id]) {
                        const newDates = { ...newHabitExcuses[id] };
                        delete newDates[dateKey];
                        if (Object.keys(newDates).length === 0) {
                            delete newHabitExcuses[id];
                        } else {
                            newHabitExcuses[id] = newDates;
                        }
                    }
                    setHabitExcuses(newHabitExcuses);

                    // Delete from excuses
                    const newExcuses = { ...excuses };
                    if (newExcuses.habits?.[id]) {
                        const newDates = { ...newExcuses.habits[id] };
                        delete newDates[dateKey];
                        if (Object.keys(newDates).length === 0) {
                            delete newExcuses.habits[id];
                        } else {
                            newExcuses.habits[id] = newDates;
                        }
                    }
                    setExcuses(newExcuses);
                    persistData({ habitExcuses: newHabitExcuses, excuses: newExcuses });
                } else if (type === 'task') {
                    const newExcuses = { ...excuses };
                    if (newExcuses.tasks) {
                        delete newExcuses.tasks[id];
                    }
                    setExcuses(newExcuses);
                    persistData({ excuses: newExcuses });
                } else if (type === 'chain') {
                    const newExcuses = { ...excuses };
                    if (newExcuses.chain) {
                        delete newExcuses.chain[dateKey];
                    }
                    setExcuses(newExcuses);
                    persistData({ excuses: newExcuses });
                }
            };

            const toggleChainDay = (d) => {
                // Prevent marking future dates
                const todayKey = getDateKey(new Date());
                if (d > todayKey) {
                    return; // Don't allow marking future dates
                }

                const wasMarked = chainData[d];

                // Calculate what the streak will be for this day if we mark it
                let newStreakDay = 1;
                if (!wasMarked) {
                    const prevDate = new Date(d);
                    prevDate.setDate(prevDate.getDate() - 1);
                    const prevKey = getDateKey(prevDate);
                    const currentStreakMap = calculateChainStreakMap(chainData);
                    if (currentStreakMap[prevKey]) {
                        newStreakDay = currentStreakMap[prevKey] + 1;
                    }
                }

                // If unmarking a day, we need to recalculate XP for all days after this one
                // because the chain is broken and streaks change
                if (wasMarked) {
                    // Get all marked dates after this one
                    const affectedDates = Object.keys(chainData).filter(date => date > d).sort();

                    // Remove XP logs for this day and all affected days
                    setXpLog(prev => {
                        const newLog = prev.filter(entry => {
                            if (entry.source !== 'chain') return true;
                            // Remove the current day and all days after
                            return entry.date < d;
                        });

                        // Calculate new streak map without the removed day
                        const newChainData = { ...chainData };
                        delete newChainData[d];
                        const newStreakMap = calculateChainStreakMap(newChainData);

                        // Re-add XP logs for affected days with correct streak values
                        affectedDates.forEach(dateKey => {
                            if (newChainData[dateKey]) {
                                const streakVal = newStreakMap[dateKey] || 1;
                                const points = getChainPoints(streakVal);
                                newLog.push({
                                    id: Date.now() + Math.random(),
                                    source: 'chain',
                                    points: points,
                                    date: dateKey,
                                    streakDay: streakVal,
                                    timestamp: new Date().toISOString()
                                });
                            }
                        });

                        persistData({ xpLog: newLog });
                        return newLog;
                    });

                    // Update chain data
                    setChainData(prevChain => {
                        const newChainData = { ...prevChain };
                        delete newChainData[d];
                        persistData({ chainData: newChainData });
                        return newChainData;
                    });
                } else {
                    // Marking a new day
                    // Check if this day connects two chains (both prev and next day are marked)
                    const prevDate = new Date(d);
                    prevDate.setDate(prevDate.getDate() - 1);
                    const prevKey = getDateKey(prevDate);

                    const nextDate = new Date(d);
                    nextDate.setDate(nextDate.getDate() + 1);
                    const nextKey = getDateKey(nextDate);

                    const connectsChains = chainData[prevKey] && chainData[nextKey];

                    // Update chain data first
                    const newChainData = { ...chainData, [d]: true };
                    setChainData(newChainData);
                    persistData({ chainData: newChainData });

                    if (connectsChains) {
                        // This day connects two chains - recalculate all XP logs for days from this one onwards
                        const affectedDates = Object.keys(newChainData).filter(date => date >= d).sort();
                        const newStreakMap = calculateChainStreakMap(newChainData);

                        setXpLog(prev => {
                            // Remove old logs for affected dates
                            const newLog = prev.filter(entry => {
                                if (entry.source !== 'chain') return true;
                                return entry.date < d;
                            });

                            // Add new logs with correct streak values
                            const now = Date.now();
                            affectedDates.forEach((dateKey, idx) => {
                                const streakVal = newStreakMap[dateKey] || 1;
                                const points = getChainPoints(streakVal);
                                newLog.push({
                                    id: now + idx + Math.random(),
                                    source: 'chain',
                                    points: points,
                                    date: dateKey,
                                    streakDay: streakVal,
                                    timestamp: new Date(now + idx).toISOString()
                                });
                            });

                            persistData({ xpLog: newLog });
                            return newLog;
                        });
                    } else {
                        // Simple case - just add this day's XP
                        const points = getChainPoints(newStreakDay);
                        addXpLog('chain', points, { date: d, streakDay: newStreakDay });
                    }
                }
            };

            // Calculate streak for every single date to determine heat color
            const chainStreakMap = useMemo(() => {
                const map = {};
                const dates = Object.keys(chainData).sort();
                if (dates.length === 0) return map;

                // We need to iterate through all possible relevant dates to handle gaps correctly?
                // Actually, we only care about marked dates having a streak value.
                // But if we want to show heat, we need the specific value for THAT day.

                // Simple approach: For every marked date, looking back is expensive if not improved.
                // Better: Iterate sorted dates.

                dates.forEach(dateStr => {
                    const d = new Date(dateStr);
                    const prevD = new Date(d);
                    prevD.setDate(d.getDate() - 1);
                    const prevKey = getDateKey(prevD);

                    if (map[prevKey]) {
                        map[dateStr] = map[prevKey] + 1;
                    } else {
                        map[dateStr] = 1;
                    }
                });
                return map;
            }, [chainData]);

            const getHeatStyle = (streak) => {
                if (!streak) return {
                    className: 'bg-gray-100 dark:bg-slate-800 text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-700'
                };

                if (streak >= 100) {
                    return {
                        className: 'bg-rose-600 text-white shadow-lg ring-2 ring-orange-400 shadow-orange-500/50 animate-pulse'
                    };
                }

                // Smooth HSL Transition: 
                // Start Green (Hue 120) -> Yellow (Hue 60) -> Red (0)
                // We'll map streak 1-60 to Hue 120-0
                const maxDays = 60;
                const ratio = Math.min(streak, maxDays) / maxDays;
                // hue starts at 120 (Green), goes to 0 (Red)
                const hue = 120 - (ratio * 120);

                return {
                    style: { backgroundColor: `hsl(${hue}, 85%, 45%)`, color: 'white' },
                    className: 'shadow-sm text-white'
                };
            };

            // XP Log System - Her XP kazanÄ±mÄ±nÄ± kaydet
            const addXpLog = (source, points, details = {}) => {
                const logEntry = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    date: getDateKey(new Date()),
                    source, // 'task', 'habit', 'chain', 'pomodoro'
                    points,
                    ...details // title, category, frequency, duration vb.
                };
                setXpLog(prev => {
                    const newLog = [logEntry, ...prev].slice(0, 1000); // Son 1000 kayÄ±t
                    persistData({ xpLog: newLog });
                    return newLog;
                });
            };

            // XP Log Silme - Aksyon geri alÄ±ndÄ±ÄŸÄ±nda
            const removeXpLog = (source, matchDetails = {}) => {
                setXpLog(prev => {
                    // En son eklenen matching log'u bul ve sil
                    const idx = prev.findIndex(entry => {
                        if (entry.source !== source) return false;
                        // Match based on source type
                        if (entry.source === 'habit') {
                            return entry.title === matchDetails.title &&
                                entry.frequency === matchDetails.frequency &&
                                entry.date === matchDetails.date;
                        } else if (entry.source === 'task') {
                            return entry.title === matchDetails.title;
                        } else if (entry.source === 'chain') {
                            return entry.date === matchDetails.date;
                        }
                        return false;
                    });

                    if (idx !== -1) {
                        const newLog = [...prev];
                        newLog.splice(idx, 1);
                        persistData({ xpLog: newLog });
                        return newLog;
                    }
                    return prev;
                });
            };

            const handlePomodoroComplete = (seconds, points) => {
                const today = getDateKey(new Date());
                setPomodoroHistory(prev => {
                    const p = { ...prev };
                    if (!p[today]) p[today] = { totalTime: 0, totalPoints: 0 };
                    p[today].totalTime += seconds;
                    p[today].totalPoints += points;
                    persistData({ pomodoroHistory: p });
                    return p;
                });
                // XP Log kaydÄ±
                addXpLog('pomodoro', points, { duration: Math.round(seconds / 60) });
            };

            if (moduleLoadError) return <div className="h-screen flex items-center justify-center p-6 text-center bg-[#F4F5F7] dark:bg-dark-bg text-red-600 dark:text-red-400">{t('connection_error')}</div>;




            if (moduleLoadError) return <div className="h-screen flex items-center justify-center p-6 text-center bg-[#F4F5F7] dark:bg-dark-bg text-red-600 dark:text-red-400">{t('connection_error')}</div>;

            if (loading || !minLoadingTime) return (
                <div className="h-screen flex flex-col items-center justify-center bg-[#F4F5F7] dark:bg-dark-bg transition-colors duration-300">
                    <IradahSpinner />
                    <div className="text-blue-600 dark:text-blue-400 font-bold mt-4 text-sm tracking-widest uppercase opacity-80 animate-pulse">{t('loading')}</div>
                </div>
            );

            if (!user) return (
                <div className="h-screen flex flex-col items-center justify-center bg-white dark:bg-dark-bg p-6">
                    <div className="w-24 h-24 mb-6">
                        <img src="assets/logo.ico" alt="Iradah Logo" className="w-full h-full object-contain" />
                    </div>
                    <h1 className="text-2xl font-bold text-slate-800 dark:text-white mb-2">{t('welcome')}</h1>
                    <p className="text-gray-500 dark:text-gray-400 text-center mb-8 max-w-xs italic">{t('slogan')}</p>
                    <button onClick={handleLogin} className="flex items-center gap-3 bg-white dark:bg-dark-card border border-gray-300 dark:border-slate-700 text-gray-700 dark:text-white px-6 py-3 rounded-xl font-bold hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors shadow-sm"><div className="w-5 h-5 rounded-full border-2 border-green-500"></div> {t('login_google')}</button>
                </div>
            );

            return (
                <div className="min-h-screen bg-[#F4F5F7] dark:bg-dark-bg font-sans text-slate-700 dark:text-dark-text flex flex-col transition-colors duration-300">
                    <ErrorBoundary>
                        {/* Offline Warning Banner */}
                        {!isOnline && (
                            <div className="fixed top-0 left-0 right-0 bg-red-600 text-white py-3 px-4 z-[100] shadow-lg animate-slide-down">
                                <div className="flex items-center justify-center gap-3 max-w-4xl mx-auto">
                                    <svg className="w-6 h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"></path>
                                    </svg>
                                    <div className="text-center">
                                        <div className="font-bold text-sm">{t('offline_warning')}</div>
                                        <div className="text-xs opacity-90">{t('offline_message')}</div>
                                        <div className="mt-2 opacity-30 transform scale-75">
                                            <IradahSpinner />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <TaskModal isOpen={taskModalOpen} onClose={() => setTaskModalOpen(false)} onSave={handleSaveTask} initialData={editingTask} t={t} lang={lang} columnId={modalColId} />
                        <HabitModal isOpen={habitModalOpen} onClose={() => setHabitModalOpen(false)} onSave={handleSaveHabit} frequency={habitModalFreq} initialData={editingHabit} t={t} lang={lang} />
                        <ExcuseModal
                            isOpen={excuseModalOpen}
                            onClose={() => setExcuseModalOpen(false)}
                            onSave={handleSaveExcuse}
                            onDelete={handleDeleteExcuse}
                            title={excuseModalData.title}
                            dateText={excuseModalData.dateText}
                            initialValue={excuseModalData.initialValue}
                            excuseType={excuseModalData.type}
                            t={t}
                        />
                        <XpLogModal
                            isOpen={xpLogModalOpen}
                            onClose={() => setXpLogModalOpen(false)}
                            xpLog={xpLog}
                            t={t}
                            lang={lang}
                            getCategoryColor={getCategoryColor}
                            translateCategory={translateCategory}
                        />

                        {/* Profile Setup Modal */}
                        <ProfileSetupModal
                            isOpen={showProfileModal}
                            onClose={(result) => {
                                setShowProfileModal(false);
                                if (result?.joined) {
                                    // Make sure we have the latest score
                                    const score = xpLog.reduce((acc, curr) => acc + (curr.points || 0), 0);
                                    setLeaderboardUser({
                                        nickname: result.nickname,
                                        avatar: result.avatar,
                                        totalScore: score,
                                        maxCombo: calculations.maxGlobalStreak || 0,
                                        joinedAt: new Date().toISOString()
                                    });
                                } else if (leaderboardUser && result === false) {
                                    // Left
                                    const checkProfile = async () => {
                                        try {
                                            const { doc, getDoc } = window.firebaseModules;
                                            const snap = await getDoc(doc(fbRef.current.db, "users", user.uid));
                                            if (snap.exists() && !snap.data().nickname) {
                                                setLeaderboardUser(null);
                                            }
                                        } catch (e) { }
                                    };
                                    checkProfile();
                                } else if (result?.skipped) {
                                    // Skipped: Set a local dummy user to prevent modal from opening again immediately
                                    // But DO NOT populate joinedAt, so tabs remain hidden
                                    setLeaderboardUser({
                                        nickname: "Guest-" + Math.floor(Math.random() * 10000),
                                        avatar: "ğŸ‘¤",
                                        isSkipped: true
                                    });
                                }
                            }}
                            user={user}
                            fbRef={fbRef}
                            t={t}
                            initialData={leaderboardUser}
                        />

                        {/* Archive Modal */}
                        {showArchive && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowArchive(false)}>
                                <div className="bg-white dark:bg-dark-card rounded-2xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                                    <div className="p-4 border-b border-gray-200 dark:border-dark-border flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            <Icon name="Archive" size={20} className="text-amber-500" />
                                            <h2 className="font-bold text-lg text-slate-800 dark:text-white">{t('archive')}</h2>
                                            <span className="bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 text-xs px-2 py-0.5 rounded-full font-bold">{archivedTasks.length}</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            {archivedTasks.length > 0 && (
                                                <button onClick={() => clearArchive()} className="text-xs text-red-500 hover:text-red-600 font-medium px-2 py-1 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors">
                                                    {t('clear_archive')}
                                                </button>
                                            )}
                                            <button onClick={() => setShowArchive(false)} className="p-1.5 text-gray-400 hover:text-gray-600 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg">
                                                <Icon name="X" size={18} />
                                            </button>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                        {archivedTasks.length === 0 ? (
                                            <div className="text-center py-12 text-gray-400 dark:text-slate-500">
                                                <Icon name="Archive" size={48} className="mx-auto mb-3 opacity-50" />
                                                <p>{t('no_archived_tasks')}</p>
                                            </div>
                                        ) : (
                                            archivedTasks.map(item => (
                                                <div key={item.id} className="bg-gray-50 dark:bg-slate-800 p-3 rounded-lg border border-gray-100 dark:border-slate-700">
                                                    <div className="flex items-start justify-between gap-2">
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded uppercase ${item.tagColor || 'bg-gray-200 dark:bg-slate-600 text-gray-600 dark:text-slate-300'}`}>{translateCategory(item.tag)}</span>
                                                                <span className="text-[10px] font-bold bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 px-1.5 py-0.5 rounded">{item.points || 15} XP</span>
                                                            </div>
                                                            <h4 className="text-sm font-semibold text-slate-700 dark:text-white truncate">{item.title}</h4>
                                                            {item.archivedAt && (
                                                                <p className="text-[10px] text-gray-400 dark:text-slate-500 mt-1">
                                                                    {t('archived_on')}: {new Date(item.archivedAt).toLocaleDateString(lang === 'tr' ? 'tr-TR' : lang === 'ar' ? 'ar-SA' : 'en-US')}
                                                                </p>
                                                            )}
                                                        </div>
                                                        <div className="flex items-center gap-1 shrink-0">
                                                            <button onClick={() => restoreFromArchive(item)} className="p-1.5 text-gray-400 hover:text-green-600 dark:hover:text-green-400 hover:bg-green-50 dark:hover:bg-slate-700 rounded transition-colors" title={t('restore')}>
                                                                <Icon name="RotateCcw" size={14} />
                                                            </button>
                                                            <button onClick={() => deleteFromArchive(item.id)} className="p-1.5 text-gray-400 hover:text-white hover:bg-red-500 rounded transition-colors" title={t('delete')}>
                                                                <Icon name="Trash2" size={14} />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white dark:bg-dark-card border-b border-gray-200 dark:border-dark-border px-4 py-4 flex flex-col md:flex-row justify-between items-center sticky top-0 z-30 shadow-sm gap-4 transition-colors duration-300">
                            <div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
                                <div className="flex items-center gap-2 font-bold text-xl text-blue-600 dark:text-blue-400">
                                    <img src="assets/logo.ico" alt="Iradah Logo" className="w-10 h-10 md:w-14 md:h-14 lg:w-16 lg:h-16 object-contain" />
                                    <span>Iradah</span>
                                </div>
                                <div className="hidden md:flex bg-gray-100 dark:bg-slate-900 p-1 rounded-lg overflow-x-auto no-scrollbar">
                                    {['board', 'habits', 'chain', 'pomodoro', 'stats', 'leaderboard'].filter(tab => tab !== 'leaderboard' || leaderboardUser?.joinedAt).map(tab => (
                                        <button key={tab} onClick={() => setActiveTab(tab)} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all capitalize whitespace-nowrap ${activeTab === tab ? 'bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-400 shadow-sm' : 'text-gray-500 dark:text-slate-400'}`}>{t(tab)}</button>
                                    ))}
                                </div>
                            </div>
                            <div className="flex flex-wrap items-center justify-center gap-2 w-full md:w-auto">
                                {/* Theme Toggle Switch */}
                                <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="relative w-14 h-7 rounded-full bg-gray-200 dark:bg-slate-700 transition-colors flex items-center px-1 shadow-inner focus:outline-none group">
                                    <div className={`absolute left-1.5 top-1/2 -translate-y-1/2 transition-opacity duration-300 z-20 pointer-events-none ${theme === 'light' ? 'opacity-100' : 'opacity-0'}`}><Icon name="Sun" size={16} className="text-yellow-500" /></div>
                                    <div className={`absolute right-1.5 top-1/2 -translate-y-1/2 transition-opacity duration-300 z-20 pointer-events-none ${theme === 'dark' ? 'opacity-100' : 'opacity-0'}`}><Icon name="Moon" size={16} className="text-blue-300" /></div>
                                    <div className={`w-5 h-5 rounded-full bg-white shadow-md transform transition-transform duration-300 z-10 ${theme === 'dark' ? 'translate-x-7' : 'translate-x-0'}`}></div>
                                </button>

                                {/* Language Dropdown */}
                                <div className="relative group">
                                    <select value={lang} onChange={(e) => setLang(e.target.value)} className="appearance-none bg-gray-100 dark:bg-slate-900 border border-gray-200 dark:border-slate-800 text-slate-700 dark:text-gray-300 py-1.5 pl-3 pr-8 rounded-lg text-xs font-bold uppercase cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500/20 hover:bg-gray-200 dark:hover:bg-slate-800 transition-colors">
                                        <option value="tr">TR</option>
                                        <option value="en">EN</option>
                                        <option value="ar">AR</option>
                                    </select>
                                    <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-200 transition-colors">
                                        <Icon name="ChevronDown" size={14} />
                                    </div>
                                </div>
                                <div className="bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-400 px-3 py-1 rounded-full text-xs font-bold border border-yellow-200 dark:border-yellow-800 flex items-center gap-1 cursor-pointer hover:bg-yellow-100 dark:hover:bg-yellow-900/40 transition-colors" onClick={() => setXpLogModalOpen(true)} title={t('xp_log')}>
                                    <Icon name="Zap" size={14} className="fill-yellow-500 text-yellow-500 dark:text-yellow-400" />
                                    <span className="hidden sm:inline">{t('level')}</span> {calculations.level} <span className="text-yellow-400">|</span> <span>{calculations.totalScore} XP</span>
                                </div>
                                <div className="bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400 px-3 py-1 rounded-full text-xs font-bold border border-orange-200 dark:border-orange-800 flex items-center gap-1">
                                    <Icon name="Flame" size={14} className="fill-orange-500 text-orange-500 dark:text-orange-400" />
                                    <span className="hidden sm:inline">{t('record')}:</span> {calculations.maxGlobalStreak}
                                </div>

                                <button onClick={handleLogout} className="text-gray-400 hover:text-red-500 ml-2" title={t('logout')}><Icon name="LogOut" size={20} /></button>
                            </div>
                        </div>

                        <div className="p-3 sm:p-4 md:p-8 flex-1 overflow-auto pb-28 md:pb-24">
                            {activeTab === 'board' && (
                                <div className="flex gap-4 sm:gap-6 h-full overflow-x-auto pb-4 snap-x snap-mandatory sm:snap-none max-w-7xl mx-auto">
                                    {['todo', 'inProgress', 'done'].map(colId => {
                                        const col = columns[colId];
                                        return (
                                            <div key={col.id} onDragOver={e => e.preventDefault()} onDrop={e => handleDrop(e, col.id)} className="w-[85vw] sm:w-80 lg:flex-1 lg:max-w-md shrink-0 bg-gray-100/80 dark:bg-slate-900/50 rounded-xl p-3 min-h-[500px] snap-center border dark:border-slate-800">
                                                <div className="flex justify-between items-center mb-4 px-1">
                                                    <div className="flex items-center gap-2">
                                                        <h2 className="font-semibold text-slate-700 dark:text-slate-200">{t(col.id)}</h2>
                                                        <span className="bg-gray-200 dark:bg-slate-700 text-xs px-2 py-0.5 rounded-full font-bold text-gray-600 dark:text-slate-300">{col.items.length}</span>
                                                    </div>
                                                    {col.id === 'done' && (
                                                        <div className="flex items-center gap-1">
                                                            {col.items.length > 0 && (
                                                                <button onClick={() => archiveAllDone()} className="p-1.5 text-gray-400 hover:text-amber-600 dark:hover:text-amber-400 hover:bg-amber-50 dark:hover:bg-slate-700 rounded transition-colors" title={t('archive_all')}>
                                                                    <Icon name="Archive" size={16} />
                                                                </button>
                                                            )}
                                                            <button onClick={() => setShowArchive(!showArchive)} className={`p-1.5 rounded transition-colors ${showArchive ? 'text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/30' : 'text-gray-400 hover:text-amber-600 dark:hover:text-amber-400 hover:bg-amber-50 dark:hover:bg-slate-700'}`} title={t('archive')}>
                                                                <Icon name="FolderOpen" size={16} />
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="space-y-3">
                                                    {col.items.map(item => {
                                                        const isLate = item.date && new Date(item.date) < new Date().setHours(0, 0, 0, 0) && col.id !== 'done';
                                                        const hasTaskExcuse = excuses.tasks?.[item.id];
                                                        return (
                                                            <div key={item.id} draggable onDragStart={e => handleDragStart(e, item, col.id)} className={`bg-white dark:bg-dark-card p-4 rounded-lg shadow-sm cursor-grab active:cursor-grabbing relative group border border-transparent hover:border-blue-200 dark:hover:border-blue-700 transition-all ${isLate ? 'border-l-4 border-l-red-500' : ''}`}>
                                                                <div className="absolute top-2 right-2 flex gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    {/* Excuse button for late tasks */}
                                                                    {isLate && (
                                                                        <button
                                                                            onClick={() => openExcuseModal('task', item.id, item.date, item.title, formatDate(item.date))}
                                                                            className={`p-1.5 rounded transition-colors ${hasTaskExcuse ? 'text-orange-500 hover:text-orange-600 bg-orange-50 dark:bg-orange-900/30' : 'text-gray-400 hover:text-orange-500 hover:bg-orange-50 dark:hover:bg-slate-700'}`}
                                                                            title={t('add_excuse')}
                                                                        >
                                                                            <Icon name="FileText" size={14} />
                                                                        </button>
                                                                    )}
                                                                    {col.id === 'done' && (
                                                                        <button onClick={() => archiveTask(item)} className="p-1.5 text-gray-400 hover:text-amber-600 dark:hover:text-amber-400 hover:bg-amber-50 dark:hover:bg-slate-700 rounded transition-colors" title={t('archive_task')}>
                                                                            <Icon name="Archive" size={14} />
                                                                        </button>
                                                                    )}
                                                                    <button onClick={() => openEditModal(col.id, item)} className="p-1.5 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-700 rounded"><Icon name="Edit" size={14} /></button>
                                                                    <button onClick={() => deleteItem(col.id, item.id)} className="p-1.5 text-gray-400 hover:text-white hover:bg-red-500 rounded transition-colors"><Icon name="Trash2" size={14} /></button>
                                                                </div>
                                                                <div className="flex items-center gap-2 mb-2 pr-16">
                                                                    <span className={`text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider ${item.tagColor || 'bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300'}`}>{translateCategory(item.tag)}</span>
                                                                    <span className="text-[10px] font-bold bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 px-1.5 py-0.5 rounded">{item.points || 15} XP</span>
                                                                    {hasTaskExcuse && <span className="text-[10px]" title={hasTaskExcuse}>ğŸ“</span>}
                                                                </div>
                                                                <h3 className="text-sm font-semibold text-slate-800 dark:text-white leading-snug mb-2">{item.title}</h3>
                                                                {item.date && (<div className={`flex items-center gap-1 text-xs font-medium ${isLate ? 'text-red-500' : 'text-gray-400 dark:text-slate-500'}`}><Icon name="Calendar" size={12} /> {formatDate(item.date)}</div>)}
                                                                <div className="flex justify-between mt-3 pt-2 border-t border-gray-50 dark:border-slate-700">
                                                                    {col.id !== 'todo' ? <button onClick={() => moveItem(item.id, col.id, 'prev')} className="text-xs font-bold text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 flex items-center gap-1 p-1"><Icon name={lang === 'ar' ? 'ChevronRight' : 'ChevronLeft'} size={14} /> {col.id === 'done' ? t('inProgress') : t('todo')}</button> : <div></div>}
                                                                    {col.id !== 'done' ? <button onClick={() => moveItem(item.id, col.id, 'next')} className={`text-xs font-bold flex items-center gap-1 p-1 px-2 rounded-lg transition-all ${col.id === 'inProgress' ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 hover:bg-green-200' : 'text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-800'}`}>{col.id === 'todo' ? t('inProgress') : t('completed')} <Icon name={lang === 'ar' ? 'ChevronLeft' : 'ChevronRight'} size={14} /></button> : <div></div>}
                                                                </div>
                                                            </div>
                                                        )
                                                    })}
                                                    <button onClick={() => openAddModal(col.id)} className="w-full mt-2 flex items-center justify-center gap-2 text-gray-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-800 p-2.5 rounded-lg text-sm font-medium transition-all border border-dashed border-gray-300 dark:border-slate-700 hover:border-blue-300"><Icon name="Plus" size={16} /> {t('add_card')}</button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {activeTab === 'habits' && (
                                <div className="max-w-7xl mx-auto space-y-6">
                                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                        <div className="bg-white dark:bg-dark-card p-1 rounded-xl shadow-sm border border-gray-200 dark:border-dark-border inline-flex w-full md:w-auto overflow-x-auto">
                                            {['daily', 'weekly', 'monthly'].map(tkey => (
                                                <button key={tkey} onClick={() => setHabitTab(tkey)} className={`flex-1 md:flex-none px-4 md:px-6 py-2 rounded-lg text-sm font-bold transition-all ${habitTab === tkey ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500 dark:text-slate-400 hover:bg-gray-50 dark:hover:bg-slate-700'}`}>{t(tkey)}</button>
                                            ))}
                                        </div>
                                        <div className="flex items-center gap-2 bg-white dark:bg-dark-card px-3 py-2 rounded-xl shadow-sm border border-gray-200 dark:border-dark-border w-full md:w-auto">
                                            <button onClick={() => shiftDate(-1)} className="p-1.5 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg text-gray-500 dark:text-slate-400 shrink-0"><Icon name={lang === 'ar' ? 'ChevronRight' : 'ChevronLeft'} size={18} /></button>
                                            <div className="flex-1 md:flex-none text-center md:min-w-[180px]">
                                                <span className="font-bold text-xs md:text-sm text-slate-700 dark:text-white flex items-center justify-center gap-2"><Icon name="Calendar" size={14} className="text-blue-500 shrink-0" /><span className="truncate">{viewInfo.label}</span></span>
                                            </div>
                                            <button onClick={() => shiftDate(1)} className="p-1.5 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg text-gray-500 dark:text-slate-400 shrink-0"><Icon name={lang === 'ar' ? 'ChevronLeft' : 'ChevronRight'} size={18} /></button>
                                            <div className="w-px h-6 bg-gray-200 dark:bg-slate-700 shrink-0"></div>
                                            <button onClick={() => setHabitViewDate(new Date())} className="p-1.5 hover:bg-blue-50 dark:hover:bg-slate-700 text-blue-600 dark:text-blue-400 rounded-lg shrink-0"><Icon name="RotateCcw" size={14} /></button>
                                        </div>
                                    </div>

                                    <div className="bg-white dark:bg-dark-card rounded-2xl shadow-sm border border-gray-200 dark:border-dark-border overflow-hidden">
                                        <div className="bg-gray-50/50 dark:bg-slate-900/50 border-b border-gray-100 dark:border-dark-border p-4 hidden sm:grid grid-cols-[2fr,auto] items-center gap-4">
                                            <span className="font-bold text-gray-400 dark:text-slate-500 text-xs uppercase tracking-wider">{t('habits')}</span>
                                            <div className="flex justify-end gap-1">
                                                {habitTab === 'daily' ? viewInfo.days.map((d, i) => {
                                                    const isToday = d.dateKey === getDateKey(new Date());
                                                    return (
                                                        <div key={i} className={`w-10 text-center flex flex-col items-center ${isToday ? 'ring-2 ring-blue-500 rounded-lg py-1' : ''}`}>
                                                            <span className="text-[9px] font-bold text-gray-400 dark:text-slate-500 uppercase">{d.shortName}</span>
                                                            <span className={`text-xs font-bold mt-0.5 ${isToday ? 'text-blue-600 dark:text-blue-400' : 'text-gray-600 dark:text-slate-300'}`}>{d.dayNum}</span>
                                                        </div>
                                                    );
                                                }) : <span className="text-xs font-bold text-gray-400 uppercase px-2">{t('status')}</span>}
                                            </div>
                                        </div>

                                        <div className="divide-y divide-gray-100 dark:divide-slate-700">
                                            {calculations.habitsWithStats.filter(h => h.frequency === habitTab).map(habit => {
                                                const combo = calculateCombo(habit);
                                                return (
                                                    <div key={habit.id} className="p-4 flex flex-col sm:grid sm:grid-cols-[2fr,auto] gap-3 sm:gap-4 hover:bg-gray-50 dark:hover:bg-slate-800/50 transition-colors group">
                                                        <div className="flex items-center gap-3">
                                                            <button onClick={() => deleteHabit(habit.id)} className="text-gray-300 hover:text-red-400 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="Trash2" size={16} /></button>
                                                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center shadow-sm shrink-0 ${getCategoryColor(habit.category || 'Genel')}`}><Icon name={getCategoryIcon(habit.category || 'Genel')} size={20} /></div>
                                                            <div className="overflow-hidden">
                                                                <h3 className="font-bold text-slate-700 dark:text-slate-200 truncate">{habit.title}</h3>
                                                                <div className="flex gap-2 flex-wrap items-center">
                                                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wide ${getCategoryColor(habit.category || 'Genel')}`}>{getCategoryName(habit.category || 'Genel', lang)}</span>
                                                                    <button onClick={() => openEditHabitModal(habit)} className="p-1 text-gray-300 hover:text-blue-500 transition-colors opacity-100 sm:opacity-0 group-hover:opacity-100" title={t('edit')}><Icon name="Edit" size={14} /></button>
                                                                    {combo > 1 && (<div className="flex items-center gap-1 text-[10px] text-orange-500 font-bold mt-0.5"><Icon name="Flame" size={12} className="fill-orange-500 fire-anim" />{combo} {t('streak_day')}</div>)}
                                                                    <div className="flex items-center gap-1 text-[10px] text-gray-400 dark:text-slate-500 font-bold mt-0.5"><Icon name="Star" size={12} /> {t('max')}: {habit.maxStreakCalc}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className={`flex ${habitTab === 'daily' ? 'justify-between sm:justify-end gap-1 sm:gap-2 pb-6 sm:pb-7' : 'justify-center sm:justify-end'} bg-gray-50 dark:bg-slate-900 p-2 sm:p-2.5 rounded-xl border border-gray-100 dark:border-slate-800`}>
                                                            {habitTab === 'daily' ? viewInfo.days.map(d => {
                                                                const todayDateKey = getDateKey(new Date());
                                                                const isPast = d.dateKey < todayDateKey;
                                                                const isFuture = d.dateKey > todayDateKey;
                                                                const isToday = d.dateKey === todayDateKey;
                                                                const hasExcuse = habitExcuses[habit.id]?.[d.dateKey];
                                                                const isCompleted = habit.completedDays?.[d.dateKey];

                                                                return (
                                                                    <div key={d.dateKey} className="flex flex-col items-center sm:block relative min-w-[32px] sm:min-w-[40px]">
                                                                        <span className="sm:hidden text-[9px] text-gray-400 dark:text-slate-500 mb-1 flex flex-col items-center leading-none gap-0.5">
                                                                            <span>{d.shortName}</span>
                                                                            <span className="font-bold text-slate-600 dark:text-slate-300">{d.dayNum}</span>
                                                                        </span>
                                                                        <div className="relative">
                                                                            <button
                                                                                onClick={() => !isFuture && toggleHabit(habit.id, d.dateKey)}
                                                                                disabled={isFuture}
                                                                                className={`w-8 h-8 sm:w-10 sm:h-10 rounded-lg flex items-center justify-center transition-all duration-200 ${isFuture
                                                                                    ? 'bg-gray-100 dark:bg-slate-800 text-gray-300 dark:text-slate-600 cursor-not-allowed opacity-50'
                                                                                    : isCompleted
                                                                                        ? 'bg-blue-500 text-white shadow-md scale-105'
                                                                                        : isToday
                                                                                            ? 'ring-2 ring-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 text-gray-400 dark:text-slate-500 bg-white dark:bg-slate-800'
                                                                                            : 'hover:bg-white dark:hover:bg-slate-700 hover:shadow-sm text-gray-300 dark:text-slate-600 bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 sm:border-none sm:bg-transparent'
                                                                                    }`}>
                                                                                {isFuture ? (
                                                                                    <Icon name="Lock" size={14} className="opacity-50" />
                                                                                ) : (
                                                                                    <>
                                                                                        <Icon name="CheckCircle2" size={20} className={isCompleted ? 'block' : 'hidden'} />
                                                                                        {!isCompleted && <div className="w-1.5 h-1.5 rounded-full bg-gray-200 dark:bg-slate-600"></div>}
                                                                                    </>
                                                                                )}
                                                                            </button>
                                                                            {/* Excuse indicator */}
                                                                            {hasExcuse && (
                                                                                <div className="absolute -top-1 -right-1 w-3 h-3 bg-orange-500 rounded-full flex items-center justify-center" title={hasExcuse}>
                                                                                    <Icon name="FileText" size={8} className="text-white" />
                                                                                </div>
                                                                            )}
                                                                            {/* Excuse button for past unchecked days */}
                                                                            {isPast && !isCompleted && (
                                                                                <button
                                                                                    onClick={(e) => {
                                                                                        e.stopPropagation();
                                                                                        openExcuseModal('habit', habit.id, d.dateKey, habit.title, d.fullDate);
                                                                                    }}
                                                                                    className="absolute -bottom-5 sm:-bottom-6 left-1/2 transform -translate-x-1/2 text-[9px] sm:text-[10px] text-orange-500 hover:text-orange-600 hover:scale-110 font-bold transition-all whitespace-nowrap bg-white dark:bg-slate-800 px-1.5 py-0.5 rounded-full shadow-sm border border-orange-200 dark:border-slate-600 z-10"
                                                                                    title={t('add_excuse')}
                                                                                >
                                                                                    {hasExcuse ? 'âœï¸' : 'â•'}
                                                                                </button>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            }) : (() => {
                                                                // Calculate if current period is in the past or future
                                                                const now = new Date();
                                                                let isPastPeriod = false;
                                                                let isFuturePeriod = false;
                                                                if (habitTab === 'weekly') {
                                                                    const currentWeek = getWeekNumber(now);
                                                                    isPastPeriod = viewInfo.currentKey < currentWeek;
                                                                    isFuturePeriod = viewInfo.currentKey > currentWeek;
                                                                } else {
                                                                    const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                                                                    isPastPeriod = viewInfo.currentKey < currentMonth;
                                                                    isFuturePeriod = viewInfo.currentKey > currentMonth;
                                                                }
                                                                const isCompleted = habit.completedDays?.[viewInfo.currentKey];
                                                                const hasExcuse = excuses.habits?.[habit.id]?.[viewInfo.currentKey];

                                                                return (
                                                                    <div className="flex items-center gap-2 w-full sm:w-auto">
                                                                        {/* Complete Button */}
                                                                        <div className="relative flex-1 sm:flex-none">
                                                                            <button
                                                                                onClick={() => !isFuturePeriod && toggleHabit(habit.id, viewInfo.currentKey)}
                                                                                disabled={isFuturePeriod}
                                                                                className={`w-full sm:w-auto min-w-[120px] sm:min-w-[140px] px-3 sm:px-4 py-2.5 sm:py-2 rounded-xl font-bold text-[11px] sm:text-xs flex items-center justify-center gap-1.5 sm:gap-2 transition-all ${isFuturePeriod
                                                                                    ? 'bg-gray-100 dark:bg-slate-800 text-gray-400 dark:text-slate-600 cursor-not-allowed opacity-60'
                                                                                    : isCompleted
                                                                                        ? 'bg-green-500 text-white shadow-md'
                                                                                        : 'bg-white dark:bg-slate-800 border-2 border-gray-200 dark:border-slate-600 hover:border-blue-400 dark:hover:border-blue-500 text-gray-500 dark:text-gray-400 hover:text-blue-500'
                                                                                    }`}
                                                                            >
                                                                                <Icon name={isFuturePeriod ? "Lock" : (isCompleted ? "CheckCircle2" : "Circle")} size={16} className="shrink-0" />
                                                                                <span className="truncate">{isFuturePeriod ? t('future') : (isCompleted ? t('completed') : t('complete_period'))}</span>
                                                                            </button>
                                                                            {/* Excuse indicator on button */}
                                                                            {hasExcuse && (
                                                                                <div className="absolute -top-1 -right-1 w-4 h-4 bg-orange-500 rounded-full flex items-center justify-center shadow-sm" title={hasExcuse}>
                                                                                    <Icon name="MessageCircle" size={10} className="text-white" />
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                        {/* Excuse button for past uncompleted periods */}
                                                                        {isPastPeriod && !isCompleted && (
                                                                            <button
                                                                                onClick={(e) => {
                                                                                    e.stopPropagation();
                                                                                    openExcuseModal('habit', habit.id, viewInfo.currentKey, habit.title, viewInfo.label);
                                                                                }}
                                                                                className="shrink-0 w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center text-orange-500 hover:text-orange-600 hover:bg-orange-50 dark:hover:bg-orange-900/20 font-bold transition-all rounded-xl border-2 border-orange-200 dark:border-orange-800 bg-white dark:bg-slate-800"
                                                                                title={hasExcuse ? t('edit_excuse') : t('add_excuse')}
                                                                            >
                                                                                <Icon name="MessageCircle" size={18} />
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })()}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            {habits.filter(h => h.frequency === habitTab).length === 0 && <div className="p-12 text-center text-gray-400 dark:text-slate-500 text-sm">...</div>}
                                        </div>
                                        <div className="p-4 bg-gray-50/50 dark:bg-slate-900/50 flex justify-center border-t border-gray-100 dark:border-dark-border">
                                            <button onClick={() => openHabitModal(habitTab)} className="flex items-center gap-2 text-sm font-bold text-blue-600 dark:text-blue-400 hover:text-blue-700 px-4 py-2 hover:bg-blue-50 dark:hover:bg-slate-800 rounded-lg transition-colors"><Icon name="Plus" size={18} /> {t('new_habit')}</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'chain' && (
                                <div className="max-w-7xl mx-auto">
                                    <div className="bg-white dark:bg-dark-card p-6 rounded-2xl border border-gray-200 dark:border-dark-border shadow-sm mb-6">
                                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                            <div className="w-full">
                                                <h2 className="text-2xl font-bold flex gap-2 items-center text-slate-800 dark:text-white"><Icon name="Link2" className="text-blue-600" /> {t('chain_break')}</h2>
                                                <input type="text" value={chainTarget} onChange={(e) => setChainTarget(e.target.value)} onBlur={() => persistData({ chainTarget })} placeholder={t('target_placeholder')} className="mt-2 text-lg text-gray-600 dark:text-slate-300 placeholder-gray-400 border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none w-full bg-transparent transition-all" />
                                                <p className="text-xs text-gray-400 mt-2 italic">
                                                    <span className="font-bold text-green-600">1-7 {t('days')}: 10 XP</span> â†’ <span className="font-bold text-yellow-500">8-14: 15 XP</span> â†’ <span className="font-bold text-orange-500">15-30: 20 XP</span> â†’ <span className="font-bold text-red-500">31-60: 30 XP</span> â†’ <span className="font-bold text-rose-600">61+: 40-50 XP ğŸ”¥</span>
                                                </p>
                                            </div>
                                            <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 w-full md:w-auto min-w-0">
                                                {/* 1. Year Progress */}
                                                <div className="text-center bg-blue-50 dark:bg-blue-900/20 px-1 py-1 rounded-lg min-w-0 overflow-hidden flex flex-col items-center">
                                                    <span className="block text-xs sm:text-lg font-bold text-blue-600 dark:text-blue-400 leading-tight truncate">
                                                        {calculations.chainDaysThisYear}<span className="text-[8px] sm:text-xs text-blue-400 font-medium">/{calculations.daysPassedInYear}</span>
                                                    </span>
                                                    <span className="text-[8px] sm:text-[9px] text-blue-400 uppercase font-bold tracking-wide truncate">{t('year')}</span>
                                                </div>
                                                {/* 2. Lifetime Total */}
                                                <div className="text-center bg-indigo-50 dark:bg-indigo-900/20 px-1 py-1 rounded-lg min-w-0 overflow-hidden flex flex-col items-center">
                                                    <span className="block text-xs sm:text-lg font-bold text-indigo-600 dark:text-indigo-400 leading-tight truncate">{Object.keys(chainData).length}</span>
                                                    <span className="text-[8px] sm:text-[9px] text-indigo-400 uppercase font-bold tracking-wide truncate">{t('total')}</span>
                                                </div>
                                                {/* 3. Current Streak */}
                                                <div className="text-center bg-green-50 dark:bg-green-900/20 px-1 py-1 rounded-lg min-w-0 overflow-hidden flex flex-col items-center">
                                                    <span className="block text-xs sm:text-lg font-bold text-green-600 dark:text-green-400 leading-tight truncate">{calculations.currentChainStreak}</span>
                                                    <span className="text-[8px] sm:text-[9px] text-green-500 uppercase font-bold tracking-wide truncate">{t('current')}</span>
                                                </div>
                                                {/* 4. Best Streak */}
                                                <div className="text-center bg-orange-50 dark:bg-orange-900/20 px-1 py-1 rounded-lg min-w-0 overflow-hidden flex flex-col items-center">
                                                    <span className="block text-xs sm:text-lg font-bold text-orange-600 dark:text-orange-400 leading-tight truncate">{calculations.bestChainStreak}</span>
                                                    <span className="text-[8px] sm:text-[9px] text-orange-500 uppercase font-bold tracking-wide truncate">{t('best')}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-6">
                                        {Array.from({ length: 12 }).map((_, mIdx) => {
                                            const currentYear = new Date().getFullYear();
                                            const d = new Date(currentYear, mIdx, 1);
                                            const mName = formatDate(d.toISOString(), { month: 'long' });
                                            const days = new Date(currentYear, mIdx + 1, 0).getDate();
                                            const firstDay = (new Date(currentYear, mIdx, 1).getDay() || 7) - 1;
                                            return (
                                                <div key={mIdx} className="bg-white dark:bg-dark-card rounded-xl border border-gray-200 dark:border-dark-border shadow-sm overflow-hidden">
                                                    <div className="bg-gray-50 dark:bg-slate-900 px-4 py-2 border-b dark:border-slate-800 font-bold text-slate-700 dark:text-slate-300 flex justify-between"><span>{mName}</span><span className="text-xs text-gray-400">{currentYear}</span></div>
                                                    <div className="p-4 grid grid-cols-7 gap-1">
                                                        {[...Array(firstDay)].map((_, i) => <div key={'e' + i} />)}
                                                        {[...Array(days)].map((_, i) => {
                                                            const d = i + 1, k = `${currentYear}-${String(mIdx + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                                                            const isMarked = chainData[k];
                                                            const streakVal = isMarked ? chainStreakMap[k] : 0;
                                                            const heatClass = isMarked ? getHeatColor(streakVal) : getHeatColor(0);
                                                            const todayKey = getDateKey(new Date());
                                                            const isPastDay = k < todayKey;
                                                            const isFutureDay = k > todayKey;
                                                            const isToday = k === todayKey;
                                                            const hasChainExcuse = excuses.chain?.[k];

                                                            return (
                                                                <div key={d} className="relative group/day">
                                                                    <button
                                                                        onClick={() => toggleChainDay(k)}
                                                                        disabled={isFutureDay}
                                                                        className={`aspect-square w-full rounded-full flex items-center justify-center text-xs font-medium transition-all relative ${heatClass} ${isMarked ? 'scale-110' : ''} ${isFutureDay ? 'opacity-30 cursor-not-allowed' : ''} ${isToday && !isMarked ? 'ring-2 ring-blue-500 ring-offset-1 dark:ring-offset-slate-900' : ''}`}
                                                                    >
                                                                        {isMarked ? (
                                                                            <>
                                                                                {streakVal >= 100 && <Icon name="Flame" size={14} className="animate-pulse text-yellow-300 absolute" style={{ filter: 'drop-shadow(0 0 2px orange)' }} />}
                                                                                <Icon name="CheckCircle2" size={12} className={streakVal >= 100 ? 'opacity-0' : ''} />
                                                                            </>
                                                                        ) : d}
                                                                    </button>

                                                                    {isMarked && (
                                                                        <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-black/80 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover/day:opacity-100 transition-opacity whitespace-nowrap z-30 pointer-events-none">
                                                                            {streakVal} {t('streak_day')} â€¢ {getChainPoints(streakVal)} XP
                                                                        </div>
                                                                    )}
                                                                    {/* Excuse indicator */}
                                                                    {hasChainExcuse && !isMarked && (
                                                                        <div className="absolute -top-1 -right-1 w-3 h-3 bg-orange-500 rounded-full flex items-center justify-center z-10">
                                                                            <Icon name="FileText" size={6} className="text-white" />
                                                                        </div>
                                                                    )}
                                                                    {/* Excuse button for past unmarked days - small button below, always visible on mobile */}
                                                                    {isPastDay && !isMarked && (
                                                                        <button
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                openExcuseModal('chain', null, k, chainTarget || t('chain'), formatDate(k));
                                                                            }}
                                                                            className="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-4 h-4 flex items-center justify-center text-[8px] bg-orange-500 text-white rounded-full shadow-sm z-20 sm:opacity-0 sm:group-hover/day:opacity-100 transition-all"
                                                                            title={t('add_excuse')}
                                                                        >
                                                                            {hasChainExcuse ? 'âœ' : 'ğŸ’¬'}
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'stats' && (
                                <div className="max-w-6xl mx-auto space-y-6 pb-20">
                                    {/* Stats Navigation - Hidden for now */}
                                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white dark:bg-dark-card p-4 rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm hidden">
                                        <div className="flex bg-gray-100 dark:bg-slate-900 p-1 rounded-lg">
                                            {['daily', 'weekly', 'monthly', 'yearly'].map(p => (
                                                <button key={p} onClick={() => setStatPeriod(p)} className={`px-4 py-2 rounded-md text-sm font-bold capitalize transition-all ${statPeriod === p ? 'bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-400 shadow-sm' : 'text-gray-500 dark:text-slate-400 hover:text-gray-700'}`}>{t(p)}</button>
                                            ))}
                                        </div>
                                        <div className="flex items-center gap-4 font-bold text-slate-700 dark:text-slate-300">
                                            <button onClick={() => shiftStatDate(-1)} className="p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors"><Icon name="ChevronLeft" /></button>
                                            <span className="min-w-[120px] text-center">{calculations.periodLabel}</span>
                                            <button onClick={() => shiftStatDate(1)} className="p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors"><Icon name="ChevronRight" /></button>
                                        </div>
                                    </div>

                                    <div className="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-3xl p-6 text-white shadow-lg mb-6 relative overflow-hidden">
                                        <div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="Zap" size={120} /></div>
                                        {/* Level Info Button */}
                                        <button onClick={() => setLevelInfoModalOpen(true)} className="absolute top-4 right-4 bg-white/20 hover:bg-white/30 p-2 rounded-full transition-colors z-20">
                                            <Icon name="Info" size={16} className="text-white" />
                                        </button>

                                        <div className="relative z-10 flex flex-col sm:flex-row items-center gap-6">
                                            <div className="relative shrink-0">
                                                <svg className="w-24 h-24 transform -rotate-90">
                                                    <circle cx="48" cy="48" r="40" stroke="currentColor" strokeWidth="8" fill="transparent" className="text-indigo-700/50" />
                                                    {/* Fix: Inverted dashoffset logic 251.2 is full circle */}
                                                    <circle cx="48" cy="48" r="40" stroke="currentColor" strokeWidth="8" fill="transparent" strokeDasharray={251.2} strokeDashoffset={251.2 - (251.2 * calculations.progress / 100)} strokeLinecap="round" className="text-yellow-400 transition-all duration-1000 ease-out" />
                                                </svg>
                                                <div className="absolute inset-0 flex items-center justify-center font-black text-2xl">{calculations.level}</div>
                                            </div>
                                            <div className="flex-1 text-center sm:text-left">
                                                <h3 className="text-3xl font-black mb-1 flex items-center justify-center sm:justify-start gap-2">
                                                    {calculations.motivationalMessage}
                                                    {calculations.level === 15 && <Icon name="Crown" className="text-yellow-300" />}
                                                </h3>
                                                <div className="text-indigo-200 text-sm font-medium mb-4">
                                                    {calculations.totalScore} XP <span className="mx-2">â€¢</span> {calculations.level === 15 ? "MAX LEVEL" : `${parseInt(calculations.nextLevelXp - calculations.totalScore)} XP to Level ${calculations.level + 1}`}
                                                </div>

                                                {/* INTEGRATED JOIN BUTTON ONLY - HIDE IF JOINED */}
                                                {!leaderboardUser?.nickname && (
                                                    <div className="flex items-center justify-center sm:justify-start gap-3">
                                                        <button
                                                            onClick={openProfileSetup}
                                                            className="bg-yellow-400 hover:bg-yellow-300 text-indigo-900 px-6 py-2 rounded-xl font-bold transition-all shadow-lg hover:scale-105 active:scale-95 flex items-center gap-2"
                                                        >
                                                            <Icon name="Trophy" size={18} />
                                                            {t('join_leaderboard')}
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    {/* Level Info Modal */}
                                    {levelInfoModalOpen && (
                                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setLevelInfoModalOpen(false)}>
                                            <div className="bg-white dark:bg-dark-card w-full max-w-lg rounded-2xl p-6 relative max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                                <button onClick={() => setLevelInfoModalOpen(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-white"><Icon name="X" size={24} /></button>
                                                <h3 className="text-2xl font-bold mb-4 text-slate-800 dark:text-white flex items-center gap-2"><Icon name="Zap" className="text-yellow-500" /> {t('level_info') || 'Seviye Bilgisi'}</h3>

                                                <div className="space-y-3">
                                                    {LEVEL_THRESHOLDS.map((xp, idx) => {
                                                        const lvl = idx + 1;
                                                        if (lvl > 15) return null;
                                                        const isCurrent = calculations.level === lvl;
                                                        const msgObj = LEVEL_MESSAGES[lvl] || LEVEL_MESSAGES[1];
                                                        const msg = msgObj[lang] || msgObj['en'];

                                                        return (
                                                            <div key={lvl} className={`p-3 rounded-xl border flex items-center gap-3 ${isCurrent ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-700' : 'border-gray-100 dark:border-slate-800'}`}>
                                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${isCurrent ? 'bg-indigo-600 text-white' : 'bg-gray-100 dark:bg-slate-800 text-gray-500'}`}>{lvl}</div>
                                                                <div className="flex-1">
                                                                    <div className="font-bold text-slate-700 dark:text-slate-200 text-sm">{msg}</div>
                                                                    <div className="text-xs text-gray-400">{xp} XP {idx < LEVEL_THRESHOLDS.length - 1 ? `- ${LEVEL_THRESHOLDS[idx + 1]} XP` : '+'}</div>
                                                                </div>
                                                                {isCurrent && <span className="text-indigo-600 dark:text-indigo-400 text-xs font-bold uppercase">{t('current_level') || 'Current'}</span>}
                                                            </div>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {/* Hero Section */}
                                    {/* <div className="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-3xl p-6 md:p-10 text-white shadow-lg relative overflow-hidden">
                                        <div className="absolute top-0 right-0 p-8 opacity-10"><Icon name="Trophy" size={150} /></div>
                                        <div className="relative z-10 flex flex-col md:flex-row justify-between items-end md:items-center gap-6">
                                            <div>
                                                <div className="flex items-center gap-3 mb-2 opacity-80 font-bold uppercase tracking-wider text-xs">{t('current_level')}</div>
                                                <div className="text-5xl font-black mb-1">{t('level')} {calculations.level}</div>
                                                <div className="text-xl opacity-90 font-medium">{calculations.motivationMsg}</div>
                                            </div>
                                            <div className="w-full md:w-1/2">
                                                <div className="flex justify-between text-sm mb-2 font-bold opacity-90">
                                                    <span>{Math.floor(calculations.progress)}% XP</span>
                                                    <span>{500 - Math.floor(calculations.totalScore % 500)} XP {t('next_level_xp')}</span>
                                                </div>
                                                <div className="h-4 bg-black/20 rounded-full overflow-hidden backdrop-blur-sm">
                                                    <div className="h-full bg-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.5)] transition-all duration-1000" style={{ width: `${calculations.progress}%` }}></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div> */}

                                    {/* Dashboard Grid */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

                                        {/* Overall/Lifetime Success Card - Always Visible */}
                                        <div className="bg-gradient-to-br from-purple-500 to-indigo-600 p-5 rounded-2xl shadow-lg text-white relative overflow-hidden">
                                            <div className="absolute top-0 right-0 opacity-10">
                                                <Icon name="Trophy" size={100} />
                                            </div>
                                            <div className="relative z-10">
                                                <div className="flex items-center gap-2 mb-3">
                                                    <Icon name="Star" size={20} className="fill-yellow-300 text-yellow-300" />
                                                    <span className="text-xs font-bold uppercase tracking-wider opacity-90">{t('lifetime_success')}</span>
                                                </div>
                                                <div className="text-5xl font-black mb-2">{calculations.overallSuccessRate}%</div>
                                                <div className="text-xs opacity-80 font-medium">{t('habit_based')}</div>
                                                <div className="mt-3 space-y-1 text-xs">
                                                    <div className="flex justify-between">
                                                        <span className="opacity-70">{t('daily')}</span>
                                                        <span className="font-bold">{calculations.dailyLifetime.rate}% ({calculations.dailyHabitsCount})</span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="opacity-70">{t('weekly')}</span>
                                                        <span className="font-bold">{calculations.weeklyLifetime.rate}% ({calculations.weeklyHabitsCount})</span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="opacity-70">{t('monthly')}</span>
                                                        <span className="font-bold">{calculations.monthlyLifetime.rate}% ({calculations.monthlyHabitsCount})</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Daily Habits Card */}
                                        <div className="bg-white dark:bg-dark-card p-5 rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm flex flex-col justify-between group hover:border-emerald-200 transition-colors">
                                            <div className="flex flex-col gap-3 mb-4">
                                                <div className="flex items-center gap-2">
                                                    <div className="bg-emerald-50 dark:bg-emerald-900/20 p-2 rounded-xl text-emerald-600 dark:text-emerald-400"><Icon name="Zap" size={20} /></div>
                                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">{t('daily_habits')}</span>
                                                </div>
                                                {/* Filter Controls - Stacked layout */}
                                                <div className="flex flex-col gap-2">
                                                    <select
                                                        value={dailyHabitStatPeriod}
                                                        onChange={(e) => setDailyHabitStatPeriod(e.target.value)}
                                                        className="bg-gray-100 dark:bg-slate-800 border-none text-[11px] font-bold rounded-lg px-3 py-2 outline-none text-slate-600 dark:text-slate-300 cursor-pointer w-full"
                                                    >
                                                        {['daily', 'weekly', 'monthly', 'yearly'].map(p => <option key={p} value={p}>{t(p)}</option>)}
                                                    </select>
                                                    <div className="flex items-center bg-gray-100 dark:bg-slate-800 rounded-lg">
                                                        <button onClick={() => shiftDailyHabitStatDate(-1)} className="p-2 hover:text-emerald-500 shrink-0"><Icon name="ChevronLeft" size={16} /></button>
                                                        <span className="flex-1 text-[11px] font-bold text-center text-slate-600 dark:text-slate-300 truncate px-1">{calculations.dailyHabitStats.label}</span>
                                                        <button onClick={() => shiftDailyHabitStatDate(1)} className="p-2 hover:text-emerald-500 shrink-0"><Icon name="ChevronRight" size={16} /></button>
                                                        <button onClick={() => setDailyHabitStatDate(new Date())} className="p-2 hover:bg-emerald-100 dark:hover:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-r-lg shrink-0 border-l border-gray-200 dark:border-slate-700" title={t('go_to_today')}><Icon name="RotateCcw" size={14} /></button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div>
                                                <div className="text-3xl font-bold text-slate-800 dark:text-white mb-1">{calculations.dailyHabitStats.rate}%</div>
                                                <div className="text-xs font-medium text-gray-400 dark:text-slate-500">{calculations.dailyHabitStats.completed}/{calculations.dailyHabitStats.expected}</div>
                                                <div className="h-1.5 w-full bg-gray-100 dark:bg-slate-800 rounded-full mt-3 overflow-hidden">
                                                    <div className="h-full bg-emerald-500 rounded-full transition-all" style={{ width: `${calculations.dailyHabitStats.rate}%` }}></div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Weekly Habits Card */}
                                        <div className="bg-white dark:bg-dark-card p-5 rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm flex flex-col justify-between group hover:border-blue-200 transition-colors">
                                            <div className="flex flex-col gap-3 mb-4">
                                                <div className="flex items-center gap-2">
                                                    <div className="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-xl text-blue-600 dark:text-blue-400"><Icon name="Calendar" size={20} /></div>
                                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">{t('weekly_habits')}</span>
                                                </div>
                                                {/* Filter Controls - Stacked layout */}
                                                <div className="flex flex-col gap-2">
                                                    <select
                                                        value={weeklyHabitStatPeriod}
                                                        onChange={(e) => setWeeklyHabitStatPeriod(e.target.value)}
                                                        className="bg-gray-100 dark:bg-slate-800 border-none text-[11px] font-bold rounded-lg px-3 py-2 outline-none text-slate-600 dark:text-slate-300 cursor-pointer w-full"
                                                    >
                                                        {['weekly', 'monthly', 'yearly'].map(p => <option key={p} value={p}>{t(p)}</option>)}
                                                    </select>
                                                    <div className="flex items-center bg-gray-100 dark:bg-slate-800 rounded-lg">
                                                        <button onClick={() => shiftWeeklyHabitStatDate(-1)} className="p-2 hover:text-blue-500 shrink-0"><Icon name="ChevronLeft" size={16} /></button>
                                                        <span className="flex-1 text-[11px] font-bold text-center text-slate-600 dark:text-slate-300 truncate px-1">{calculations.weeklyHabitStats.label}</span>
                                                        <button onClick={() => shiftWeeklyHabitStatDate(1)} className="p-2 hover:text-blue-500 shrink-0"><Icon name="ChevronRight" size={16} /></button>
                                                        <button onClick={() => setWeeklyHabitStatDate(new Date())} className="p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-r-lg shrink-0 border-l border-gray-200 dark:border-slate-700" title={t('go_to_current')}><Icon name="RotateCcw" size={14} /></button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div>
                                                <div className="text-3xl font-bold text-slate-800 dark:text-white mb-1">{calculations.weeklyHabitStats.rate}%</div>
                                                <div className="text-xs font-medium text-gray-400 dark:text-slate-500">{calculations.weeklyHabitStats.completed}/{calculations.weeklyHabitStats.expected}</div>
                                                <div className="h-1.5 w-full bg-gray-100 dark:bg-slate-800 rounded-full mt-3 overflow-hidden">
                                                    <div className="h-full bg-blue-500 rounded-full transition-all" style={{ width: `${calculations.weeklyHabitStats.rate}%` }}></div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Monthly Habits Card */}
                                        <div className="bg-white dark:bg-dark-card p-5 rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm flex flex-col justify-between group hover:border-violet-200 transition-colors">
                                            <div className="flex flex-col gap-3 mb-4">
                                                <div className="flex items-center gap-2">
                                                    <div className="bg-violet-50 dark:bg-violet-900/20 p-2 rounded-xl text-violet-600 dark:text-violet-400"><Icon name="Activity" size={20} /></div>
                                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">{t('monthly_habits')}</span>
                                                </div>
                                                {/* Filter Controls - Stacked layout */}
                                                <div className="flex flex-col gap-2">
                                                    <select
                                                        value={monthlyHabitStatPeriod}
                                                        onChange={(e) => setMonthlyHabitStatPeriod(e.target.value)}
                                                        className="bg-gray-100 dark:bg-slate-800 border-none text-[11px] font-bold rounded-lg px-3 py-2 outline-none text-slate-600 dark:text-slate-300 cursor-pointer w-full"
                                                    >
                                                        {['monthly', 'yearly'].map(p => <option key={p} value={p}>{t(p)}</option>)}
                                                    </select>
                                                    <div className="flex items-center bg-gray-100 dark:bg-slate-800 rounded-lg">
                                                        <button onClick={() => shiftMonthlyHabitStatDate(-1)} className="p-2 hover:text-violet-500 shrink-0"><Icon name="ChevronLeft" size={16} /></button>
                                                        <span className="flex-1 text-[11px] font-bold text-center text-slate-600 dark:text-slate-300 truncate px-1">{calculations.monthlyHabitStats.label}</span>
                                                        <button onClick={() => shiftMonthlyHabitStatDate(1)} className="p-2 hover:text-violet-500 shrink-0"><Icon name="ChevronRight" size={16} /></button>
                                                        <button onClick={() => setMonthlyHabitStatDate(new Date())} className="p-2 hover:bg-violet-100 dark:hover:bg-violet-900/30 text-violet-600 dark:text-violet-400 rounded-r-lg shrink-0 border-l border-gray-200 dark:border-slate-700" title={t('go_to_current')}><Icon name="RotateCcw" size={14} /></button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div>
                                                <div className="text-3xl font-bold text-slate-800 dark:text-white mb-1">{calculations.monthlyHabitStats.rate}%</div>
                                                <div className="text-xs font-medium text-gray-400 dark:text-slate-500">{calculations.monthlyHabitStats.completed}/{calculations.monthlyHabitStats.expected}</div>
                                                <div className="h-1.5 w-full bg-gray-100 dark:bg-slate-800 rounded-full mt-3 overflow-hidden">
                                                    <div className="h-full bg-violet-500 rounded-full transition-all" style={{ width: `${calculations.monthlyHabitStats.rate}%` }}></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Second Row: Task + Chain + Pomodoro */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-stretch">

                                        {/* Task Card - Enhanced */}
                                        <div className="bg-white dark:bg-dark-card p-5 rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm flex flex-col group hover:border-blue-200 transition-colors min-h-[280px]">
                                            <div className="flex flex-col gap-2 mb-3">
                                                <div className="flex justify-between items-start">
                                                    <div className="flex items-center gap-2">
                                                        <div className="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-xl text-blue-600 dark:text-blue-400"><Icon name="CheckCircle2" size={20} /></div>
                                                        <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">{t('task_efficiency')}</span>
                                                    </div>
                                                </div>
                                                {/* Period Selector */}
                                                <div className="flex flex-wrap items-center gap-1 mt-1">
                                                    {[
                                                        { id: 'today', label: t('today_tasks') },
                                                        { id: 'weekly', label: t('this_week_tasks') },
                                                        { id: 'monthly', label: t('this_month_tasks') },
                                                        { id: 'all', label: t('all_tasks_period') }
                                                    ].map(p => (
                                                        <button
                                                            key={p.id}
                                                            onClick={() => setTaskStatPeriod(p.id)}
                                                            className={`px-2 py-0.5 rounded text-[10px] font-bold transition-all ${taskStatPeriod === p.id
                                                                ? 'bg-blue-500 text-white'
                                                                : 'bg-gray-100 dark:bg-slate-800 text-gray-500 dark:text-slate-400 hover:bg-gray-200 dark:hover:bg-slate-700'
                                                                }`}
                                                        >
                                                            {p.label}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* Main Rate */}
                                            <div className="flex items-baseline gap-3 mb-2">
                                                <div className="text-3xl font-bold text-slate-800 dark:text-white">{calculations.taskEfficiencyRate}%</div>
                                                {calculations.taskTrend !== 0 && taskStatPeriod !== 'all' && (
                                                    <div className={`flex items-center gap-0.5 text-xs font-bold ${calculations.taskTrend > 0 ? 'text-green-500' : 'text-red-500'}`}>
                                                        <Icon name={calculations.taskTrend > 0 ? 'TrendingUp' : 'TrendingDown'} size={14} />
                                                        <span>{Math.abs(calculations.taskTrend)}%</span>
                                                    </div>
                                                )}
                                            </div>

                                            {/* Progress Bar */}
                                            <div className="w-full bg-gray-100 dark:bg-slate-700 h-1.5 rounded-full overflow-hidden mb-3">
                                                <div className="bg-blue-500 h-full rounded-full transition-all" style={{ width: `${calculations.taskEfficiencyRate}%` }}></div>
                                            </div>

                                            {/* Stats Grid */}
                                            <div className="grid grid-cols-2 gap-2 text-[10px] min-w-0">
                                                <div className="bg-gray-50 dark:bg-slate-800/50 rounded-lg p-2 min-w-0 overflow-hidden">
                                                    <div className="text-gray-400 uppercase font-bold mb-0.5 truncate">{t('done')}</div>
                                                    <div className="text-base sm:text-lg font-bold text-blue-600 dark:text-blue-400 truncate">{calculations.taskStatsFiltered.done}<span className="text-gray-400 text-[10px] sm:text-xs">/{calculations.taskStatsFiltered.total}</span></div>
                                                </div>
                                                <div className="bg-gray-50 dark:bg-slate-800/50 rounded-lg p-2 min-w-0 overflow-hidden">
                                                    <div className="text-gray-400 uppercase font-bold mb-0.5 truncate">{t('on_time')}</div>
                                                    <div className="text-base sm:text-lg font-bold text-green-600 dark:text-green-400">{calculations.onTimeRate}%</div>
                                                </div>
                                                <div className="bg-gray-50 dark:bg-slate-800/50 rounded-lg p-2 min-w-0 overflow-hidden">
                                                    <div className="text-gray-400 uppercase font-bold mb-0.5 truncate">{t('overdue_tasks')}</div>
                                                    <div className={`text-base sm:text-lg font-bold ${calculations.taskStatsFiltered.overdue > 0 ? 'text-red-500' : 'text-gray-400'}`}>{calculations.taskStatsFiltered.overdue}</div>
                                                </div>
                                                <div className="bg-gray-50 dark:bg-slate-800/50 rounded-lg p-2 min-w-0 overflow-hidden">
                                                    <div className="text-gray-400 uppercase font-bold mb-0.5 truncate">{t('task_streak')}</div>
                                                    <div className="text-base sm:text-lg font-bold text-orange-500 truncate">{calculations.taskStreak} <span className="text-[10px] sm:text-xs">{t('days')}</span></div>
                                                </div>
                                            </div>

                                            {/* Best Category */}
                                            {calculations.bestCategory.name !== '-' && (
                                                <div className="mt-3 pt-3 border-t border-gray-100 dark:border-slate-700">
                                                    <div className="flex items-center justify-between text-[10px]">
                                                        <span className="text-gray-400 font-bold uppercase">{t('best_category')}</span>
                                                        <div className="flex items-center gap-1.5">
                                                            <span className={`${getCategoryColor(calculations.bestCategory.name)} px-2 py-0.5 rounded text-[10px] font-bold`}>{translateCategory(calculations.bestCategory.name)}</span>
                                                            <span className="text-green-500 font-bold">{calculations.bestCategory.rate}%</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Today's completions */}
                                            <div className="mt-2 flex items-center justify-between text-[10px]">
                                                <span className="text-gray-400 font-bold uppercase">{t('completed_today')}</span>
                                                <span className="text-blue-500 font-bold text-sm">{calculations.completedToday}</span>
                                            </div>
                                        </div>

                                        {/* Chain Card - Enhanced */}
                                        <div className="bg-white dark:bg-dark-card p-5 rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm flex flex-col group hover:border-orange-200 transition-colors min-h-[280px]">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="bg-orange-50 dark:bg-orange-900/20 p-2.5 rounded-xl text-orange-600 dark:text-orange-400"><Icon name="Link2" size={24} /></div>
                                                <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">{t('chain_status')}</span>
                                            </div>

                                            {/* Main Stat */}
                                            <div className="flex items-baseline gap-2 mb-1">
                                                <div className="text-3xl font-bold text-slate-800 dark:text-white">{calculations.chainYearPercent}%</div>
                                                <div className="text-xs font-medium text-gray-400">{t('year')}</div>
                                            </div>

                                            {/* Progress Bar */}
                                            <div className="w-full bg-gray-100 dark:bg-slate-700 h-1.5 rounded-full overflow-hidden mb-3">
                                                <div className="bg-orange-500 h-full rounded-full transition-all" style={{ width: `${calculations.chainYearPercent}%` }}></div>
                                            </div>

                                            {/* Stats Grid */}
                                            <div className="grid grid-cols-2 gap-2 text-[10px] flex-1 min-w-0">
                                                <div className="bg-gray-50 dark:bg-slate-800/50 rounded-lg p-2 min-w-0 overflow-hidden">
                                                    <div className="text-gray-400 uppercase font-bold mb-0.5 truncate">{t('year')}</div>
                                                    <div className="text-base sm:text-lg font-bold text-orange-600 dark:text-orange-400 truncate">{calculations.chainDaysThisYear}<span className="text-gray-400 text-[10px] sm:text-xs">/{calculations.daysPassedInYear}</span></div>
                                                </div>
                                                <div className="bg-gray-50 dark:bg-slate-800/50 rounded-lg p-2 min-w-0 overflow-hidden">
                                                    <div className="text-gray-400 uppercase font-bold mb-0.5 truncate">{t('current_combo')}</div>
                                                    <div className="text-base sm:text-lg font-bold text-orange-500 truncate">{calculations.currentChainStreak} <span className="text-[10px] sm:text-xs">{t('days')}</span></div>
                                                </div>
                                            </div>

                                            {/* Max Combo */}
                                            <div className="mt-3 pt-3 border-t border-gray-100 dark:border-slate-700">
                                                <div className="flex items-center justify-between text-[10px]">
                                                    <span className="text-gray-400 font-bold uppercase">{t('max_combo')}</span>
                                                    <span className="text-orange-500 font-bold text-sm">{calculations.bestChainStreak} {t('days')}</span>
                                                </div>
                                            </div>

                                            {/* Today Status */}
                                            <div className="mt-2 flex items-center justify-between text-[10px]">
                                                <span className="text-gray-400 font-bold uppercase">{t('today')}</span>
                                                <span className={`font-bold text-sm ${chainData[getDateKey(new Date())] ? 'text-green-500' : 'text-gray-400'}`}>
                                                    {chainData[getDateKey(new Date())] ? 'âœ“' : 'â€”'}
                                                </span>
                                            </div>
                                        </div>

                                        {/* Pomodoro Card - Enhanced */}
                                        <div className="bg-white dark:bg-dark-card p-5 rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm flex flex-col group hover:border-red-200 transition-colors min-h-[280px]">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="bg-red-50 dark:bg-red-900/20 p-2.5 rounded-xl text-red-600 dark:text-red-400"><Icon name="Timer" size={24} /></div>
                                                <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">{t('pomodoro_stats')}</span>
                                            </div>

                                            {/* Main Stat */}
                                            <div className="flex items-baseline gap-2 mb-1">
                                                <div className="text-3xl font-bold text-slate-800 dark:text-white">{calculations.pomodoroHours}</div>
                                                <div className="text-sm font-medium text-gray-400">{t('hours_short')}</div>
                                            </div>

                                            {/* Progress Bar */}
                                            <div className="w-full bg-gray-100 dark:bg-slate-700 h-1.5 rounded-full overflow-hidden mb-3">
                                                <div className="bg-red-500 h-full rounded-full transition-all" style={{ width: `${Math.min((calculations.pomDaysCount / 30) * 100, 100)}%` }}></div>
                                            </div>

                                            {/* Stats Grid */}
                                            <div className="grid grid-cols-2 gap-2 text-[10px] flex-1 min-w-0">
                                                <div className="bg-gray-50 dark:bg-slate-800/50 rounded-lg p-2 min-w-0 overflow-hidden">
                                                    <div className="text-gray-400 uppercase font-bold mb-0.5 truncate">{t('today')}</div>
                                                    <div className="text-base sm:text-lg font-bold text-red-600 dark:text-red-400 truncate">{calculations.pomTimeToday > 0 ? Math.max(1, Math.round(calculations.pomTimeToday / 60)) : 0}<span className="text-gray-400 text-[10px] sm:text-xs"> {t('min')}</span></div>
                                                </div>
                                                <div className="bg-gray-50 dark:bg-slate-800/50 rounded-lg p-2 min-w-0 overflow-hidden">
                                                    <div className="text-gray-400 uppercase font-bold mb-0.5 truncate">{t('this_week_tasks')}</div>
                                                    <div className="text-base sm:text-lg font-bold text-red-500 truncate">{(calculations.pomTimeThisWeek / 3600).toFixed(1)}<span className="text-gray-400 text-[10px] sm:text-xs"> {t('hours_short')}</span></div>
                                                </div>
                                            </div>

                                            {/* Sessions & Days */}
                                            <div className="mt-3 pt-3 border-t border-gray-100 dark:border-slate-700">
                                                <div className="flex items-center justify-between text-[10px]">
                                                    <span className="text-gray-400 font-bold uppercase">{t('total_sessions')}</span>
                                                    <span className="text-red-500 font-bold text-sm">{calculations.pomSessions}</span>
                                                </div>
                                            </div>

                                            {/* Avg Session */}
                                            <div className="mt-2 flex items-center justify-between text-[10px]">
                                                <span className="text-gray-400 font-bold uppercase">{t('avg_session') || 'Ort. Oturum'}</span>
                                                <span className="text-red-500 font-bold text-sm">{calculations.avgSessionLength} {t('min')}</span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Third Row: Category Performance - Simple & Clean */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {/* Top Categories Card */}
                                        <div className="bg-white dark:bg-dark-card p-5 rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm">
                                            <div className="flex items-center gap-2 mb-4">
                                                <div className="bg-gradient-to-br from-indigo-500 to-purple-600 p-2 rounded-xl text-white">
                                                    <Icon name="Trophy" size={18} />
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-slate-700 dark:text-white text-sm">{t('top_categories') || 'En Aktif Kategoriler'}</h4>
                                                    <span className="text-[10px] text-gray-400">{t('by_completion') || 'Tamamlanma oranÄ±na gÃ¶re'}</span>
                                                </div>
                                            </div>

                                            <div className="space-y-3">
                                                {Object.entries(calculations.categoryStats || {})
                                                    .filter(([_, s]) => s.total > 0)
                                                    .sort(([, a], [, b]) => b.rate - a.rate)
                                                    .slice(0, 5)
                                                    .map(([cat, stats], idx) => (
                                                        <div key={cat} className="flex items-center gap-3">
                                                            <div className={`w-6 h-6 rounded-lg flex items-center justify-center text-xs font-bold ${getCategoryColor(cat)}`}>
                                                                <Icon name={getCategoryIcon(cat)} size={14} />
                                                            </div>
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex items-center justify-between mb-1">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-[10px] font-medium text-gray-600 dark:text-gray-300 truncate">
                                                                            {translateCategory(cat)}
                                                                        </span>
                                                                        {idx < 3 && <span className="text-[10px]">{['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][idx]}</span>}
                                                                    </div>
                                                                    <span className="text-sm font-bold text-slate-700 dark:text-white">{stats.rate}%</span>
                                                                </div>
                                                                <div className="h-1.5 bg-gray-100 dark:bg-slate-700 rounded-full overflow-hidden">
                                                                    <div
                                                                        className={`h-full rounded-full transition-all ${stats.rate >= 80 ? 'bg-green-500' :
                                                                            stats.rate >= 50 ? 'bg-blue-500' :
                                                                                stats.rate >= 30 ? 'bg-yellow-500' : 'bg-red-400'
                                                                            }`}
                                                                        style={{ width: `${stats.rate}%` }}
                                                                    ></div>
                                                                </div>
                                                                <div className="text-[10px] text-gray-400 mt-0.5">
                                                                    {stats.done}/{stats.total} {t('tasks')}
                                                                    {stats.habits > 0 && <span className="ml-2">â€¢ {stats.habits} {t('habits')}</span>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}

                                                {Object.keys(calculations.categoryStats || {}).filter(k => calculations.categoryStats[k].total > 0).length === 0 && (
                                                    <div className="text-center text-gray-400 text-xs py-6">
                                                        <Icon name="Package" size={24} className="mx-auto mb-2 opacity-30" />
                                                        {t('no_data')}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Quick Stats Card */}
                                        <div className="bg-white dark:bg-dark-card p-5 rounded-2xl border border-gray-100 dark:border-dark-border shadow-sm">
                                            <div className="flex items-center gap-2 mb-4">
                                                <div className="bg-gradient-to-br from-emerald-500 to-teal-600 p-2 rounded-xl text-white">
                                                    <Icon name="Zap" size={18} />
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-slate-700 dark:text-white text-sm">{t('quick_stats') || 'HÄ±zlÄ± Ã–zet'}</h4>
                                                    <span className="text-[10px] text-gray-400">{calculations.categoryPeriodLabel}</span>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-2 gap-3">
                                                <div className="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-3 text-center">
                                                    <div className="text-2xl font-bold text-blue-600 dark:text-blue-400">{calculations.categoryTotals?.total || 0}</div>
                                                    <div className="text-[10px] text-gray-500 font-bold uppercase">{t('tasks')}</div>
                                                </div>
                                                <div className="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl p-3 text-center">
                                                    <div className="text-2xl font-bold text-green-600 dark:text-green-400">{calculations.overallCategoryRate || 0}%</div>
                                                    <div className="text-[10px] text-gray-500 font-bold uppercase">{t('efficiency')}</div>
                                                </div>
                                                <div className="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/20 rounded-xl p-3 text-center">
                                                    <div className="text-2xl font-bold text-purple-600 dark:text-purple-400">{calculations.activeCategoryCount || 0}</div>
                                                    <div className="text-[10px] text-gray-500 font-bold uppercase">{t('active_categories')}</div>
                                                </div>
                                                <div className="bg-gradient-to-br from-orange-50 to-amber-50 dark:from-orange-900/20 dark:to-amber-900/20 rounded-xl p-3 text-center">
                                                    <div className="text-2xl font-bold text-orange-600 dark:text-orange-400">{calculations.categoryTotals?.overdue || 0}</div>
                                                    <div className="text-[10px] text-gray-500 font-bold uppercase">{t('overdue_tasks')}</div>
                                                </div>
                                            </div>

                                            {/* Best & Worst */}
                                            {(calculations.bestCategoryStat?.name !== '-' || calculations.worstCategoryStat?.name !== '-') && (
                                                <div className="mt-4 pt-4 border-t border-gray-100 dark:border-slate-700 space-y-2">
                                                    {calculations.bestCategoryStat?.name !== '-' && (
                                                        <div className="flex items-center gap-2 text-xs">
                                                            <span className="text-green-500">ğŸ†</span>
                                                            <span className="text-gray-500">{t('most_productive')}:</span>
                                                            <span className={`${getCategoryColor(calculations.bestCategoryStat.name)} px-1.5 py-0.5 rounded text-[10px] font-bold`}>
                                                                {translateCategory(calculations.bestCategoryStat.name)}
                                                            </span>
                                                            <span className="text-green-600 font-bold">{calculations.bestCategoryStat.rate}%</span>
                                                        </div>
                                                    )}
                                                    {calculations.worstCategoryStat?.name !== '-' && (
                                                        <div className="flex items-center gap-2 text-xs">
                                                            <span className="text-amber-500">âš ï¸</span>
                                                            <span className="text-gray-500">{t('needs_work') || 'GeliÅŸtirilmeli'}:</span>
                                                            <span className={`${getCategoryColor(calculations.worstCategoryStat.name)} px-1.5 py-0.5 rounded text-[10px] font-bold`}>
                                                                {translateCategory(calculations.worstCategoryStat.name)}
                                                            </span>
                                                            <span className="text-amber-600 font-bold">{calculations.worstCategoryStat.rate}%</span>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Main Charts Area */}
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <div className="lg:col-span-2 bg-white dark:bg-dark-card p-6 rounded-3xl border border-gray-100 dark:border-dark-border shadow-sm flex flex-col justify-between min-h-[300px]">
                                            <div className="flex items-center gap-2 mb-6"><div className="bg-indigo-50 dark:bg-indigo-900/30 p-2 rounded-lg text-indigo-600 dark:text-indigo-400"><Icon name="BarChart3" size={20} /></div><h3 className="font-bold text-slate-700 dark:text-white text-lg">{t('weekly_gain')}</h3></div>
                                            <WeeklyBarChart data={calculations.weeklyScores} />
                                        </div>
                                        <div className="bg-white dark:bg-dark-card p-6 rounded-3xl border border-gray-100 dark:border-dark-border shadow-sm min-h-[300px]">
                                            <div className="flex items-center gap-2 mb-6"><div className="bg-purple-50 dark:bg-purple-900/30 p-2 rounded-lg text-purple-600 dark:text-purple-400"><Icon name="PieChart" size={20} /></div><h3 className="font-bold text-slate-700 dark:text-white text-lg">{t('cat_activity')}</h3></div>
                                            <SimplePieChart data={calculations.pieData} />
                                        </div>
                                    </div>

                                    {/* History Analysis - Simple Score Cards */}
                                    <div className="bg-white dark:bg-dark-card p-6 rounded-3xl border border-gray-100 dark:border-dark-border shadow-sm">
                                        <div className="flex items-center gap-2 mb-6">
                                            <div className="bg-gradient-to-br from-blue-500 to-indigo-600 p-2.5 rounded-xl text-white">
                                                <Icon name="TrendingUp" size={20} />
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-gray-700 dark:text-white text-lg">{t('analysis')}</h3>
                                                <p className="text-[10px] text-gray-400">{t('score_breakdown') || 'DÃ¶nemsel puan daÄŸÄ±lÄ±mÄ±'}</p>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
                                            {/* Today */}
                                            <div className="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 p-4 rounded-2xl border border-green-100 dark:border-green-800/30 text-center">
                                                <div className="text-[10px] font-bold text-green-600 dark:text-green-400 uppercase tracking-wider mb-1">{t('today')}</div>
                                                <div className="text-2xl sm:text-3xl font-black text-green-700 dark:text-green-300">{calculations.scoreToday}</div>
                                                <div className="text-[10px] text-green-500 dark:text-green-400 mt-1">XP</div>
                                            </div>

                                            {/* This Week */}
                                            <div className="bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 p-4 rounded-2xl border border-blue-100 dark:border-blue-800/30 text-center">
                                                <div className="text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider mb-1">{t('this_week') || 'Bu Hafta'}</div>
                                                <div className="text-2xl sm:text-3xl font-black text-blue-700 dark:text-blue-300">{calculations.scoreThisWeek}</div>
                                                <div className="text-[10px] text-blue-500 dark:text-blue-400 mt-1">XP</div>
                                            </div>

                                            {/* This Month */}
                                            <div className="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/20 p-4 rounded-2xl border border-purple-100 dark:border-purple-800/30 text-center">
                                                <div className="text-[10px] font-bold text-purple-600 dark:text-purple-400 uppercase tracking-wider mb-1">{t('this_month') || 'Bu Ay'}</div>
                                                <div className="text-2xl sm:text-3xl font-black text-purple-700 dark:text-purple-300">{calculations.scoreThisMonth}</div>
                                                <div className="text-[10px] text-purple-500 dark:text-purple-400 mt-1">XP</div>
                                            </div>

                                            {/* This Year */}
                                            <div className="bg-gradient-to-br from-orange-50 to-amber-50 dark:from-orange-900/20 dark:to-amber-900/20 p-4 rounded-2xl border border-orange-100 dark:border-orange-800/30 text-center">
                                                <div className="text-[10px] font-bold text-orange-600 dark:text-orange-400 uppercase tracking-wider mb-1">{t('this_year') || 'Bu YÄ±l'}</div>
                                                <div className="text-2xl sm:text-3xl font-black text-orange-700 dark:text-orange-300">{calculations.scoreThisYear}</div>
                                                <div className="text-[10px] text-orange-500 dark:text-orange-400 mt-1">XP</div>
                                            </div>

                                            {/* All Time */}
                                            <div className="bg-gradient-to-br from-slate-100 to-gray-100 dark:from-slate-800 dark:to-slate-700 p-4 rounded-2xl border border-slate-200 dark:border-slate-600 text-center col-span-2 sm:col-span-1">
                                                <div className="text-[10px] font-bold text-slate-600 dark:text-slate-300 uppercase tracking-wider mb-1">{t('all_time')}</div>
                                                <div className="text-2xl sm:text-3xl font-black text-slate-800 dark:text-white">{calculations.scoreAllTime}</div>
                                                <div className="text-[10px] text-slate-500 dark:text-slate-400 mt-1">XP</div>
                                            </div>
                                        </div>

                                        {/* Daily Average Info */}
                                        <div className="mt-4 pt-4 border-t border-gray-100 dark:border-slate-700 flex flex-wrap justify-center gap-4 text-xs text-gray-500 dark:text-slate-400">
                                            <div className="flex items-center gap-1">
                                                <Icon name="TrendingUp" size={12} className="text-green-500" />
                                                <span>{t('avg_per_day') || 'GÃ¼nlÃ¼k Ort.'}: <strong className="text-slate-700 dark:text-white">{calculations.scoreThisWeek > 0 ? Math.round(calculations.scoreThisWeek / 7) : 0} XP</strong></span>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <Icon name="Calendar" size={12} className="text-blue-500" />
                                                <span>{t('days_active') || 'Aktif GÃ¼n'}: <strong className="text-slate-700 dark:text-white">{calculations.chainMarkedCount}</strong></span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Excuse History - Enhanced */}
                                    <div className="bg-gradient-to-br from-orange-50 to-amber-50 dark:from-slate-800 dark:to-slate-900 p-6 rounded-3xl border border-orange-100 dark:border-dark-border shadow-sm">
                                        <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-5">
                                            <div className="flex items-center gap-3">
                                                <div className="bg-gradient-to-br from-orange-400 to-amber-500 p-3 rounded-2xl text-white shadow-lg">
                                                    <Icon name="MessageCircle" size={24} />
                                                </div>
                                                <div>
                                                    <h3 className="font-bold text-gray-800 dark:text-white text-lg">{t('excuse_history') || 'Bahane GeÃ§miÅŸi'}</h3>
                                                    <p className="text-xs text-gray-500 dark:text-slate-400">{t('all_excuses_desc') || 'TÃ¼m bahaneleriniz burada'}</p>
                                                </div>
                                            </div>
                                            {/* Filter Tabs */}
                                            <div className="flex items-center gap-1 bg-white/80 dark:bg-slate-800 p-1 rounded-xl">
                                                {[
                                                    { id: 'all', label: t('all') || 'TÃ¼mÃ¼', icon: 'List' },
                                                    { id: 'habit', label: t('habits'), icon: 'Repeat' },
                                                    { id: 'task', label: t('tasks'), icon: 'CheckSquare' },
                                                    { id: 'chain', label: t('chain'), icon: 'Link2' }
                                                ].map(f => (
                                                    <button
                                                        key={f.id}
                                                        onClick={() => setExcuseCategory(f.id)}
                                                        className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1 ${excuseCategory === f.id
                                                            ? 'bg-orange-500 text-white shadow'
                                                            : 'text-gray-500 dark:text-slate-400 hover:bg-orange-100 dark:hover:bg-slate-700'
                                                            }`}
                                                    >
                                                        <Icon name={f.icon} size={12} />
                                                        <span className="hidden sm:inline">{f.label}</span>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                                            {(() => {
                                                const allExcuses = [];

                                                // Collect habit excuses (from both legacy habitExcuses and new excuses.habits)
                                                const habitExcuseData = { ...habitExcuses, ...(excuses.habits || {}) };
                                                Object.keys(habitExcuseData).forEach(hId => {
                                                    const h = habits.find(hb => hb.id.toString() === hId.toString());
                                                    if (!h) return;
                                                    Object.entries(habitExcuseData[hId]).forEach(([dKey, text]) => {
                                                        allExcuses.push({
                                                            type: 'habit',
                                                            date: dKey,
                                                            title: h.title,
                                                            category: h.category,
                                                            text: text,
                                                            timestamp: new Date(dKey).getTime(),
                                                            icon: 'Repeat',
                                                            color: 'emerald'
                                                        });
                                                    });
                                                });

                                                // Collect task excuses
                                                Object.entries(excuses.tasks || {}).forEach(([taskId, text]) => {
                                                    // Find task in any column
                                                    let task = null;
                                                    ['todo', 'inProgress', 'done'].forEach(col => {
                                                        const found = columns[col]?.items.find(t => t.id.toString() === taskId.toString());
                                                        if (found) task = found;
                                                    });
                                                    if (task) {
                                                        allExcuses.push({
                                                            type: 'task',
                                                            date: task.date || getDateKey(new Date()),
                                                            title: task.title,
                                                            category: task.tag,
                                                            text: text,
                                                            timestamp: new Date(task.date || new Date()).getTime(),
                                                            icon: 'CheckSquare',
                                                            color: 'blue'
                                                        });
                                                    }
                                                });

                                                // Collect chain excuses
                                                Object.entries(excuses.chain || {}).forEach(([dateKey, text]) => {
                                                    allExcuses.push({
                                                        type: 'chain',
                                                        date: dateKey,
                                                        title: chainTarget || t('chain'),
                                                        category: null,
                                                        text: text,
                                                        timestamp: new Date(dateKey).getTime(),
                                                        icon: 'Link2',
                                                        color: 'orange'
                                                    });
                                                });

                                                // Filter by category
                                                const filtered = excuseCategory === 'all'
                                                    ? allExcuses
                                                    : allExcuses.filter(e => e.type === excuseCategory);

                                                // Sort by date descending
                                                filtered.sort((a, b) => b.timestamp - a.timestamp);

                                                // Stats
                                                const stats = {
                                                    total: allExcuses.length,
                                                    habits: allExcuses.filter(e => e.type === 'habit').length,
                                                    tasks: allExcuses.filter(e => e.type === 'task').length,
                                                    chain: allExcuses.filter(e => e.type === 'chain').length
                                                };

                                                if (filtered.length === 0) {
                                                    return (
                                                        <div className="text-center py-12">
                                                            <div className="text-6xl mb-4">ğŸ‰</div>
                                                            <div className="text-lg font-bold text-gray-600 dark:text-slate-300">{t('no_excuses_title') || 'Bahane yok!'}</div>
                                                            <div className="text-sm text-gray-400 dark:text-slate-500 mt-1">{t('no_excuses_desc') || 'Tebrikler, hiÃ§ bahane Ã¼retmemiÅŸsin!'}</div>
                                                        </div>
                                                    );
                                                }

                                                return (
                                                    <>
                                                        {/* Summary Stats */}
                                                        <div className="grid grid-cols-4 gap-2 mb-4">
                                                            <div className="bg-white/80 dark:bg-slate-800 rounded-xl p-3 text-center">
                                                                <div className="text-2xl font-bold text-gray-700 dark:text-white">{stats.total}</div>
                                                                <div className="text-[10px] text-gray-500 uppercase font-bold">{t('total') || 'Toplam'}</div>
                                                            </div>
                                                            <div className="bg-emerald-50 dark:bg-emerald-900/20 rounded-xl p-3 text-center">
                                                                <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">{stats.habits}</div>
                                                                <div className="text-[10px] text-emerald-600/70 uppercase font-bold">{t('habits')}</div>
                                                            </div>
                                                            <div className="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-3 text-center">
                                                                <div className="text-2xl font-bold text-blue-600 dark:text-blue-400">{stats.tasks}</div>
                                                                <div className="text-[10px] text-blue-600/70 uppercase font-bold">{t('tasks')}</div>
                                                            </div>
                                                            <div className="bg-orange-50 dark:bg-orange-900/20 rounded-xl p-3 text-center">
                                                                <div className="text-2xl font-bold text-orange-600 dark:text-orange-400">{stats.chain}</div>
                                                                <div className="text-[10px] text-orange-600/70 uppercase font-bold">{t('chain')}</div>
                                                            </div>
                                                        </div>

                                                        {/* Excuse List */}
                                                        {filtered.map((exc, i) => {
                                                            const colorClasses = {
                                                                emerald: 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 border-emerald-200 dark:border-emerald-800',
                                                                blue: 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800',
                                                                orange: 'bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 border-orange-200 dark:border-orange-800'
                                                            };
                                                            return (
                                                                <div key={i} className="bg-white dark:bg-slate-800 rounded-2xl p-4 border border-gray-100 dark:border-slate-700 hover:shadow-md transition-shadow">
                                                                    <div className="flex gap-3">
                                                                        <div className={`shrink-0 w-10 h-10 rounded-xl flex items-center justify-center ${colorClasses[exc.color]}`}>
                                                                            <Icon name={exc.icon} size={18} />
                                                                        </div>
                                                                        <div className="flex-1 min-w-0">
                                                                            <div className="flex items-start justify-between gap-2">
                                                                                <div>
                                                                                    <div className="font-bold text-slate-800 dark:text-white text-sm truncate">{exc.title}</div>
                                                                                    <div className="flex items-center gap-2 mt-0.5">
                                                                                        <span className="text-[10px] text-gray-400">{formatDate(exc.date)}</span>
                                                                                        {exc.category && (
                                                                                            <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${getCategoryColor(exc.category)}`}>
                                                                                                {translateCategory(exc.category)}
                                                                                            </span>
                                                                                        )}
                                                                                    </div>
                                                                                </div>
                                                                                <button
                                                                                    onClick={() => openExcuseModal(exc.type, exc.type === 'chain' ? null : (habits.find(h => h.title === exc.title)?.id || exc.title), exc.date, exc.title, formatDate(exc.date))}
                                                                                    className="text-gray-400 hover:text-orange-500 p-1"
                                                                                    title={t('edit')}
                                                                                >
                                                                                    <Icon name="Edit2" size={14} />
                                                                                </button>
                                                                            </div>
                                                                            <div className="mt-2 text-sm text-slate-600 dark:text-slate-300 bg-gray-50 dark:bg-slate-900 p-3 rounded-xl italic">
                                                                                "{exc.text}"
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'pomodoro' && (
                                <Pomodoro
                                    history={pomodoroHistory}
                                    onSessionComplete={handlePomodoroComplete}
                                    t={t}
                                    timeLeft={pomoSeconds}
                                    isActive={pomoActive}
                                    mode={pomoMode}
                                    toggleTimer={togglePomoTimer}
                                    resetTimer={resetPomoTimer}
                                    workDur={workDur}
                                    setWorkDur={setWorkDur}
                                    breakDur={breakDur}
                                    setBreakDur={setBreakDur}
                                    setMode={setPomoMode}
                                    setTimeLeft={setPomoSeconds}
                                    setIsActive={setPomoActive}
                                    alarmType={alarmType}
                                    setAlarmType={setAlarmType}
                                />
                            )}

                            {activeTab === 'leaderboard' && (
                                <LeaderboardView
                                    user={user}
                                    fbRef={fbRef}
                                    t={t}
                                    lang={lang}
                                    leaderboardUser={leaderboardUser}
                                    onJoinClick={() => setShowProfileModal(true)}
                                />
                            )}
                        </div>



                        <footer className="mt-8 mb-4 text-center p-4 border-t dark:border-white/10 text-gray-400 dark:text-slate-600 text-xs pb-28 md:pb-4">
                            <p className="flex items-center justify-center gap-2"><Icon name="Lock" size={12} /> {t('footer_security')}</p>
                            <p className="opacity-50 mt-1">Iradah &copy; 2026</p>
                        </footer>

                        {/* Mobile Bottom Navigation - Improved for all screen sizes */}
                        <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl border-t border-gray-200 dark:border-slate-700 shadow-lg shadow-black/5 z-50" style={{paddingBottom: 'max(0.5rem, env(safe-area-inset-bottom))'}}>
                            <div className="flex justify-around items-center px-1 py-1.5">
                                {['board', 'habits', 'chain', 'pomodoro', 'stats', 'leaderboard']
                                    .filter(tab => tab !== 'leaderboard' || leaderboardUser?.joinedAt)
                                    .map(tab => (
                                        <button 
                                            key={tab} 
                                            onClick={() => setActiveTab(tab)} 
                                            className={`flex flex-col items-center gap-0.5 py-1.5 px-2 sm:px-3 rounded-xl transition-all min-w-0 ${
                                                activeTab === tab 
                                                    ? 'text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/30' 
                                                    : 'text-gray-400 dark:text-slate-500 active:bg-gray-100 dark:active:bg-slate-800'
                                            }`}
                                        >
                                            <Icon name={{ board: 'Kanban', habits: 'Repeat', chain: 'Link2', stats: 'BarChart3', pomodoro: 'Timer', leaderboard: 'Trophy' }[tab]} size={20} className={activeTab === tab ? 'scale-110' : ''} />
                                            <span className={`text-[9px] sm:text-[10px] font-bold truncate max-w-[3rem] sm:max-w-none ${activeTab === tab ? 'text-purple-600 dark:text-purple-400' : ''}`}>
                                                {t(tab)}
                                            </span>
                                        </button>
                                    ))}
                            </div>
                        </div>
                    </ErrorBoundary >
                </div >
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<IradahApp />);
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Use relative path for GitHub Pages compatibility
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('âœ… [PWA] Service Worker registered:', registration.scope);

                        // Check for updates every 5 minutes
                        setInterval(() => {
                            registration.update();
                        }, 300000);
                    })
                    .catch((error) => {
                        console.error('âŒ [PWA] Service Worker registration failed:', error);
                    });
            });

            // Listen for SW updates
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('ğŸ”„ [PWA] Service Worker updated');
                // Don't auto-reload to avoid data loss
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        let installButton = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('ğŸ’¡ [PWA] Install prompt available');

            // Show install button
            showInstallButton();
        });

        function showInstallButton() {
            if (installButton) return; // Already shown

            // Create install button
            installButton = document.createElement('button');
            installButton.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <span class="font-bold">Ana Ekrana Ekle</span>
            `;
            installButton.className = 'fixed bottom-20 right-4 md:bottom-4 bg-blue-600 text-white px-4 py-3 rounded-full shadow-lg hover:bg-blue-700 transition-all flex items-center gap-2 z-50 animate-bounce';
            installButton.onclick = installPWA;

            document.body.appendChild(installButton);

            // Auto-hide after 30 seconds
            setTimeout(() => {
                if (installButton) {
                    installButton.style.animation = 'none';
                }
            }, 30000);
        }

        async function installPWA() {
            if (!deferredPrompt) return;

            // Show install prompt
            deferredPrompt.prompt();

            // Wait for user choice
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`[PWA] User ${outcome === 'accepted' ? 'accepted' : 'dismissed'} install`);

            // Clear prompt
            deferredPrompt = null;

            // Remove button
            if (installButton) {
                installButton.remove();
                installButton = null;
            }
        }

        // Track installation
        window.addEventListener('appinstalled', () => {
            console.log('ğŸ‰ [PWA] App installed successfully!');
            if (installButton) {
                installButton.remove();
                installButton = null;
            }
        });
    </script>
    <!-- Cache Buster: Fix Habit Stat Double Else Error - v2 -->
</body>

</html>